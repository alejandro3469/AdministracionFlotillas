function handleProductActionButtonsClick(n){var i=n.target.closest(".btn-ver-producto, .btn-editar-producto"),t;i&&(t=i.getAttribute("data-id-producto"),t&&t!=="undefined"&&t!=="null"?(t=parseInt(t,10),t&&!isNaN(t)&&t>0?i.classList.contains("btn-ver-producto")?window.Products&&window.Products.Modal?window.Products.Modal.Abrir(t,"ver"):console.error("Products.Modal no está disponible"):i.classList.contains("btn-editar-producto")&&(window.Products&&window.Products.Modal?window.Products.Modal.Abrir(t,"editar"):console.error("Products.Modal no está disponible")):console.error("ID de producto no válido:",t)):console.error("No se pudo obtener ID de producto del botón. data-id-producto:",t))}window.productsGridCreated=function(){console.log("Grid de productos creado, cargando datos...");window.Products&&window.Products.Grid&&window.Products.Grid.CargarDatos()};window.productsGridRowSelected=function(n){console.log("Producto seleccionado:",n.data)};window.productsGridActionComplete=function(n){n.requestType==="filtering"&&window.Products&&window.Products.Dashboard&&window.Products.Dashboard.ActualizarMetricas()};window.productsGridDataBound=function(){var n=document.getElementById("productsGrid");n&&(n.removeEventListener("click",handleProductActionButtonsClick),n.addEventListener("click",handleProductActionButtonsClick))};window.productsGridToolbarClick=function(n){var t=document.getElementById("productsGrid"),r,i,u;if(!t||!t.ej2_instances||!t.ej2_instances[0]){console.warn("Grid no encontrado para exportación");return}if(r=t.ej2_instances[0],u="Productos_"+(new Date).toISOString().split("T")[0],n.item.text==="Excel Export"||n.item.id&&n.item.id.includes("excelexport"))i=r.excelExport({fileName:u+".xlsx"});else if(n.item.text==="Pdf Export"||n.item.id&&n.item.id.includes("pdfexport"))i=r.pdfExport({fileName:u+".pdf"});else return;i&&i.then(function(){window.Products.Utilidades.MostrarExito("Exportación Exitosa","El archivo se ha descargado correctamente.")}).catch(function(n){window.Products.Utilidades.MostrarError("Error de Exportación","No se pudo exportar. Por favor, intenta nuevamente.");console.error("Error al exportar:",n)})};window.filtroCategoriaChange=window.debounce(function(){window.Products&&window.Products.Filtros&&window.Products.Filtros.Aplicar()},300);window.filtroEstadoChange=window.debounce(function(){window.Products&&window.Products.Filtros&&window.Products.Filtros.Aplicar()},300);window.filtroPrecioMinChange=window.debounce(function(){window.Products&&window.Products.Filtros&&window.Products.Filtros.Aplicar()},300);window.filtroPrecioMaxChange=window.debounce(function(){window.Products&&window.Products.Filtros&&window.Products.Filtros.Aplicar()},300);window.Products=window.Products||{};var modalProductoId=null,modalProductoModo="ver";(function(){"use strict";window.Products.Utilidades={MostrarError:function(n,t){return new Promise(i=>{typeof Swal!="undefined"?Swal.fire({icon:"error",title:n||"Error",text:t||"Ha ocurrido un error.",confirmButtonText:"Aceptar"}).then(()=>i()):(alert(n+": "+t),i())})},MostrarExito:function(n,t){return new Promise(i=>{typeof Swal!="undefined"?Swal.fire({icon:"success",title:n||"Éxito",text:t||"Operación completada.",confirmButtonText:"Aceptar",timer:2e3,showConfirmButton:!1}).then(()=>i()):(alert(n+": "+t),i())})}};window.Products.Grid={CargarDatos:function(){var i=document.getElementById("productsGrid"),t,n;if(!i){console.warn("Grid element no encontrado");return}if(t=i.ej2_instances&&i.ej2_instances[0],!t){setTimeout(function(){window.Products.Grid.CargarDatos()},500);return}n=new XMLHttpRequest;n.open("POST","/Products/ObtenerProducts",!0);n.setRequestHeader("Content-Type","application/json");n.onreadystatechange=function(){if(n.readyState===4)if(n.status===200)try{var i=JSON.parse(n.responseText);i.exito&&i.datos?(t.dataSource=i.datos,t.refresh(),console.log("Productos cargados:",i.datos.length)):window.Products.Utilidades.MostrarError("Error al cargar datos",i.mensaje||"No se pudieron cargar los productos.")}catch(r){window.Products.Utilidades.MostrarError("Error","Error al procesar la respuesta del servidor.");console.error("Error al parsear respuesta:",r)}else window.Products.Utilidades.MostrarError("Error de Conexión","Error al conectar con el servidor."),console.error("Error al cargar productos:",n.status,n.statusText)};n.send()},Recargar:function(){this.CargarDatos()}};window.Products.Filtros={Aplicar:function(){var u=document.getElementById("productsGrid"),t,i,r,f,n;if(u&&(t=u.ej2_instances&&u.ej2_instances[0],t)){if(i=this.ObtenerPrecioMin(),r=this.ObtenerPrecioMax(),i&&r&&i>r){window.Products.Utilidades.MostrarError("Error de Validación","El precio mínimo no puede ser mayor al precio máximo.");return}f={Categoria:this.ObtenerCategoria(),Estado:this.ObtenerEstado(),PrecioMinimo:i,PrecioMaximo:r};n=new XMLHttpRequest;n.open("POST","/Products/BuscarProducts",!0);n.setRequestHeader("Content-Type","application/json");n.onreadystatechange=function(){if(n.readyState===4)if(n.status===200)try{var i=JSON.parse(n.responseText);i.exito?(t.dataSource=i.datos,t.refresh()):window.Products.Utilidades.MostrarError("Error al aplicar filtros",i.mensaje||"No se pudieron aplicar los filtros.")}catch(r){window.Products.Utilidades.MostrarError("Error","Error al procesar la respuesta del servidor.");console.error("Error al parsear respuesta:",r)}else window.Products.Utilidades.MostrarError("Error de Conexión","Error al conectar con el servidor."),console.error("Error al aplicar filtros:",n.status,n.statusText)};n.send(JSON.stringify(f))}},Limpiar:function(){var r=document.getElementById("filtroCategoria"),n,t,i;r&&r.ej2_instances&&r.ej2_instances[0]&&(r.ej2_instances[0].value=null);n=document.getElementById("filtroEstado");n&&n.ej2_instances&&n.ej2_instances[0]&&(n.ej2_instances[0].value=null);t=document.getElementById("filtroPrecioMin");t&&t.ej2_instances&&t.ej2_instances[0]&&(t.ej2_instances[0].value=null);i=document.getElementById("filtroPrecioMax");i&&i.ej2_instances&&i.ej2_instances[0]&&(i.ej2_instances[0].value=null);window.Products&&window.Products.Grid&&window.Products.Grid.CargarDatos()},ObtenerCategoria:function(){var n=document.getElementById("filtroCategoria");return!n||!n.ej2_instances?null:n.ej2_instances[0]?n.ej2_instances[0].value:null},ObtenerEstado:function(){var n=document.getElementById("filtroEstado");return!n||!n.ej2_instances?null:n.ej2_instances[0]?n.ej2_instances[0].value:null},ObtenerPrecioMin:function(){var n=document.getElementById("filtroPrecioMin");return!n||!n.ej2_instances?null:n.ej2_instances[0]?n.ej2_instances[0].value:null},ObtenerPrecioMax:function(){var n=document.getElementById("filtroPrecioMax");return!n||!n.ej2_instances?null:n.ej2_instances[0]?n.ej2_instances[0].value:null}};window.Products.Dashboard={ActualizarMetricas:function(){var n=new XMLHttpRequest;n.open("POST","/Products/ObtenerMetricas",!0);n.setRequestHeader("Content-Type","application/json");n.onreadystatechange=function(){var i,t,r,u;if(n.readyState===4)if(n.status===200)try{if(i=JSON.parse(n.responseText),i.exito&&i.datos){t=i.datos;r=t.totalProductos||0;function n(n,t){var i=document.getElementById(n);i&&(i.textContent=t)}n("totalProductos",r);n("productosActivos",t.productosActivos||0);n("stockBajo",t.stockBajo||0);n("valorInventario","$"+parseFloat(t.valorInventario||0).toFixed(2));u=document.querySelector('[id^="breadcrumb-contador-"]');u&&(u.textContent=r.toString())}}catch(f){console.error("Error al parsear métricas:",f)}else console.error("Error al actualizar métricas de productos:",n.status,n.statusText)};n.send()}};window.Products.Modal={Abrir:function(n,t){var i=parseInt(n,10);if(!i||isNaN(i)||i<=0){window.Products.Utilidades.MostrarError("Error","ID de producto no válido.");return}modalProductoId=i;modalProductoModo=t||"ver";this.CargarDatosProducto(i)},CargarDatosProducto:function(n){var i=this,t=new XMLHttpRequest;t.open("POST","/Products/ObtenerProductPorId",!0);t.setRequestHeader("Content-Type","application/json");t.onreadystatechange=function(){if(t.readyState===4)if(t.status===200)try{var n=JSON.parse(t.responseText);n.exito&&n.datos?(i.MostrarDatos(n.datos),i.AbrirDialog()):window.Products.Utilidades.MostrarError("Error",n.mensaje||"No se pudo cargar el producto.")}catch(r){window.Products.Utilidades.MostrarError("Error","Error al procesar la respuesta del servidor.");console.error("Error al parsear respuesta:",r)}else window.Products.Utilidades.MostrarError("Error de Conexión","Error al cargar el producto."),console.error("Error al cargar producto:",t.status,t.statusText)};t.send(JSON.stringify(n))},MostrarDatos:function(n){function h(n){return document.getElementById(n)}function r(n,t){var i=h(n);i&&(i.textContent=t)}function u(n,t){var i=h(n);i&&(i.innerHTML=t)}var e,i;r("modalProductoTitulo",n.IdProducto);r("modalIdProducto",n.IdProducto);r("modalNombreProducto",n.NombreProducto||"-");r("modalCategoria",n.Categoria||"-");e="";e=n.Estado==="ACTIVE"?'<span class="badge bg-success info-tooltip-producto fs-6 px-3 py-2" data-field="Estado" data-tooltip="Producto activo y disponible para venta"><i class="fas fa-check-circle me-2"><\/i>'+n.Estado+"<\/span>":'<span class="badge bg-secondary info-tooltip-producto fs-6 px-3 py-2" data-field="Estado" data-tooltip="Producto inactivo, no disponible para venta"><i class="fas fa-times-circle me-2"><\/i>'+(n.Estado||"INACTIVE")+"<\/span>";u("modalEstadoProducto",e);this.ActualizarGaugeEstado(n.Estado==="ACTIVE"?100:0);r("modalCodigoBarras",n.CodigoBarras||"-");var c=n.PrecioUnitario||0,l=n.PrecioCosto||0,a=n.MargenGanancia||0;u("modalPrecioUnitario",'<i class="fas fa-dollar-sign me-1"><\/i>$'+c.toFixed(2));u("modalPrecioCosto",'<i class="fas fa-coins me-1"><\/i>$'+l.toFixed(2));u("modalMargenGanancia",'<i class="fas fa-chart-line me-1"><\/i>$'+a.toFixed(2));var t=n.CantidadStock||0,o="",s="",f="";if(t<20?(o='<span class="text-danger fw-bold">'+t+"<\/span>",s="text-danger",f="fas fa-exclamation-triangle"):t<50?(o='<span class="text-warning fw-bold">'+t+"<\/span>",s="text-warning",f="fas fa-exclamation-circle"):(o='<span class="text-success fw-bold">'+t+"<\/span>",s="text-success",f="fas fa-check-circle"),u("modalCantidadStock",'<i class="'+f+' me-1"><\/i>'+t),i=document.getElementById("progressBarStock"),i&&i.ej2_instances&&i.ej2_instances[0]){var v=Math.min(t*1,100),y=t<20?"#dc3545":t<50?"#ffc107":"#28a745";i.ej2_instances[0].value=v;i.ej2_instances[0].progressColor=y;i.ej2_instances[0].dataBind()}r("modalDescripcion",n.Descripcion||"-");setTimeout(function(){window.Products.Modal.ActualizarGraficaPrecios(n)},300)},AbrirDialog:function(){function t(){r._abriendoModal=!1}function e(){var n,i,u,r,f,t;if(typeof modalProductoInstance!="undefined"&&window.modalProductoInstance!==null)return window.modalProductoInstance;if(n=document.getElementById("modalProducto"),n){if(n.ej2_instances&&n.ej2_instances[0]&&(i=n.ej2_instances[0],i&&typeof i.show=="function"))return window.modalProductoInstance=i,i;if(n.ej2_instances&&n.ej2_instances.length>0)for(u=0;u<n.ej2_instances.length;u++)if(t=n.ej2_instances[u],t&&typeof t.show=="function")return window.modalProductoInstance=t,t;try{if(typeof ej!="undefined"&&ej.base&&typeof ej.base.getComponent=="function"&&(r=ej.base.getComponent(n,"dialog"),r&&typeof r.show=="function"))return window.modalProductoInstance=r,r}catch(e){}if(n.ej2_instances)for(f in n.ej2_instances)if(n.ej2_instances.hasOwnProperty(f)&&(t=n.ej2_instances[f],t&&typeof t.show=="function"))return window.modalProductoInstance=t,t}return null}function u(){n++;var r=e();if(r)try{r.show();console.log("✅ Modal abierto correctamente después de "+n+" intentos");window.modalProductoInstance=r;setTimeout(function(){var n=document.getElementById("tooltipModalProducto");n&&n.ej2_instances&&n.ej2_instances[0]&&typeof tooltipModalProductoObj!="undefined"&&(tooltipModalProductoObj=n.ej2_instances[0]);t()},100);return}catch(o){console.error("❌ Error al abrir modal:",o);window.Products.Utilidades.MostrarError("Error","No se pudo abrir el modal: "+o.message);t();return}n<i?(n%10==0&&console.log("⏳ Esperando inicialización del modal... Intento "+n+"/"+i),setTimeout(u,f)):(console.error("❌ Modal no inicializado después de "+i+" intentos"),window.Products.Utilidades.MostrarError("Error","El modal no está disponible. Por favor, recarga la página."),t())}var r;if(this._abriendoModal){console.log("⏳ Modal ya se está abriendo, esperando...");return}if(this._abriendoModal=!0,r=this,typeof mostrarModalProducto=="function"&&window.mostrarModalProducto()){console.log("✅ Modal abierto usando función helper");setTimeout(function(){var n=document.getElementById("tooltipModalProducto");n&&n.ej2_instances&&n.ej2_instances[0]&&typeof tooltipModalProductoObj!="undefined"&&(tooltipModalProductoObj=n.ej2_instances[0]);t()},100);return}var n=0,i=50,f=100;u()},CambiarAModoEdicion:function(n){if(!n||n<=0){window.Products.Utilidades.MostrarError("Error","ID de producto no válido.");return}modalProductoId=n;modalProductoModo="editar";this.ActivarModoEdicion()},ActivarModoEdicion:function(){this.ConvertirCamposAEditables();this.ActualizarBotonesModal();var n=document.getElementById("modalProductoTitulo");n&&(n.textContent=modalProductoId+" (Editando)")},DesactivarModoEdicion:function(){this.ConvertirCamposASoloLectura();this.RestaurarBotonesModal();var n=document.getElementById("modalProductoTitulo");n&&(n.textContent=modalProductoId);modalProductoModo="ver"},ConvertirCamposAEditables:function(){var r=document.getElementById("modalEstadoProducto"),u,n,f,t,i,o;if(r&&(u=r.textContent.trim(),r.innerHTML='<select id="editEstadoProducto" class="form-select form-select-sm"><option value="ACTIVE"'+(u==="ACTIVE"?" selected":"")+'>ACTIVE<\/option><option value="INACTIVE"'+(u==="INACTIVE"?" selected":"")+">INACTIVE<\/option><\/select>"),n=document.getElementById("modalPrecioUnitario"),n&&(f=n.textContent.replace("$","").replace(",","").trim(),n.innerHTML='<input type="number" id="editPrecioUnitario" class="form-control form-control-sm" step="0.01" min="0" value="'+f+'">'),t=document.getElementById("modalCantidadStock"),t){var s=t.textContent.trim(),e=s.match(/\d+/),h=e?e[0]:"0";t.innerHTML='<input type="number" id="editCantidadStock" class="form-control form-control-sm" min="0" value="'+h+'">'}i=document.getElementById("modalCategoria");i&&(o=i.textContent.trim(),i.innerHTML='<input type="text" id="editCategoria" class="form-control form-control-sm" value="'+o+'">')},ConvertirCamposASoloLectura:function(){var l=document.getElementById("modalEstadoProducto"),i,t,r,u,f,a,e,o,n,s,h,c;l&&(i=document.getElementById("editEstadoProducto"),i&&(t=i.value,r="",r=t==="ACTIVE"?'<span class="badge bg-success info-tooltip-producto" data-field="Estado" data-tooltip="Producto activo y disponible para venta">'+t+"<\/span>":'<span class="badge bg-secondary info-tooltip-producto" data-field="Estado" data-tooltip="Producto inactivo, no disponible para venta">'+t+"<\/span>",l.innerHTML=r));u=document.getElementById("modalPrecioUnitario");u&&(f=document.getElementById("editPrecioUnitario"),f&&(a=parseFloat(f.value)||0,u.textContent="$"+a.toFixed(2)));e=document.getElementById("modalCantidadStock");e&&(o=document.getElementById("editCantidadStock"),o&&(n=parseInt(o.value)||0,s="",s=n<20?'<span class="text-danger fw-bold">'+n+"<\/span>":n<50?'<span class="text-warning">'+n+"<\/span>":'<span class="text-success">'+n+"<\/span>",e.innerHTML=s));h=document.getElementById("modalCategoria");h&&(c=document.getElementById("editCategoria"),c&&(h.textContent=c.value||"-"))},ActualizarBotonesModal:function(){var i=document.getElementById("btnModalEditar"),r=document.getElementById("btnModalCerrar"),n,t;i&&i.classList.add("d-none");r&&r.classList.add("d-none");n=document.getElementById("btnModalGuardar");t=document.getElementById("btnModalCancelar");n&&n.classList.remove("d-none");t&&t.classList.remove("d-none")},RestaurarBotonesModal:function(){var i=document.getElementById("btnModalGuardar"),r=document.getElementById("btnModalCancelar"),n,t;i&&i.classList.add("d-none");r&&r.classList.add("d-none");n=document.getElementById("btnModalEditar");t=document.getElementById("btnModalCerrar");n&&n.classList.remove("d-none");t&&t.classList.remove("d-none")},GuardarCambios:function(){var o,n;if(!modalProductoId||modalProductoId<=0){window.Products.Utilidades.MostrarError("Error","No hay producto seleccionado para guardar.");return}var r=document.getElementById("editEstadoProducto"),u=document.getElementById("editPrecioUnitario"),f=document.getElementById("editCantidadStock"),e=document.getElementById("editCategoria"),s=r?r.value:null,t=u?parseFloat(u.value):null,i=f?parseInt(f.value):null,h=e?e.value.trim():null;if(t!==null&&t<0){window.Products.Utilidades.MostrarError("Error","El precio unitario no puede ser negativo.");return}if(i!==null&&i<0){window.Products.Utilidades.MostrarError("Error","La cantidad en stock no puede ser negativa.");return}window.ModalButtons.Deshabilitar("modalProducto","#productsGrid .e-gridcontent .e-rowcell .btn");o={IdProducto:modalProductoId,Estado:s,PrecioUnitario:t,CantidadStock:i,Categoria:h};n=new XMLHttpRequest;n.open("POST","/Products/ActualizarProduct",!0);n.setRequestHeader("Content-Type","application/json");n.onreadystatechange=function(){var t,i;if(n.readyState===4)if(n.status===200)try{t=JSON.parse(n.responseText);t.exito?window.Products.Utilidades.MostrarExito("Producto actualizado","Los cambios se guardaron correctamente.").then(function(){window.Products&&window.Products.Modal&&(window.Products.Modal.DesactivarModoEdicion(),window.Products.Modal.CargarDatosProducto(modalProductoId),window.Products&&window.Products.Grid&&window.Products.Grid.Recargar());window.ModalButtons.Habilitar("modalProducto","#productsGrid .e-gridcontent .e-rowcell .btn")}):window.Products.Utilidades.MostrarError("Error al guardar",t.mensaje||"No se pudieron guardar los cambios.").then(function(){window.ModalButtons.Habilitar("modalProducto","#productsGrid .e-gridcontent .e-rowcell .btn")})}catch(r){console.error("Error al parsear respuesta:",r);window.Products.Utilidades.MostrarError("Error","Error al procesar la respuesta del servidor.").then(function(){window.ModalButtons.Habilitar("modalProducto","#productsGrid .e-gridcontent .e-rowcell .btn")})}else i="Error HTTP: "+n.status+" - "+n.statusText,window.Products.Utilidades.MostrarError("Error de Conexión",i).then(function(){window.ModalButtons.Habilitar("modalProducto","#productsGrid .e-gridcontent .e-rowcell .btn")}),console.error("Error al guardar producto:",i)};n.onerror=function(){window.Products.Utilidades.MostrarError("Error de Conexión","No se pudo conectar con el servidor.").then(function(){window.ModalButtons.Habilitar("modalProducto","#productsGrid .e-gridcontent .e-rowcell .btn")})};n.send(JSON.stringify(o))},CancelarEdicion:function(){modalProductoId&&this.CargarDatosProducto(modalProductoId);this.DesactivarModoEdicion()},ActualizarGraficaPrecios:function(n){var t=document.getElementById("chartPrecios"),i;if(t){var r=n.PrecioUnitario||0,u=n.PrecioCosto||0,f=n.MargenGanancia||0;t.ej2_instances&&t.ej2_instances[0]&&t.ej2_instances[0].destroy();i=new ej.charts.Chart({primaryXAxis:{valueType:"Category",title:"Concepto"},primaryYAxis:{title:"Monto ($)",labelFormat:"C2"},series:[{type:"Column",dataSource:[{concepto:"Precio Unitario",valor:r},{concepto:"Precio Costo",valor:u},{concepto:"Margen",valor:f}],xName:"concepto",yName:"valor",name:"Monto",marker:{dataLabel:{visible:!0,position:"Top",format:"C2"}}}],tooltip:{enable:!0,format:"${point.x}: ${point.y}"},legendSettings:{visible:!1},height:"200px",width:"100%"});i.appendTo("#chartPrecios")}},ActualizarGaugeEstado:function(n){var t=document.getElementById("gaugeEstado"),i;t&&(t.ej2_instances&&t.ej2_instances[0]&&t.ej2_instances[0].destroy(),i=new ej.circulargauge.CircularGauge({axes:[{startAngle:200,endAngle:160,minimum:0,maximum:100,radius:"80%",lineStyle:{width:0},labelStyle:{position:"Inside",font:{size:"12px",fontFamily:"Roboto",fontStyle:"Regular"}},majorTicks:{height:10,offset:5},minorTicks:{height:0},pointers:[{value:n,radius:"60%",pointerWidth:8,cap:{radius:7,border:{width:0}},needleTail:{length:"0%"}}],ranges:[{start:0,end:50,startWidth:10,endWidth:10,color:"#dc3545"},{start:50,end:100,startWidth:10,endWidth:10,color:"#28a745"}]}],height:"80px",width:"100%"}),i.appendTo("#gaugeEstado"))}};window.Products.Detalles={Ver:function(n){window.Products.Modal.Abrir(n,"ver")}};window.Products.Edicion={Editar:function(n){window.Products.Modal.Abrir(n,"editar")}}})();