function handleProductActionButtonsClick(n){var i=n.target.closest(".btn-ver-producto, .btn-editar-producto"),t;i&&(t=i.getAttribute("data-id-producto"),t&&t!=="undefined"&&t!=="null"?(t=parseInt(t,10),t&&!isNaN(t)&&t>0?i.classList.contains("btn-ver-producto")?window.Products&&window.Products.Modal?window.Products.Modal.Abrir(t,"ver"):console.error("Products.Modal no está disponible"):i.classList.contains("btn-editar-producto")&&(window.Products&&window.Products.Modal?window.Products.Modal.Abrir(t,"editar"):console.error("Products.Modal no está disponible")):console.error("ID de producto no válido:",t)):console.error("No se pudo obtener ID de producto del botón. data-id-producto:",t))}window.productsGridCreated=function(){console.log("Grid de productos creado, cargando datos...");window.Products&&window.Products.Grid&&window.Products.Grid.CargarDatos()};window.productsGridRowSelected=function(n){console.log("Producto seleccionado:",n.data)};window.productsGridActionComplete=function(n){n.requestType==="filtering"&&window.Products&&window.Products.Dashboard&&window.Products.Dashboard.ActualizarMetricas()};window.productsGridDataBound=function(){var n=document.getElementById("productsGrid");n&&(n.removeEventListener("click",handleProductActionButtonsClick),n.addEventListener("click",handleProductActionButtonsClick))};window.productsGridToolbarClick=function(n){var t=document.getElementById("productsGrid"),r,i,u;if(!t||!t.ej2_instances||!t.ej2_instances[0]){console.warn("Grid no encontrado para exportación");return}if(r=t.ej2_instances[0],u="Productos_"+(new Date).toISOString().split("T")[0],n.item.text==="Excel Export"||n.item.id&&n.item.id.includes("excelexport"))i=r.excelExport({fileName:u+".xlsx"});else if(n.item.text==="Pdf Export"||n.item.id&&n.item.id.includes("pdfexport"))i=r.pdfExport({fileName:u+".pdf"});else return;i&&i.then(function(){window.Products.Utilidades.MostrarExito("Exportación Exitosa","El archivo se ha descargado correctamente.")}).catch(function(n){window.Products.Utilidades.MostrarError("Error de Exportación","No se pudo exportar. Por favor, intenta nuevamente.");console.error("Error al exportar:",n)})};window.filtroCategoriaChange=window.debounce(function(){window.Products&&window.Products.Filtros&&window.Products.Filtros.Aplicar()},300);window.filtroEstadoChange=window.debounce(function(){window.Products&&window.Products.Filtros&&window.Products.Filtros.Aplicar()},300);window.filtroPrecioMinChange=window.debounce(function(){window.Products&&window.Products.Filtros&&window.Products.Filtros.Aplicar()},300);window.filtroPrecioMaxChange=window.debounce(function(){window.Products&&window.Products.Filtros&&window.Products.Filtros.Aplicar()},300);window.Products=window.Products||{};var modalProductoId=null,modalProductoModo="ver";(function(){"use strict";window.Products.Utilidades={MostrarError:function(n,t){typeof Swal!="undefined"?Swal.fire({icon:"error",title:n||"Error",text:t||"Ha ocurrido un error.",confirmButtonText:"Aceptar"}):alert(n+": "+t)},MostrarExito:function(n,t){typeof Swal!="undefined"?Swal.fire({icon:"success",title:n||"Éxito",text:t||"Operación completada.",confirmButtonText:"Aceptar",timer:2e3,showConfirmButton:!1}):alert(n+": "+t)}};window.Products.Grid={CargarDatos:function(){var i=document.getElementById("productsGrid"),t,n;if(!i){console.warn("Grid element no encontrado");return}if(t=i.ej2_instances&&i.ej2_instances[0],!t){setTimeout(function(){window.Products.Grid.CargarDatos()},500);return}n=new XMLHttpRequest;n.open("POST","/Products/ObtenerProducts",!0);n.setRequestHeader("Content-Type","application/json");n.onreadystatechange=function(){if(n.readyState===4)if(n.status===200)try{var i=JSON.parse(n.responseText);i.exito&&i.datos?(t.dataSource=i.datos,t.refresh(),console.log("Productos cargados:",i.datos.length)):window.Products.Utilidades.MostrarError("Error al cargar datos",i.mensaje||"No se pudieron cargar los productos.")}catch(r){window.Products.Utilidades.MostrarError("Error","Error al procesar la respuesta del servidor.");console.error("Error al parsear respuesta:",r)}else window.Products.Utilidades.MostrarError("Error de Conexión","Error al conectar con el servidor."),console.error("Error al cargar productos:",n.status,n.statusText)};n.send()},Recargar:function(){this.CargarDatos()}};window.Products.Filtros={Aplicar:function(){var u=document.getElementById("productsGrid"),t,i,r,f,n;if(u&&(t=u.ej2_instances&&u.ej2_instances[0],t)){if(i=this.ObtenerPrecioMin(),r=this.ObtenerPrecioMax(),i&&r&&i>r){window.Products.Utilidades.MostrarError("Error de Validación","El precio mínimo no puede ser mayor al precio máximo.");return}f={Categoria:this.ObtenerCategoria(),Estado:this.ObtenerEstado(),PrecioMinimo:i,PrecioMaximo:r};n=new XMLHttpRequest;n.open("POST","/Products/BuscarProducts",!0);n.setRequestHeader("Content-Type","application/json");n.onreadystatechange=function(){if(n.readyState===4)if(n.status===200)try{var i=JSON.parse(n.responseText);i.exito?(t.dataSource=i.datos,t.refresh()):window.Products.Utilidades.MostrarError("Error al aplicar filtros",i.mensaje||"No se pudieron aplicar los filtros.")}catch(r){window.Products.Utilidades.MostrarError("Error","Error al procesar la respuesta del servidor.");console.error("Error al parsear respuesta:",r)}else window.Products.Utilidades.MostrarError("Error de Conexión","Error al conectar con el servidor."),console.error("Error al aplicar filtros:",n.status,n.statusText)};n.send(JSON.stringify(f))}},Limpiar:function(){var r=document.getElementById("filtroCategoria"),n,t,i;r&&r.ej2_instances&&r.ej2_instances[0]&&(r.ej2_instances[0].value=null);n=document.getElementById("filtroEstado");n&&n.ej2_instances&&n.ej2_instances[0]&&(n.ej2_instances[0].value=null);t=document.getElementById("filtroPrecioMin");t&&t.ej2_instances&&t.ej2_instances[0]&&(t.ej2_instances[0].value=null);i=document.getElementById("filtroPrecioMax");i&&i.ej2_instances&&i.ej2_instances[0]&&(i.ej2_instances[0].value=null);window.Products&&window.Products.Grid&&window.Products.Grid.CargarDatos()},ObtenerCategoria:function(){var n=document.getElementById("filtroCategoria");return!n||!n.ej2_instances?null:n.ej2_instances[0]?n.ej2_instances[0].value:null},ObtenerEstado:function(){var n=document.getElementById("filtroEstado");return!n||!n.ej2_instances?null:n.ej2_instances[0]?n.ej2_instances[0].value:null},ObtenerPrecioMin:function(){var n=document.getElementById("filtroPrecioMin");return!n||!n.ej2_instances?null:n.ej2_instances[0]?n.ej2_instances[0].value:null},ObtenerPrecioMax:function(){var n=document.getElementById("filtroPrecioMax");return!n||!n.ej2_instances?null:n.ej2_instances[0]?n.ej2_instances[0].value:null}};window.Products.Dashboard={ActualizarMetricas:function(){var n=new XMLHttpRequest;n.open("POST","/Products/ObtenerMetricas",!0);n.setRequestHeader("Content-Type","application/json");n.onreadystatechange=function(){var i,t,u,f;if(n.readyState===4)if(n.status===200)try{if(i=JSON.parse(n.responseText),i.exito&&i.datos){t=i.datos;u=t.totalProductos||0;function r(n,t){var i=document.getElementById(n);i&&(i.textContent=t)}r("totalProductos",u);r("productosActivos",t.productosActivos||0);r("stockBajo",t.stockBajo||0);r("valorInventario","$"+parseFloat(t.valorInventario||0).toFixed(2));f=document.querySelector('[id^="breadcrumb-contador-"]');f&&(f.textContent=u.toString())}}catch(e){console.error("Error al parsear métricas:",e)}else console.error("Error al actualizar métricas de productos:",n.status,n.statusText)};n.send()}};window.Products.Modal={Abrir:function(n,t){var i=parseInt(n,10);if(!i||isNaN(i)||i<=0){window.Products.Utilidades.MostrarError("Error","ID de producto no válido.");return}modalProductoId=i;modalProductoModo=t||"ver";this.CargarDatosProducto(i)},CargarDatosProducto:function(n){var i=this,t=new XMLHttpRequest;t.open("POST","/Products/ObtenerProductPorId",!0);t.setRequestHeader("Content-Type","application/json");t.onreadystatechange=function(){if(t.readyState===4)if(t.status===200)try{var n=JSON.parse(t.responseText);n.exito&&n.datos?(i.MostrarDatos(n.datos),i.AbrirDialog()):window.Products.Utilidades.MostrarError("Error",n.mensaje||"No se pudo cargar el producto.")}catch(r){window.Products.Utilidades.MostrarError("Error","Error al procesar la respuesta del servidor.");console.error("Error al parsear respuesta:",r)}else window.Products.Utilidades.MostrarError("Error de Conexión","Error al cargar el producto."),console.error("Error al cargar producto:",t.status,t.statusText)};t.send(JSON.stringify(n))},MostrarDatos:function(n){function f(n){return document.getElementById(n)}function t(n,t){var i=f(n);i&&(i.textContent=t)}function e(n,t){var i=f(n);i&&(i.innerHTML=t)}var r,i,u;t("modalProductoTitulo",n.IdProducto);t("modalIdProducto",n.IdProducto);t("modalNombreProducto",n.NombreProducto||"-");t("modalCategoria",n.Categoria||"-");r="";r=n.Estado==="ACTIVE"?'<span class="badge bg-success info-tooltip-producto" data-field="Estado" data-tooltip="Producto activo y disponible para venta">'+n.Estado+"<\/span>":'<span class="badge bg-secondary info-tooltip-producto" data-field="Estado" data-tooltip="Producto inactivo, no disponible para venta">'+(n.Estado||"INACTIVE")+"<\/span>";e("modalEstadoProducto",r);t("modalCodigoBarras",n.CodigoBarras||"-");t("modalPrecioUnitario","$"+(n.PrecioUnitario||0).toFixed(2));t("modalPrecioCosto","$"+(n.PrecioCosto||0).toFixed(2));t("modalMargenGanancia","$"+(n.MargenGanancia||0).toFixed(2));i=n.CantidadStock||0;u="";u=i<20?'<span class="text-danger fw-bold">'+i+"<\/span>":i<50?'<span class="text-warning">'+i+"<\/span>":'<span class="text-success">'+i+"<\/span>";e("modalCantidadStock",u);t("modalDescripcion",n.Descripcion||"-")},AbrirDialog:function(){function t(){r._abriendoModal=!1}function e(){var n,i,u,r,f,t;if(typeof modalProductoInstance!="undefined"&&window.modalProductoInstance!==null)return window.modalProductoInstance;if(n=document.getElementById("modalProducto"),n){if(n.ej2_instances&&n.ej2_instances[0]&&(i=n.ej2_instances[0],i&&typeof i.show=="function"))return window.modalProductoInstance=i,i;if(n.ej2_instances&&n.ej2_instances.length>0)for(u=0;u<n.ej2_instances.length;u++)if(t=n.ej2_instances[u],t&&typeof t.show=="function")return window.modalProductoInstance=t,t;try{if(typeof ej!="undefined"&&ej.base&&typeof ej.base.getComponent=="function"&&(r=ej.base.getComponent(n,"dialog"),r&&typeof r.show=="function"))return window.modalProductoInstance=r,r}catch(e){}if(n.ej2_instances)for(f in n.ej2_instances)if(n.ej2_instances.hasOwnProperty(f)&&(t=n.ej2_instances[f],t&&typeof t.show=="function"))return window.modalProductoInstance=t,t}return null}function u(){n++;var r=e();if(r)try{r.show();console.log("✅ Modal abierto correctamente después de "+n+" intentos");window.modalProductoInstance=r;setTimeout(function(){var n=document.getElementById("tooltipModalProducto");n&&n.ej2_instances&&n.ej2_instances[0]&&typeof tooltipModalProductoObj!="undefined"&&(tooltipModalProductoObj=n.ej2_instances[0]);t()},100);return}catch(o){console.error("❌ Error al abrir modal:",o);window.Products.Utilidades.MostrarError("Error","No se pudo abrir el modal: "+o.message);t();return}n<i?(n%10==0&&console.log("⏳ Esperando inicialización del modal... Intento "+n+"/"+i),setTimeout(u,f)):(console.error("❌ Modal no inicializado después de "+i+" intentos"),window.Products.Utilidades.MostrarError("Error","El modal no está disponible. Por favor, recarga la página."),t())}var r;if(this._abriendoModal){console.log("⏳ Modal ya se está abriendo, esperando...");return}if(this._abriendoModal=!0,r=this,typeof mostrarModalProducto=="function"&&window.mostrarModalProducto()){console.log("✅ Modal abierto usando función helper");setTimeout(function(){var n=document.getElementById("tooltipModalProducto");n&&n.ej2_instances&&n.ej2_instances[0]&&typeof tooltipModalProductoObj!="undefined"&&(tooltipModalProductoObj=n.ej2_instances[0]);t()},100);return}var n=0,i=50,f=100;u()},CambiarAModoEdicion:function(){window.Products.Utilidades.MostrarExito("Modo Edición","El modo edición se implementará próximamente.")}};window.Products.Detalles={Ver:function(n){window.Products.Modal.Abrir(n,"ver")}};window.Products.Edicion={Editar:function(n){window.Products.Modal.Abrir(n,"editar")}}})();