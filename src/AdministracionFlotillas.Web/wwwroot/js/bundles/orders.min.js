window.ordersGridCreated=function(){console.log("Grid creado, cargando datos...");window.Orders&&window.Orders.Grid&&window.Orders.Grid.CargarDatos()};window.ordersGridRowSelected=function(n){console.log("Fila seleccionada:",n.data);window.Orders&&window.Orders.Batch&&window.Orders.Batch.ActualizarContador()};window.ordersGridRowDeselected=function(n){console.log("Fila deseleccionada:",n.data);window.Orders&&window.Orders.Batch&&window.Orders.Batch.ActualizarContador()};window.ordersGridActionBegin=function(n){if(n.requestType==="save"&&n.data&&n.data.EstadoOrden){var t=n.previousData?n.previousData.EstadoOrden:null,i=n.data.EstadoOrden;if(t==="CANCELLED"||t==="REFUNDED"){n.cancel=!0;window.Orders&&window.Orders.Utilidades&&window.Orders.Utilidades.MostrarError("Error de Validación","No se puede cambiar el estado de una orden "+t+".");return}}};window.ordersGridActionButtonHandler||(window.ordersGridActionButtonHandler=function(n){var s=n.target,i=s.closest(".btn-ver-detalle, .btn-editar-orden"),t,u,o,f,e,r;if(i){if(t=i.getAttribute("data-id-orden"),(!t||t==="undefined"||t==="null"||t==="")&&(u=document.getElementById("ordersGrid"),u&&u.ej2_instances&&u.ej2_instances[0]&&(o=u.ej2_instances[0],f=i.closest(".e-row"),f)))try{e=o.getRowInfo(f);r=e?e.rowData:null;r&&(t=r.IdOrden||r.idOrden||r.ORDER_ID||r.order_id)}catch(h){console.warn("Error al obtener datos de la fila:",h)}t&&t!=="undefined"&&t!=="null"&&t!==""?(t=parseInt(t,10),t&&!isNaN(t)&&t>0?(console.log("Abriendo modal para orden ID:",t),i.classList.contains("btn-ver-detalle")?window.Orders&&window.Orders.Modal?window.Orders.Modal.Abrir(t,"ver"):window.Orders&&window.Orders.Detalles?window.Orders.Detalles.Ver(t):console.error("Orders.Modal y Orders.Detalles no están disponibles"):i.classList.contains("btn-editar-orden")&&(window.Orders&&window.Orders.Modal?window.Orders.Modal.Abrir(t,"editar"):window.Orders&&window.Orders.Edicion?window.Orders.Edicion.Editar(t):console.error("Orders.Modal y Orders.Edicion no están disponibles"))):console.error("ID de orden no válido después de parsear:",t)):console.error("No se pudo obtener ID de orden del botón. data-id-orden:",i.getAttribute("data-id-orden"),"button:",i)}});window.ordersGridDataBound=function(){window.Orders&&window.Orders.Batch&&window.Orders.Batch.ActualizarContador();var n=document.getElementById("ordersGrid");n&&!n.hasAttribute("data-action-handler-attached")&&(n.addEventListener("click",window.ordersGridActionButtonHandler),n.setAttribute("data-action-handler-attached","true"))};window.ordersGridQueryCellInfo=function(n){var t,i;if(n.column.field==="EstadoOrden"&&(t=n.data.EstadoOrden,t))switch(t.toUpperCase()){case"COMPLETE":n.cell.classList.add("estado-complete");break;case"CANCELLED":n.cell.classList.add("estado-cancelled");break;case"REFUNDED":n.cell.classList.add("estado-refunded");break;case"PENDING":n.cell.classList.add("estado-pending")}n.column.field==="EstadoOrden"?(t=n.data.EstadoOrden,t&&(i="Estado: "+t,t==="COMPLETE"?i+=" - Orden completada exitosamente":t==="CANCELLED"?i+=" - Orden cancelada":t==="REFUNDED"?i+=" - Orden reembolsada":t==="PENDING"&&(i+=" - Orden pendiente de procesamiento"),n.cell.setAttribute("title",i))):n.column.field==="IdCliente"?n.cell.setAttribute("title","ID del Cliente: "+n.data.IdCliente):n.column.field==="IdTienda"?n.cell.setAttribute("title","ID de la Tienda: "+n.data.IdTienda):n.column.field==="FechaOrden"&&n.cell.setAttribute("title","Fecha de la Orden: "+n.data.FechaOrden)};window.ordersGridRowDataBound=function(n){var t=n.data.EstadoOrden;if(t)switch(t.toUpperCase()){case"COMPLETE":n.row.classList.add("fila-estado-complete");break;case"CANCELLED":n.row.classList.add("fila-estado-cancelled");break;case"REFUNDED":n.row.classList.add("fila-estado-refunded");break;case"PENDING":n.row.classList.add("fila-estado-pending")}};window.ordersGridAggregateCellInfo=function(n){var t,u,f;if(n.column&&n.column.field){var e=n.column.field,o=n.aggregateType,i=n.value,r=n.key;n.cell&&(t=n.cell.innerHTML||"",i!==undefined&&i!==null&&(t=t.replace(/\$\{Count\}/g,i.toString()),u=n.cell.querySelector("#totalCount, #groupCount"),u&&(u.textContent=i.toString())),r!==undefined&&r!==null&&(t=t.replace(/\$\{key\}/g,r.toString()),f=n.cell.querySelector("#groupKey"),f&&(f.textContent=r.toString())),(t.includes("${Count}")||t.includes("${key}"))&&(i!==undefined&&i!==null&&(t=t.replace(/\$\{Count\}/g,i.toString())),r!==undefined&&r!==null&&(t=t.replace(/\$\{key\}/g,r.toString())),n.cell.innerHTML=t))}};window.ordersGridActionComplete=function(n){n.requestType==="filtering"?window.Orders&&window.Orders.Dashboard&&window.Orders.Dashboard.ActualizarMetricas():n.requestType==="save"&&n.data&&(window.Orders.Utilidades.MostrarExito("Orden actualizada","El estado de la orden se actualizó correctamente."),window.Orders&&window.Orders.Dashboard&&window.Orders.Dashboard.ActualizarMetricas())};window.ordersGridToolbarClick=function(n){var i=document.getElementById("ordersGrid"),r,t,u;if(!i||!i.ej2_instances||!i.ej2_instances[0]){console.warn("Grid no encontrado para exportación");return}if(r=i.ej2_instances[0],u="Ordenes_"+(new Date).toISOString().split("T")[0],n.item.text==="Excel Export"||n.item.id&&n.item.id.includes("excelexport"))t=r.excelExport({fileName:u+".xlsx"});else if(n.item.text==="Pdf Export"||n.item.id&&n.item.id.includes("pdfexport"))t=r.pdfExport({fileName:u+".pdf"});else if(n.item.text==="Csv Export"||n.item.id&&n.item.id.includes("csvexport"))t=r.csvExport({fileName:u+".csv"});else return;t&&t.then(function(){window.Orders.Utilidades.MostrarExito("Exportación Exitosa","El archivo se ha descargado correctamente.")}).catch(function(n){window.Orders.Utilidades.MostrarError("Error de Exportación","No se pudo exportar. Por favor, intenta nuevamente.");console.error("Error al exportar:",n)})};window.filtroClienteIdChange=window.debounce(function(){console.log("Filtro Cliente ID cambió");window.Orders&&window.Orders.Filtros?window.Orders.Filtros.Aplicar():console.warn("Orders.Filtros no está disponible")},300);window.filtroTiendaIdChange=window.debounce(function(){console.log("Filtro Tienda ID cambió");window.Orders&&window.Orders.Filtros?window.Orders.Filtros.Aplicar():console.warn("Orders.Filtros no está disponible")},300);window.filtroEstadoChange=window.debounce(function(n){if(console.log("Filtro Estado cambió:",n?n.value:"null"),window.Orders&&window.Orders.Filtros){var t=n?n.value||null:null;window.Orders.Filtros.ActualizarEstadoBotones(t);window.Orders.Filtros.Aplicar()}else console.warn("Orders.Filtros no está disponible")},300);window.filtroFechaInicioChange=window.debounce(function(){console.log("Filtro Fecha Inicio cambió");window.Orders&&window.Orders.Filtros?window.Orders.Filtros.Aplicar():console.warn("Orders.Filtros no está disponible")},300);window.filtroFechaFinChange=window.debounce(function(){console.log("Filtro Fecha Fin cambió");window.Orders&&window.Orders.Filtros?window.Orders.Filtros.Aplicar():console.warn("Orders.Filtros no está disponible")},300);window.Orders=window.Orders||{};var modalOrdenId=null,modalOrdenModo="ver";(function(){"use strict";window.Orders.Utilidades={MostrarError:function(n,t){Swal.fire({icon:"error",title:n||"Error",text:t||"Ha ocurrido un error. Por favor, intenta nuevamente.",confirmButtonText:"Aceptar"})},MostrarExito:function(n,t){return Swal.fire({icon:"success",title:n||"Éxito",text:t||"Operación completada correctamente.",confirmButtonText:"Aceptar",timer:3e3,showConfirmButton:!0})},DeshabilitarBotonesModal:function(n){window.ModalButtons&&window.ModalButtons.Deshabilitar(n||"modalOrden",".btn-ver-orden, .btn-editar-orden")},HabilitarBotonesModal:function(n){window.ModalButtons&&window.ModalButtons.Habilitar(n||"modalOrden",".btn-ver-orden, .btn-editar-orden")}};window.Orders.Grid={CargarDatos:function(){var i=document.getElementById("ordersGrid"),t,n;if(!i){console.warn("Grid element no encontrado");return}if(t=i.ej2_instances&&i.ej2_instances[0],!t){console.warn("Grid instance no encontrada, reintentando en 500ms...");setTimeout(function(){window.Orders.Grid.CargarDatos()},500);return}n=new XMLHttpRequest;n.open("POST","/Orders/ObtenerOrders",!0);n.setRequestHeader("Content-Type","application/json");n.onreadystatechange=function(){var i,r,u,f;if(n.readyState===4)if(n.status===200)try{i=JSON.parse(n.responseText);i.exito&&i.datos?(r=i.datos.map(function(n){var t={IdOrden:n.IdOrden||n.idOrden||n.OrderId||n.orderId||0,EstadoOrden:n.EstadoOrden||n.estadoOrden||n.OrderStatus||n.orderStatus||"PENDING",IdCliente:n.IdCliente||n.idCliente||n.CustomerId||n.customerId||0,IdTienda:n.IdTienda||n.idTienda||n.StoreId||n.storeId||0,FechaOrden:n.FechaOrden||n.fechaOrden||n.OrderTms||n.orderTms||new Date,NombreCliente:n.NombreCliente||n.nombreCliente||"",NombreTienda:n.NombreTienda||n.nombreTienda||"",Subtotal:n.Subtotal||n.subtotal||0,Descuentos:n.Descuentos||n.descuentos||0,Impuestos:n.Impuestos||n.impuestos||0,Total:n.Total||n.total||0};return t.EstadoOrden&&t.EstadoOrden!=="null"&&t.EstadoOrden!=="undefined"&&t.EstadoOrden!==""&&t.EstadoOrden!==null&&t.EstadoOrden!==undefined||(t.EstadoOrden="PENDING"),t.IdOrden=parseInt(t.IdOrden,10)||0,t.IdCliente=parseInt(t.IdCliente,10)||0,t.IdTienda=parseInt(t.IdTienda,10)||0,t.IdOrden===0&&console.warn("Orden sin ID válido:",n),t}),r.length>0&&console.log("Primera orden normalizada (ejemplo):",r[0]),window.Orders.Cache&&window.Orders.Cache.Guardar("ordenes_lista",r,12e4),t.dataSource=r,t.refresh(),console.log("Datos cargados y normalizados:",r.length,"órdenes")):(window.Orders.Utilidades.MostrarError("Error al cargar datos",i.mensaje||"No se pudieron cargar los datos. Por favor, intenta nuevamente."),console.error("Respuesta sin éxito:",i))}catch(e){console.error("Error al parsear respuesta:",e);window.Orders.Utilidades.MostrarError("Error","Error al procesar la respuesta del servidor.")}else{u="Error al conectar con el servidor. ";try{f=JSON.parse(n.responseText);u+=f&&f.mensaje?f.mensaje:"Por favor, verifica tu conexión e intenta nuevamente."}catch(e){u+="Respuesta no JSON o vacía."}window.Orders.Utilidades.MostrarError("Error de Conexión",u);console.error("Error al cargar datos:",n.status,n.statusText)}};n.send()},Recargar:function(){window.Orders.Cache&&window.Orders.Cache.Limpiar();this.CargarDatos(!0)}};window.Orders.Filtros={Aplicar:function(){var u=document.getElementById("ordersGrid"),r,t,i,f,n;if(!u){console.warn("Grid element no encontrado para aplicar filtros");return}if(r=u.ej2_instances&&u.ej2_instances[0],!r){console.warn("Grid instance no encontrada para aplicar filtros");return}if(t=this.ObtenerFechaInicio(),i=this.ObtenerFechaFin(),t&&i&&t>i){Swal.fire({icon:"error",title:"Error de Validación",text:"La fecha de inicio no puede ser posterior a la fecha de fin.",confirmButtonText:"Aceptar"});return}f={IdCliente:this.ObtenerIdCliente(),IdTienda:this.ObtenerIdTienda(),Estado:this.ObtenerEstado(),FechaInicio:t?t.toISOString():null,FechaFin:i?i.toISOString():null};n=new XMLHttpRequest;n.open("POST","/Orders/BuscarOrders",!0);n.setRequestHeader("Content-Type","application/json");n.onreadystatechange=function(){var t,e,o,i,u;if(n.readyState===4)if(n.status===200)try{t=JSON.parse(n.responseText);t.exito&&t.datos?(e=t.datos.map(function(n){var t={IdOrden:n.IdOrden||n.idOrden||n.OrderId||n.orderId||0,EstadoOrden:n.EstadoOrden||n.estadoOrden||n.OrderStatus||n.orderStatus||"PENDING",IdCliente:n.IdCliente||n.idCliente||n.CustomerId||n.customerId||0,IdTienda:n.IdTienda||n.idTienda||n.StoreId||n.storeId||0,FechaOrden:n.FechaOrden||n.fechaOrden||n.OrderTms||n.orderTms||new Date,NombreCliente:n.NombreCliente||n.nombreCliente||"",NombreTienda:n.NombreTienda||n.nombreTienda||"",Subtotal:n.Subtotal||n.subtotal||0,Descuentos:n.Descuentos||n.descuentos||0,Impuestos:n.Impuestos||n.impuestos||0,Total:n.Total||n.total||0};return t.EstadoOrden&&t.EstadoOrden!=="null"&&t.EstadoOrden!=="undefined"&&t.EstadoOrden!==""&&t.EstadoOrden!==null&&t.EstadoOrden!==undefined||(t.EstadoOrden="PENDING"),t.IdOrden=parseInt(t.IdOrden,10)||0,t.IdCliente=parseInt(t.IdCliente,10)||0,t.IdTienda=parseInt(t.IdTienda,10)||0,t}),r.dataSource=e,r.refresh(),o=f.Estado||null,window.Orders.Filtros.ActualizarEstadoBotones(o),window.Orders.Utilidades.MostrarExito("Filtros aplicados","Se encontraron "+e.length+" órdenes.")):window.Orders.Utilidades.MostrarError("Error al aplicar filtros",t.mensaje||"No se pudieron aplicar los filtros. Por favor, intenta nuevamente.")}catch(s){console.error("Error al parsear respuesta de filtros:",s);window.Orders.Utilidades.MostrarError("Error de Parseo","Error al procesar la respuesta del servidor.")}else{i="Error al conectar con el servidor. ";try{u=JSON.parse(n.responseText);i+=u&&u.mensaje?u.mensaje:"Por favor, verifica tu conexión e intenta nuevamente."}catch(s){i+="Respuesta no JSON o vacía."}window.Orders.Utilidades.MostrarError("Error de Conexión",i);console.error("Error al cargar datos:",n.status,n.statusText)}};n.send(JSON.stringify(f))},Limpiar:function(){var u=document.getElementById("filtroClienteId"),n,t,i,r;u&&u.ej2_instances&&u.ej2_instances[0]&&(u.ej2_instances[0].value=null,u.ej2_instances[0].dataBind());n=document.getElementById("filtroEstado");n&&n.ej2_instances&&n.ej2_instances[0]&&(n.ej2_instances[0].value=null,n.ej2_instances[0].dataBind());t=document.getElementById("filtroTiendaId");t&&t.ej2_instances&&t.ej2_instances[0]&&(t.ej2_instances[0].value=null,t.ej2_instances[0].dataBind());i=document.getElementById("filtroFechaInicio");i&&i.ej2_instances&&i.ej2_instances[0]&&(i.ej2_instances[0].value=null,i.ej2_instances[0].dataBind());r=document.getElementById("filtroFechaFin");r&&r.ej2_instances&&r.ej2_instances[0]&&(r.ej2_instances[0].value=null,r.ej2_instances[0].dataBind());this.ActualizarEstadoBotones(null);window.Orders&&window.Orders.Grid&&window.Orders.Grid.CargarDatos()},ObtenerIdCliente:function(){var n=document.getElementById("filtroClienteId");return!n||!n.ej2_instances?null:n.ej2_instances[0]?n.ej2_instances[0].value:null},ObtenerIdTienda:function(){var n=document.getElementById("filtroTiendaId");return!n||!n.ej2_instances?null:n.ej2_instances[0]?n.ej2_instances[0].value:null},ObtenerEstado:function(){var n=document.getElementById("filtroEstado");return!n||!n.ej2_instances?null:n.ej2_instances[0]?n.ej2_instances[0].value:null},ObtenerFechaInicio:function(){var n=document.getElementById("filtroFechaInicio");return!n||!n.ej2_instances?null:n.ej2_instances[0]?n.ej2_instances[0].value:null},ObtenerFechaFin:function(){var n=document.getElementById("filtroFechaFin");return!n||!n.ej2_instances?null:n.ej2_instances[0]?n.ej2_instances[0].value:null},FiltrarPorEstado:function(n){var t=document.getElementById("filtroEstado");t&&t.ej2_instances&&t.ej2_instances[0]&&(t.ej2_instances[0].value=n,t.ej2_instances[0].dataBind());this.ActualizarEstadoBotones(n);this.Aplicar()},ActualizarEstadoBotones:function(n){var t=document.getElementById("btnFiltroTotal"),i=document.getElementById("btnFiltroComplete"),r=document.getElementById("btnFiltroCancelled"),u=document.getElementById("btnFiltroRefunded");t&&(t.classList.remove("active","fw-bold"),t.style.textDecoration="none");i&&(i.classList.remove("active","fw-bold"),i.style.textDecoration="none");r&&(r.classList.remove("active","fw-bold"),r.style.textDecoration="none");u&&(u.classList.remove("active","fw-bold"),u.style.textDecoration="none");n===null&&t?(t.classList.add("active","fw-bold"),t.style.textDecoration="underline"):n==="COMPLETE"&&i?(i.classList.add("active","fw-bold"),i.style.textDecoration="underline"):n==="CANCELLED"&&r?(r.classList.add("active","fw-bold"),r.style.textDecoration="underline"):n==="REFUNDED"&&u&&(u.classList.add("active","fw-bold"),u.style.textDecoration="underline")}};window.Orders.Cache={datos:{},Obtener:function(n){var t=this.datos[n];return t?t.expiracion&&Date.now()>t.expiracion?(delete this.datos[n],null):t.valor:null},Guardar:function(n,t,i){this.datos[n]={valor:t,expiracion:i?Date.now()+i:null}},EsValido:function(n){var t=this.datos[n];return t?t.expiracion&&Date.now()>t.expiracion?(delete this.datos[n],!1):!0:!1},Limpiar:function(){this.datos={}}};window.Orders.Dashboard={ActualizarMetricas:function(){var n=new XMLHttpRequest;n.open("POST","/Orders/ObtenerMetricas",!0);n.setRequestHeader("Content-Type","application/json");n.onreadystatechange=function(){var t,i,r,u,f,e,o;if(n.readyState===4)if(n.status===200)try{t=JSON.parse(n.responseText);t.exito?(i=t.datos.totalOrders||0,r=document.getElementById("totalOrders"),r&&(r.textContent=i),u=document.getElementById("completedOrders"),u&&(u.textContent=t.datos.completedOrders||0),f=document.getElementById("cancelledOrders"),f&&(f.textContent=t.datos.cancelledOrders||0),e=document.getElementById("refundedOrders"),e&&(e.textContent=t.datos.refundedOrders||0),o=document.querySelector('[id^="breadcrumb-contador-"]'),o&&(o.textContent=i.toString())):console.error("Error al actualizar métricas:",t.mensaje)}catch(s){console.error("Error al parsear respuesta de métricas:",s)}else console.error("Error al actualizar métricas: HTTP "+n.status)};n.send()}};window.Orders.Modal={Abrir:function(n,t){var i=parseInt(n,10);if(!i||isNaN(i)||i<=0){console.error("ID de orden no válido:",n);window.Orders.Utilidades.MostrarError("Error","ID de orden no válido.");return}modalOrdenId=i;modalOrdenModo=t||"ver";this.CargarDatosOrden(i)},CargarDatosOrden:function(n){var r="orden_"+n,i=this,u,t;if(window.Orders.Cache.EsValido(r)){u=window.Orders.Cache.Obtener(r);i.MostrarDatos(u);setTimeout(function(){i.AbrirDialog();i.CargarItemsFactura(n)},100);return}t=new XMLHttpRequest;t.open("POST","/Orders/ObtenerOrderPorId",!0);t.setRequestHeader("Content-Type","application/json");t.onreadystatechange=function(){if(t.readyState===4)if(t.status===200)try{var u=JSON.parse(t.responseText);u.exito&&u.datos?(window.Orders.Cache.Guardar(r,u.datos,3e5),i.MostrarDatos(u.datos),setTimeout(function(){i.AbrirDialog();i.CargarItemsFactura(n)},100)):window.Orders.Utilidades.MostrarError("Error",u.mensaje||"No se pudo cargar la orden.")}catch(f){console.error("Error al parsear respuesta:",f);window.Orders.Utilidades.MostrarError("Error","Error al procesar la respuesta del servidor.")}else window.Orders.Utilidades.MostrarError("Error de Conexión","Error al cargar la orden."),console.error("Error al cargar orden: HTTP "+t.status)};t.send(JSON.stringify(n))},MostrarDatos:function(n){function u(n){return document.getElementById(n)}function t(n,t){var i=u(n);i&&(i.textContent=t)}function i(n,t){var i=u(n);i&&(i.innerHTML=t)}var r;t("modalOrdenTitulo",n.IdOrden);t("modalIdOrden",n.IdOrden);t("modalFechaOrden",n.FechaOrden?new Date(n.FechaOrden).toLocaleString("es-MX"):"-");r="";r=n.EstadoOrden==="COMPLETE"?'<span class="badge bg-success info-tooltip-orden" data-field="EstadoOrden" data-tooltip="Orden completada exitosamente">'+n.EstadoOrden+"<\/span>":n.EstadoOrden==="CANCELLED"?'<span class="badge bg-warning text-dark info-tooltip-orden" data-field="EstadoOrden" data-tooltip="Orden cancelada por el cliente o sistema">'+n.EstadoOrden+"<\/span>":n.EstadoOrden==="REFUNDED"?'<span class="badge bg-danger info-tooltip-orden" data-field="EstadoOrden" data-tooltip="Orden reembolsada, el pago fue devuelto">'+n.EstadoOrden+"<\/span>":'<span class="badge bg-secondary info-tooltip-orden" data-field="EstadoOrden" data-tooltip="Orden pendiente de procesamiento">'+(n.EstadoOrden||"PENDING")+"<\/span>";i("modalEstadoOrden",r);t("modalIdCliente",n.IdCliente||"-");t("modalNombreCliente",n.NombreCliente||"-");t("modalIdTienda",n.IdTienda||"-");t("modalNombreTienda",n.NombreTienda||"-");var f=n.Subtotal||0,e=n.Descuentos||0,o=n.Impuestos||0,s=n.Total||0;i("modalSubtotal",'<i class="fas fa-calculator me-1"><\/i>$'+f.toFixed(2));i("modalDescuentos",'<i class="fas fa-tag me-1"><\/i>-$'+e.toFixed(2));i("modalImpuestos",'<i class="fas fa-receipt me-1"><\/i>$'+o.toFixed(2));i("modalTotal",'<i class="fas fa-dollar-sign me-1"><\/i>$'+s.toFixed(2));setTimeout(function(){window.Orders.Modal.ActualizarGraficaTotales(n)},300)},ActualizarGraficaTotales:function(n){var t=document.getElementById("chartTotalesOrden"),i;if(t){if(typeof ej=="undefined"||!ej.charts||!ej.charts.Chart){console.warn("Syncfusion Charts no está disponible aún, reintentando...");setTimeout(function(){window.Orders.Modal.ActualizarGraficaTotales(n)},500);return}var r=n.Subtotal||0,u=n.Descuentos||0,f=n.Impuestos||0,e=n.Total||0;t.ej2_instances&&t.ej2_instances[0]&&t.ej2_instances[0].destroy();i=new ej.charts.Chart({series:[{type:"Pie",dataSource:[{concepto:"Subtotal",valor:r},{concepto:"Impuestos",valor:f},{concepto:"Descuentos",valor:u}],xName:"concepto",yName:"valor",radius:"70%",dataLabel:{visible:!0,position:"Outside",name:"concepto",font:{fontWeight:"600"},connectorStyle:{length:"20px"}},tooltip:{enable:!0,format:"${point.x}: $${point.y}"}}],legendSettings:{visible:!0,position:"Bottom"},height:"180px",width:"100%"});i.appendTo("#chartTotalesOrden")}},CargarItemsFactura:function(n){var t=new XMLHttpRequest;t.open("POST","/Orders/ObtenerItemsFactura",!0);t.setRequestHeader("Content-Type","application/json");t.onreadystatechange=function(){var i,n;if(t.readyState===4)if(t.status===200)try{i=JSON.parse(t.responseText);i.exito&&i.datos&&(n=document.getElementById("gridItemsModalOrden"),n&&n.ej2_instances&&n.ej2_instances[0]&&(n.ej2_instances[0].dataSource=i.datos,n.ej2_instances[0].refresh()))}catch(r){console.error("Error al parsear respuesta de items de factura:",r)}else console.error("Error al cargar items de factura: HTTP "+t.status)};t.send(JSON.stringify(n))},AbrirDialog:function(){function i(){if(typeof modalOrdenInstance!="undefined"&&window.modalOrdenInstance!==null)return window.modalOrdenInstance;var n=document.getElementById("modalOrden");return n&&n.ej2_instances&&n.ej2_instances[0]?n.ej2_instances[0]:null}function r(){var f,o,c,s,e;if(n++,e=i(),e)try{e.show();console.log("✅ Modal abierto correctamente después de "+n+" intentos");window.modalOrdenInstance=e;setTimeout(function(){var n=document.getElementById("tooltipModalOrden");n&&n.ej2_instances&&n.ej2_instances[0]&&typeof tooltipModalOrdenObj!="undefined"&&(tooltipModalOrdenObj=n.ej2_instances[0])},100);return}catch(h){console.error("❌ Error al abrir modal:",h);window.Orders.Utilidades.MostrarError("Error","No se pudo abrir el modal: "+h.message);return}if(n<t)n%10==0&&console.log("⏳ Esperando inicialización del modal... Intento "+n+"/"+t),setTimeout(r,u);else{if(console.error("❌ Modal no inicializado después de "+t+" intentos"),f=document.getElementById("modalOrden"),console.log("=== DIAGNÓSTICO DETALLADO ==="),console.log("- Elemento modalOrden existe:",!!f),f&&(console.log("- Elemento HTML:",f.outerHTML.substring(0,200)),console.log("- Elemento tiene ej2_instances:",!!f.ej2_instances),console.log("- Número de instancias:",f.ej2_instances?f.ej2_instances.length:0),console.log("- Primera instancia disponible:",!!(f.ej2_instances&&f.ej2_instances[0]))),console.log("- Syncfusion (ejs) disponible:",typeof ejs!="undefined"),console.log("- Instancia created disponible:",typeof modalOrdenInstance!="undefined"),console.log("- window.modalOrdenInstance valor:",window.modalOrdenInstance),console.log("- Función modalOrdenCreated definida:",typeof modalOrdenCreated!="undefined"),console.log("- Función mostrarModalOrden disponible:",typeof mostrarModalOrden!="undefined"),console.log("- Script Manager ejecutado:",typeof ejs!="undefined"&&typeof ejs.popups!="undefined"),console.log("=== FIN DIAGNÓSTICO ==="),!f&&typeof ejs!="undefined"&&ejs.popups&&ejs.popups.Dialog){console.warn("⚠️ Elemento modalOrden no existe en el DOM. Creando manualmente...");try{o=document.createElement("div");o.id="modalOrden";o.style.display="none";document.body.appendChild(o);c={isModal:!0,showCloseIcon:!0,width:"90%",height:"85%",visible:!1,header:'Orden #<span id="modalOrdenTitulo">0<\/span>',created:function(n){console.log("✅ Dialog creado manualmente");n&&n.component&&(window.modalOrdenInstance=n.component)}};s=document.querySelector("#modalOrdenContenido");o.innerHTML=s?s.innerHTML:'<div id="modalOrdenContenido"><div id="tabsModalOrden"><\/div><\/div>';e=new ejs.popups.Dialog(c,o);window.modalOrdenInstance=e;e.show();console.log("✅ Modal creado e inicializado manualmente");return}catch(l){console.error("❌ Error al crear Dialog manualmente:",l)}}else if(f&&typeof ejs!="undefined"&&ejs.popups&&ejs.popups.Dialog){console.warn("⚠️ Intentando inicialización manual del Dialog usando Syncfusion API...");try{if(typeof ejs!="undefined"&&ejs.base&&ejs.base.process){ejs.base.process([f]);setTimeout(function(){var n=i();n?(n.show(),console.log("✅ Modal inicializado y abierto manualmente")):window.Orders.Utilidades.MostrarError("Error","El modal no está disponible. Por favor, recarga la página.")},200);return}}catch(l){console.error("❌ Error en inicialización manual:",l)}}window.Orders.Utilidades.MostrarError("Error","El modal no está disponible. Por favor, recarga la página.")}}if(typeof mostrarModalOrden=="function"&&window.mostrarModalOrden()){console.log("✅ Modal abierto usando función helper");setTimeout(function(){var n=document.getElementById("tooltipModalOrden");n&&n.ej2_instances&&n.ej2_instances[0]&&typeof tooltipModalOrdenObj!="undefined"&&(tooltipModalOrdenObj=n.ej2_instances[0])},100);return}var f=this,n=0,t=50,u=100;setTimeout(r,50)},CambiarAModoEdicion:function(n){if(!n||n<=0){window.Orders.Utilidades.MostrarError("Error","ID de orden no válido.");return}modalOrdenId=n;modalOrdenModo="editar";this.ActivarModoEdicion()},ActivarModoEdicion:function(){this.ConvertirCamposAEditables();this.ActualizarBotonesModal();var n=document.getElementById("modalOrdenTitulo");n&&(n.textContent=modalOrdenId+" (Editando)")},DesactivarModoEdicion:function(){this.ConvertirCamposASoloLectura();this.RestaurarBotonesModal();var n=document.getElementById("modalOrdenTitulo");n&&(n.textContent=modalOrdenId);modalOrdenModo="ver"},ConvertirCamposAEditables:function(){var t=document.getElementById("modalEstadoOrden"),n;t&&(n=t.textContent.trim(),t.innerHTML='<select id="editEstadoOrden" class="form-select form-select-sm"><option value="PENDING"'+(n==="PENDING"?" selected":"")+'>PENDING<\/option><option value="COMPLETE"'+(n==="COMPLETE"?" selected":"")+'>COMPLETE<\/option><option value="CANCELLED"'+(n==="CANCELLED"?" selected":"")+'>CANCELLED<\/option><option value="REFUNDED"'+(n==="REFUNDED"?" selected":"")+">REFUNDED<\/option><\/select>")},ConvertirCamposASoloLectura:function(){var r=document.getElementById("modalEstadoOrden"),t,n,i;r&&(t=document.getElementById("editEstadoOrden"),t&&(n=t.value,i="",i=n==="COMPLETE"?'<span class="badge bg-success">'+n+"<\/span>":n==="CANCELLED"?'<span class="badge bg-warning text-dark">'+n+"<\/span>":n==="REFUNDED"?'<span class="badge bg-danger">'+n+"<\/span>":'<span class="badge bg-info text-dark">'+n+"<\/span>",r.innerHTML=i))},ActualizarBotonesModal:function(){var i=document.getElementById("btnModalImprimir"),r=document.getElementById("btnModalEditar"),u=document.getElementById("btnModalCerrar"),n,t;i&&i.classList.add("d-none");r&&r.classList.add("d-none");u&&u.classList.add("d-none");n=document.getElementById("btnModalGuardar");t=document.getElementById("btnModalCancelar");n&&n.classList.remove("d-none");t&&t.classList.remove("d-none")},RestaurarBotonesModal:function(){var n=document.getElementById("btnModalGuardar"),t=document.getElementById("btnModalCancelar");n&&n.classList.add("d-none");t&&t.classList.add("d-none");var i=document.getElementById("btnModalImprimir"),r=document.getElementById("btnModalEditar"),u=document.getElementById("btnModalCerrar");i&&i.classList.remove("d-none");r&&r.classList.remove("d-none");u&&u.classList.remove("d-none")},GuardarCambios:function(){var t,i,r,n;if(!modalOrdenId||modalOrdenId<=0){window.Orders.Utilidades.MostrarError("Error","No hay orden seleccionada para guardar.");return}if(t=document.getElementById("editEstadoOrden"),i=t?t.value:null,!i){window.Orders.Utilidades.MostrarError("Error","Debe seleccionar un estado válido.");return}window.Orders.Utilidades.DeshabilitarBotonesModal("modalOrden");r={IdOrden:modalOrdenId,EstadoOrden:i};n=new XMLHttpRequest;n.open("POST","/Orders/ActualizarOrden",!0);n.setRequestHeader("Content-Type","application/json");n.onreadystatechange=function(){var t,i;if(n.readyState===4)if(n.status===200)try{t=JSON.parse(n.responseText);t.exito?window.Orders.Utilidades.MostrarExito("Orden actualizada","Los cambios se guardaron correctamente.").then(function(){window.Orders&&window.Orders.Modal&&(window.Orders.Modal.DesactivarModoEdicion(),window.Orders.Modal.CargarDatosOrden(modalOrdenId),window.Orders&&window.Orders.Grid&&window.Orders.Grid.Recargar(),window.Orders&&window.Orders.Dashboard&&window.Orders.Dashboard.ActualizarMetricas());window.Orders.Utilidades.HabilitarBotonesModal("modalOrden")}):window.Orders.Utilidades.MostrarError("Error al guardar",t.mensaje||"No se pudieron guardar los cambios.").then(function(){window.Orders.Utilidades.HabilitarBotonesModal("modalOrden")})}catch(r){console.error("Error al parsear respuesta:",r);window.Orders.Utilidades.MostrarError("Error","Error al procesar la respuesta del servidor.").then(function(){window.Orders.Utilidades.HabilitarBotonesModal("modalOrden")})}else i="Error HTTP: "+n.status+" - "+n.statusText,window.Orders.Utilidades.MostrarError("Error de Conexión",i).then(function(){window.Orders.Utilidades.HabilitarBotonesModal("modalOrden")}),console.error("Error al guardar orden:",i)};n.onerror=function(){window.Orders.Utilidades.MostrarError("Error de Conexión","No se pudo conectar con el servidor.").then(function(){window.Orders.Utilidades.HabilitarBotonesModal("modalOrden")})};n.send(JSON.stringify(r))},CancelarEdicion:function(){modalOrdenId&&this.CargarDatosOrden(modalOrdenId);this.DesactivarModoEdicion()}};window.Orders.Detalles={Ver:function(n){window.Orders.Modal.Abrir(n,"ver")}};window.Orders.Edicion={Editar:function(n){window.Orders.Modal.Abrir(n,"editar")}};window.Orders.Batch={ObtenerFilasSeleccionadas:function(){var n=document.getElementById("ordersGrid"),t,i;return!n||!n.ej2_instances||!n.ej2_instances[0]?[]:(t=n.ej2_instances[0],i=t.getSelectedRows(),i||[])},ActualizarContador:function(){var r=this.ObtenerFilasSeleccionadas(),n=r.length,t=document.getElementById("contadorSeleccionados"),i=document.getElementById("accionesBatch");t&&(t.textContent=n+" órdenes seleccionadas");i&&(i.style.display=n>0?"block":"none")},CambiarEstado:function(n){var t=this.ObtenerFilasSeleccionadas();if(t.length===0){window.Orders.Utilidades.MostrarError("Error","No hay órdenes seleccionadas.");return}Swal.fire({title:"¿Confirmar cambio de estado?",text:"Se cambiará el estado de "+t.length+" órdenes a "+n+".",icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, cambiar estado",cancelButtonText:"Cancelar"}).then(i=>{i.isConfirmed&&this.ProcesarCambioEstado(t,n)})},ProcesarCambioEstado:function(n,t){var r=n.map(function(n){return n.data.IdOrden}),i;window.ModalButtons&&window.ModalButtons.Deshabilitar(null,".btn-ver-orden, .btn-editar-orden, #accionesBatch button");i=new XMLHttpRequest;i.open("POST","/Orders/CambiarEstadoBatch",!0);i.setRequestHeader("Content-Type","application/json");i.onreadystatechange=function(){if(i.readyState===4)if(i.status===200)try{var n=JSON.parse(i.responseText);n.exito?window.Orders.Utilidades.MostrarExito("Estado actualizado","Se actualizaron "+r.length+" órdenes correctamente.").then(function(){window.Orders&&window.Orders.Grid&&window.Orders.Grid.Recargar();window.Orders.Batch.DeseleccionarTodas();window.ModalButtons&&window.ModalButtons.Habilitar(null,".btn-ver-orden, .btn-editar-orden, #accionesBatch button")}):window.Orders.Utilidades.MostrarError("Error al actualizar estado",n.mensaje||"No se pudieron actualizar las órdenes.").then(function(){window.ModalButtons&&window.ModalButtons.Habilitar(null,".btn-ver-orden, .btn-editar-orden, #accionesBatch button")})}catch(t){console.error("Error al parsear respuesta:",t);window.Orders.Utilidades.MostrarError("Error","Error al procesar la respuesta del servidor.").then(function(){window.ModalButtons&&window.ModalButtons.Habilitar(null,".btn-ver-orden, .btn-editar-orden, #accionesBatch button")})}else window.Orders.Utilidades.MostrarError("Error de Conexión","No se pudo conectar al servidor. Por favor, intenta nuevamente.").then(function(){window.ModalButtons&&window.ModalButtons.Habilitar(null,".btn-ver-orden, .btn-editar-orden, #accionesBatch button")}),console.error("Error al cambiar estado: HTTP "+i.status)};i.onerror=function(){window.Orders.Utilidades.MostrarError("Error de Conexión","No se pudo conectar con el servidor.").then(function(){window.ModalButtons&&window.ModalButtons.Habilitar(null,".btn-ver-orden, .btn-editar-orden, #accionesBatch button")})};i.send(JSON.stringify({IdsOrdenes:r,NuevoEstado:t}))},ExportarSeleccionadas:function(){var t=this.ObtenerFilasSeleccionadas(),n,i;if(t.length===0){window.Orders.Utilidades.MostrarError("Error","No hay órdenes seleccionadas.");return}if(n=document.getElementById("ordersGrid"),!n||!n.ej2_instances||!n.ej2_instances[0]){window.Orders.Utilidades.MostrarError("Error","Grid no encontrado.");return}i=n.ej2_instances[0];try{i.excelExport({fileName:"OrdenesSeleccionadas_"+(new Date).toISOString().split("T")[0]+".xlsx",dataSource:t.map(function(n){return n.data}),complete:function(){window.Orders.Utilidades.MostrarExito("Exportación Exitosa","Se exportaron "+t.length+" órdenes correctamente.")},failure:function(){window.Orders.Utilidades.MostrarError("Error de Exportación","No se pudo exportar a Excel.")}})}catch(r){window.Orders.Utilidades.MostrarError("Error de Exportación","Error al exportar: "+r.message);console.error("Error al exportar:",r)}},DeseleccionarTodas:function(){var n=document.getElementById("ordersGrid"),t;n&&n.ej2_instances&&n.ej2_instances[0]&&(t=n.ej2_instances[0],t.clearSelection(),this.ActualizarContador())}};window.Orders.Facturacion={CargarItemsFactura:function(n){var i=document.getElementById("gridItemsModalOrden"),t;if(!i){console.warn("Grid de items no encontrado");return}t=new XMLHttpRequest;t.open("POST","/Orders/ObtenerItemsFactura",!0);t.setRequestHeader("Content-Type","application/json");t.onreadystatechange=function(){var r,u;if(t.readyState===4)if(t.status===200)try{r=JSON.parse(t.responseText);r.exito&&r.datos?(u=i.ej2_instances&&i.ej2_instances[0],u&&(u.dataSource=r.datos,u.refresh())):window.Orders.Facturacion.CargarItemsMock(n)}catch(f){console.error("Error al parsear respuesta de items:",f);window.Orders.Facturacion.CargarItemsMock(n)}else console.warn("Error al cargar items de factura: HTTP "+t.status),window.Orders.Facturacion.CargarItemsMock(n)};t.send(JSON.stringify(n))},CargarItemsMock:function(){var t=document.getElementById("gridItemsFactura"),n;t&&t.ej2_instances&&(n=t.ej2_instances[0],n&&(n.dataSource=[{IdItem:1,IdProducto:101,NombreProducto:"Producto A",Cantidad:2,PrecioUnitario:150,Descuento:10,Subtotal:290,Impuesto:46.4,Total:336.4},{IdItem:2,IdProducto:102,NombreProducto:"Producto B",Cantidad:1,PrecioUnitario:250,Descuento:0,Subtotal:250,Impuesto:40,Total:290},{IdItem:3,IdProducto:103,NombreProducto:"Producto C",Cantidad:3,PrecioUnitario:75.5,Descuento:5,Subtotal:221.5,Impuesto:35.44,Total:256.94}],n.refresh()))},Imprimir:function(){window.print()}}})();