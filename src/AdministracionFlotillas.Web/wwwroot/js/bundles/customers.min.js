function handleCustomerActionButtonsClick(n){var i=n.target.closest(".btn-ver-cliente, .btn-editar-cliente"),t;i&&(t=i.getAttribute("data-id-cliente"),t&&t!=="undefined"&&t!=="null"?(t=parseInt(t,10),t&&!isNaN(t)&&t>0?i.classList.contains("btn-ver-cliente")?window.Customers&&window.Customers.Modal?window.Customers.Modal.Abrir(t,"ver"):console.error("Customers.Modal no está disponible"):i.classList.contains("btn-editar-cliente")&&(window.Customers&&window.Customers.Modal?window.Customers.Modal.Abrir(t,"editar"):console.error("Customers.Modal no está disponible")):console.error("ID de cliente no válido:",t)):console.error("No se pudo obtener ID de cliente del botón. data-id-cliente:",t))}window.customersGridCreated=function(){console.log("Grid de clientes creado, cargando datos...");window.Customers&&window.Customers.Grid&&window.Customers.Grid.CargarDatos()};window.customersGridRowSelected=function(n){console.log("Cliente seleccionado:",n.data)};window.customersGridActionComplete=function(n){n.requestType==="filtering"&&window.Customers&&window.Customers.Dashboard&&window.Customers.Dashboard.ActualizarMetricas()};window.customersGridDataBound=function(){var n=document.getElementById("customersGrid");n&&(n.removeEventListener("click",handleCustomerActionButtonsClick),n.addEventListener("click",handleCustomerActionButtonsClick))};window.customersGridToolbarClick=function(n){var t=document.getElementById("customersGrid"),r,i,u;if(!t||!t.ej2_instances||!t.ej2_instances[0]){console.warn("Grid no encontrado para exportación");return}if(r=t.ej2_instances[0],u="Clientes_"+(new Date).toISOString().split("T")[0],n.item.text==="Excel Export"||n.item.id&&n.item.id.includes("excelexport"))i=r.excelExport({fileName:u+".xlsx"});else if(n.item.text==="Pdf Export"||n.item.id&&n.item.id.includes("pdfexport"))i=r.pdfExport({fileName:u+".pdf"});else return;i&&i.then(function(){window.Customers.Utilidades.MostrarExito("Exportación Exitosa","El archivo se ha descargado correctamente.")}).catch(function(n){window.Customers.Utilidades.MostrarError("Error de Exportación","No se pudo exportar. Por favor, intenta nuevamente.");console.error("Error al exportar:",n)})};window.filtroNombreChange=window.debounce(function(){window.Customers&&window.Customers.Filtros&&window.Customers.Filtros.Aplicar()},300);window.filtroEstadoChange=window.debounce(function(){window.Customers&&window.Customers.Filtros&&window.Customers.Filtros.Aplicar()},300);window.Customers=window.Customers||{};var modalClienteId=null,modalClienteModo="ver";(function(){"use strict";window.Customers.Utilidades={MostrarError:function(n,t){return new Promise(i=>{typeof Swal!="undefined"?Swal.fire({icon:"error",title:n||"Error",text:t||"Ha ocurrido un error.",confirmButtonText:"Aceptar"}).then(()=>i()):(alert(n+": "+t),i())})},MostrarExito:function(n,t){return new Promise(i=>{typeof Swal!="undefined"?Swal.fire({icon:"success",title:n||"Éxito",text:t||"Operación completada.",confirmButtonText:"Aceptar",timer:2e3,showConfirmButton:!1}).then(()=>i()):(alert(n+": "+t),i())})}};window.Customers.Grid={CargarDatos:function(){var i=document.getElementById("customersGrid"),t,n;if(!i){console.warn("Grid element no encontrado");return}if(t=i.ej2_instances&&i.ej2_instances[0],!t){setTimeout(function(){window.Customers.Grid.CargarDatos()},500);return}n=new XMLHttpRequest;n.open("POST","/Customers/ObtenerCustomers",!0);n.setRequestHeader("Content-Type","application/json");n.onreadystatechange=function(){if(n.readyState===4)if(n.status===200)try{var i=JSON.parse(n.responseText);i.exito&&i.datos?(t.dataSource=i.datos,t.refresh(),console.log("Clientes cargados:",i.datos.length)):window.Customers.Utilidades.MostrarError("Error al cargar datos",i.mensaje||"No se pudieron cargar los clientes.")}catch(r){window.Customers.Utilidades.MostrarError("Error","Error al procesar la respuesta del servidor.");console.error("Error al parsear respuesta:",r)}else window.Customers.Utilidades.MostrarError("Error de Conexión","Error al conectar con el servidor."),console.error("Error al cargar clientes:",n.status,n.statusText)};n.send()},Recargar:function(){this.CargarDatos()}};window.Customers.Filtros={Aplicar:function(){var i=document.getElementById("customersGrid"),t,r,n;i&&(t=i.ej2_instances&&i.ej2_instances[0],t)&&(r={Nombre:this.ObtenerNombre(),Estado:this.ObtenerEstado()},n=new XMLHttpRequest,n.open("POST","/Customers/BuscarCustomers",!0),n.setRequestHeader("Content-Type","application/json"),n.onreadystatechange=function(){if(n.readyState===4)if(n.status===200)try{var i=JSON.parse(n.responseText);i.exito?(t.dataSource=i.datos,t.refresh()):window.Customers.Utilidades.MostrarError("Error al aplicar filtros",i.mensaje||"No se pudieron aplicar los filtros.")}catch(r){window.Customers.Utilidades.MostrarError("Error","Error al procesar la respuesta del servidor.");console.error("Error al parsear respuesta:",r)}else window.Customers.Utilidades.MostrarError("Error de Conexión","Error al conectar con el servidor."),console.error("Error al aplicar filtros:",n.status,n.statusText)},n.send(JSON.stringify(r)))},Limpiar:function(){var t=document.getElementById("filtroNombre"),n;t&&t.ej2_instances&&t.ej2_instances[0]&&(t.ej2_instances[0].value="");n=document.getElementById("filtroEstado");n&&n.ej2_instances&&n.ej2_instances[0]&&(n.ej2_instances[0].value=null);window.Customers&&window.Customers.Grid&&window.Customers.Grid.CargarDatos()},ObtenerNombre:function(){var t=document.getElementById("filtroNombre"),n;return t?(n=t.value||"",n&&n.trim()?n.trim():null):null},ObtenerEstado:function(){var n=document.getElementById("filtroEstado");return!n||!n.ej2_instances?null:n.ej2_instances[0]?n.ej2_instances[0].value:null}};window.Customers.Dashboard={ActualizarMetricas:function(){var n=new XMLHttpRequest;n.open("POST","/Customers/ObtenerMetricas",!0);n.setRequestHeader("Content-Type","application/json");n.onreadystatechange=function(){var i,t,r,u;if(n.readyState===4)if(n.status===200)try{if(i=JSON.parse(n.responseText),i.exito&&i.datos){t=i.datos;r=t.totalClientes||0;function n(n,t){var i=document.getElementById(n);i&&(i.textContent=t)}n("totalClientes",r);n("clientesActivos",t.clientesActivos||0);n("clientesInactivos",t.clientesInactivos||0);n("clientesNuevos",t.clientesNuevos||0);u=document.querySelector('[id^="breadcrumb-contador-"]');u&&(u.textContent=r.toString())}}catch(f){console.error("Error al parsear métricas:",f)}else console.error("Error al actualizar métricas de clientes:",n.status,n.statusText)};n.send()}};window.Customers.Modal={Abrir:function(n,t){var i=parseInt(n,10);if(!i||isNaN(i)||i<=0){window.Customers.Utilidades.MostrarError("Error","ID de cliente no válido.");return}modalClienteId=i;modalClienteModo=t||"ver";this.CargarDatosCliente(i)},CargarDatosCliente:function(n){var i=this,t=new XMLHttpRequest;t.open("POST","/Customers/ObtenerCustomerPorId",!0);t.setRequestHeader("Content-Type","application/json");t.onreadystatechange=function(){if(t.readyState===4)if(t.status===200)try{var n=JSON.parse(t.responseText);n.exito&&n.datos?(i.MostrarDatos(n.datos),i.AbrirDialog()):window.Customers.Utilidades.MostrarError("Error",n.mensaje||"No se pudo cargar el cliente.")}catch(r){window.Customers.Utilidades.MostrarError("Error","Error al procesar la respuesta del servidor.");console.error("Error al parsear respuesta:",r)}else window.Customers.Utilidades.MostrarError("Error de Conexión","Error al cargar el cliente."),console.error("Error al cargar cliente:",t.status,t.statusText)};t.send(JSON.stringify(n))},MostrarDatos:function(n){function o(n){return document.getElementById(n)}function t(n,t){var i=o(n);i&&(i.textContent=t)}function i(n,t){var i=o(n);i&&(i.innerHTML=t)}var f,r,u,h;t("modalClienteTitulo",n.IdCliente);t("modalIdCliente",n.IdCliente);t("modalNombreCliente",n.NombreCliente||"-");i("modalEmailCliente",'<i class="fas fa-envelope me-1"><\/i>'+(n.Email||"-"));i("modalTelefonoCliente",'<i class="fas fa-phone me-1"><\/i>'+(n.Telefono||"-"));f="";f=n.EstadoCliente==="ACTIVE"?'<span class="badge bg-success info-tooltip-cliente" data-field="EstadoCliente" data-tooltip="Cliente activo, puede realizar compras y operaciones">'+n.EstadoCliente+"<\/span>":'<span class="badge bg-secondary info-tooltip-cliente" data-field="EstadoCliente" data-tooltip="Cliente inactivo, bloqueado o suspendido">'+(n.EstadoCliente||"INACTIVE")+"<\/span>";i("modalEstadoCliente",f);t("modalDireccionCliente",n.Direccion||"-");t("modalCiudadCliente",n.Ciudad||"-");t("modalEstadoDireccionCliente",n.Estado||"-");t("modalCodigoPostalCliente",n.CodigoPostal||"-");t("modalPaisCliente",n.Pais||"-");var e=n.LimiteCredito||0,s=n.TotalCompras||0,c=n.TotalOrdenes||0;i("modalLimiteCredito",'<i class="fas fa-credit-card me-1"><\/i>$'+e.toFixed(2));i("modalTotalOrdenes",'<i class="fas fa-shopping-cart me-1"><\/i>'+c);i("modalTotalCompras",'<i class="fas fa-dollar-sign me-1"><\/i>$'+s.toFixed(2));r=document.getElementById("progressBarLimiteCredito");r&&r.ej2_instances&&r.ej2_instances[0]&&(u=e>0?Math.min(s/e*100,100):0,h=u>80?"#dc3545":u>50?"#ffc107":"#0d6efd",r.ej2_instances[0].value=u,r.ej2_instances[0].progressColor=h,r.ej2_instances[0].dataBind());n.FechaRegistro?i("modalFechaRegistro",'<i class="fas fa-calendar-alt me-1"><\/i>'+new Date(n.FechaRegistro).toLocaleDateString("es-MX")):t("modalFechaRegistro","-");setTimeout(function(){window.Customers.Modal.ActualizarGraficaActividad(n)},300)},ActualizarGraficaActividad:function(n){var t=document.getElementById("chartActividadCliente"),i;if(t){var r=n.TotalOrdenes||0,u=n.TotalCompras||0,f=n.LimiteCredito||0;t.ej2_instances&&t.ej2_instances[0]&&t.ej2_instances[0].destroy();i=new ej.charts.Chart({primaryXAxis:{valueType:"Category"},primaryYAxis:{title:"Valor"},series:[{type:"Column",dataSource:[{concepto:"Órdenes",valor:r},{concepto:"Compras ($)",valor:u/1e3},{concepto:"Límite ($)",valor:f/1e3}],xName:"concepto",yName:"valor",name:"Actividad",marker:{dataLabel:{visible:!0,position:"Top"}}}],tooltip:{enable:!0},legendSettings:{visible:!1},height:"200px",width:"100%"});i.appendTo("#chartActividadCliente")}},AbrirDialog:function(){function u(){if(typeof modalClienteInstance!="undefined"&&window.modalClienteInstance!==null)return window.modalClienteInstance;var n=document.getElementById("modalCliente");return n&&n.ej2_instances&&n.ej2_instances[0]?n.ej2_instances[0]:null}function i(){n++;var f=u();if(f)try{f.show();console.log("✅ Modal abierto correctamente después de "+n+" intentos");window.modalClienteInstance=f;setTimeout(function(){var n=document.getElementById("tooltipModalCliente");n&&n.ej2_instances&&n.ej2_instances[0]&&typeof tooltipModalClienteObj!="undefined"&&(tooltipModalClienteObj=n.ej2_instances[0])},100);return}catch(e){console.error("❌ Error al abrir modal:",e);window.Customers.Utilidades.MostrarError("Error","No se pudo abrir el modal: "+e.message);return}n<t?(n%10==0&&console.log("⏳ Esperando inicialización del modal... Intento "+n+"/"+t),setTimeout(i,r)):(console.error("❌ Modal no inicializado después de "+t+" intentos"),window.Customers.Utilidades.MostrarError("Error","El modal no está disponible. Por favor, recarga la página."))}if(typeof mostrarModalCliente=="function"&&window.mostrarModalCliente()){console.log("✅ Modal abierto usando función helper");setTimeout(function(){var n=document.getElementById("tooltipModalCliente");n&&n.ej2_instances&&n.ej2_instances[0]&&typeof tooltipModalClienteObj!="undefined"&&(tooltipModalClienteObj=n.ej2_instances[0])},100);return}var f=this,n=0,t=50,r=100;setTimeout(i,50)},CambiarAModoEdicion:function(n){if(!n||n<=0){window.Customers.Utilidades.MostrarError("Error","ID de cliente no válido.");return}modalClienteId=n;modalClienteModo="editar";this.ActivarModoEdicion()},ActivarModoEdicion:function(){this.ConvertirCamposAEditables();this.ActualizarBotonesModal();var n=document.getElementById("modalClienteTitulo");n&&(n.textContent=modalClienteId+" (Editando)")},DesactivarModoEdicion:function(){this.ConvertirCamposASoloLectura();this.RestaurarBotonesModal();var n=document.getElementById("modalClienteTitulo");n&&(n.textContent=modalClienteId);modalClienteModo="ver"},ConvertirCamposAEditables:function(){var s=document.getElementById("modalEstadoCliente"),h,n,c,t,l,i,a,r,v,u,y,f,p,e,w,o,b;s&&(h=s.textContent.trim(),s.innerHTML='<select id="editEstadoCliente" class="form-select form-select-sm"><option value="ACTIVE"'+(h==="ACTIVE"?" selected":"")+'>ACTIVE<\/option><option value="INACTIVE"'+(h==="INACTIVE"?" selected":"")+">INACTIVE<\/option><\/select>");n=document.getElementById("modalEmailCliente");n&&(c=n.textContent.trim(),n.innerHTML='<input type="email" id="editEmailCliente" class="form-control form-control-sm" value="'+c+'">');t=document.getElementById("modalTelefonoCliente");t&&(l=t.textContent.trim(),t.innerHTML='<input type="tel" id="editTelefonoCliente" class="form-control form-control-sm" value="'+l+'">');i=document.getElementById("modalDireccionCliente");i&&(a=i.textContent.trim(),i.innerHTML='<input type="text" id="editDireccionCliente" class="form-control form-control-sm" value="'+a+'">');r=document.getElementById("modalCiudadCliente");r&&(v=r.textContent.trim(),r.innerHTML='<input type="text" id="editCiudadCliente" class="form-control form-control-sm" value="'+v+'">');u=document.getElementById("modalEstadoDireccionCliente");u&&(y=u.textContent.trim(),u.innerHTML='<input type="text" id="editEstadoDireccionCliente" class="form-control form-control-sm" value="'+y+'">');f=document.getElementById("modalCodigoPostalCliente");f&&(p=f.textContent.trim(),f.innerHTML='<input type="text" id="editCodigoPostalCliente" class="form-control form-control-sm" value="'+p+'">');e=document.getElementById("modalPaisCliente");e&&(w=e.textContent.trim(),e.innerHTML='<input type="text" id="editPaisCliente" class="form-control form-control-sm" value="'+w+'">');o=document.getElementById("modalLimiteCredito");o&&(b=o.textContent.replace("$","").replace(",","").trim(),o.innerHTML='<input type="number" id="editLimiteCredito" class="form-control form-control-sm" step="0.01" min="0" value="'+b+'">')},ConvertirCamposASoloLectura:function(){var d=document.getElementById("modalEstadoCliente"),t,n,i,r,u,f,e,o,s,h,c,l,a,v,y,p,w,b,k,g;d&&(t=document.getElementById("editEstadoCliente"),t&&(n=t.value,i="",i=n==="ACTIVE"?'<span class="badge bg-success info-tooltip-cliente" data-field="EstadoCliente" data-tooltip="Cliente activo, puede realizar compras y operaciones">'+n+"<\/span>":'<span class="badge bg-secondary info-tooltip-cliente" data-field="EstadoCliente" data-tooltip="Cliente inactivo, bloqueado o suspendido">'+n+"<\/span>",d.innerHTML=i));r=document.getElementById("modalEmailCliente");r&&(u=document.getElementById("editEmailCliente"),u&&(r.textContent=u.value||"-"));f=document.getElementById("modalTelefonoCliente");f&&(e=document.getElementById("editTelefonoCliente"),e&&(f.textContent=e.value||"-"));o=document.getElementById("modalDireccionCliente");o&&(s=document.getElementById("editDireccionCliente"),s&&(o.textContent=s.value||"-"));h=document.getElementById("modalCiudadCliente");h&&(c=document.getElementById("editCiudadCliente"),c&&(h.textContent=c.value||"-"));l=document.getElementById("modalEstadoDireccionCliente");l&&(a=document.getElementById("editEstadoDireccionCliente"),a&&(l.textContent=a.value||"-"));v=document.getElementById("modalCodigoPostalCliente");v&&(y=document.getElementById("editCodigoPostalCliente"),y&&(v.textContent=y.value||"-"));p=document.getElementById("modalPaisCliente");p&&(w=document.getElementById("editPaisCliente"),w&&(p.textContent=w.value||"-"));b=document.getElementById("modalLimiteCredito");b&&(k=document.getElementById("editLimiteCredito"),k&&(g=parseFloat(k.value)||0,b.textContent="$"+g.toFixed(2)))},ActualizarBotonesModal:function(){var i=document.getElementById("btnModalEditar"),r=document.getElementById("btnModalCerrar"),n,t;i&&i.classList.add("d-none");r&&r.classList.add("d-none");n=document.getElementById("btnModalGuardar");t=document.getElementById("btnModalCancelar");n&&n.classList.remove("d-none");t&&t.classList.remove("d-none")},RestaurarBotonesModal:function(){var i=document.getElementById("btnModalGuardar"),r=document.getElementById("btnModalCancelar"),n,t;i&&i.classList.add("d-none");r&&r.classList.add("d-none");n=document.getElementById("btnModalEditar");t=document.getElementById("btnModalCerrar");n&&n.classList.remove("d-none");t&&t.classList.remove("d-none")},GuardarCambios:function(){var a,n;if(!modalClienteId||modalClienteId<=0){window.Customers.Utilidades.MostrarError("Error","No hay cliente seleccionado para guardar.");return}var r=document.getElementById("editEstadoCliente"),u=document.getElementById("editEmailCliente"),f=document.getElementById("editTelefonoCliente"),e=document.getElementById("editDireccionCliente"),o=document.getElementById("editCiudadCliente"),s=document.getElementById("editEstadoDireccionCliente"),h=document.getElementById("editCodigoPostalCliente"),c=document.getElementById("editPaisCliente"),l=document.getElementById("editLimiteCredito"),v=r?r.value:null,t=u?u.value.trim():null,y=f?f.value.trim():null,p=e?e.value.trim():null,w=o?o.value.trim():null,b=s?s.value.trim():null,k=h?h.value.trim():null,d=c?c.value.trim():null,i=l?parseFloat(l.value):null;if(t&&!t.includes("@")){window.Customers.Utilidades.MostrarError("Error","El formato de email no es válido.");return}if(i!==null&&i<0){window.Customers.Utilidades.MostrarError("Error","El límite de crédito no puede ser negativo.");return}window.ModalButtons.Deshabilitar("modalCliente","#customersGrid .e-gridcontent .e-rowcell .btn");a={IdCliente:modalClienteId,EstadoCliente:v,Email:t,Telefono:y,Direccion:p,Ciudad:w,Estado:b,CodigoPostal:k,Pais:d,LimiteCredito:i};n=new XMLHttpRequest;n.open("POST","/Customers/ActualizarCustomer",!0);n.setRequestHeader("Content-Type","application/json");n.onreadystatechange=function(){var t,i;if(n.readyState===4)if(n.status===200)try{t=JSON.parse(n.responseText);t.exito?window.Customers.Utilidades.MostrarExito("Cliente actualizado","Los cambios se guardaron correctamente.").then(function(){window.Customers&&window.Customers.Modal&&(window.Customers.Modal.DesactivarModoEdicion(),window.Customers.Modal.CargarDatosCliente(modalClienteId),window.Customers&&window.Customers.Grid&&window.Customers.Grid.Recargar());window.ModalButtons.Habilitar("modalCliente","#customersGrid .e-gridcontent .e-rowcell .btn")}):window.Customers.Utilidades.MostrarError("Error al guardar",t.mensaje||"No se pudieron guardar los cambios.").then(function(){window.ModalButtons.Habilitar("modalCliente","#customersGrid .e-gridcontent .e-rowcell .btn")})}catch(r){console.error("Error al parsear respuesta:",r);window.Customers.Utilidades.MostrarError("Error","Error al procesar la respuesta del servidor.").then(function(){window.ModalButtons.Habilitar("modalCliente","#customersGrid .e-gridcontent .e-rowcell .btn")})}else i="Error HTTP: "+n.status+" - "+n.statusText,window.Customers.Utilidades.MostrarError("Error de Conexión",i).then(function(){window.ModalButtons.Habilitar("modalCliente","#customersGrid .e-gridcontent .e-rowcell .btn")}),console.error("Error al guardar cliente:",i)};n.onerror=function(){window.Customers.Utilidades.MostrarError("Error de Conexión","No se pudo conectar con el servidor.").then(function(){window.ModalButtons.Habilitar("modalCliente","#customersGrid .e-gridcontent .e-rowcell .btn")})};n.send(JSON.stringify(a))},CancelarEdicion:function(){modalClienteId&&this.CargarDatosCliente(modalClienteId);this.DesactivarModoEdicion()}};window.Customers.Detalles={Ver:function(n){window.Customers.Modal.Abrir(n,"ver")}};window.Customers.Edicion={Editar:function(n){window.Customers.Modal.Abrir(n,"editar")}}})();