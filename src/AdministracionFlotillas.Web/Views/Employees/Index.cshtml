@{
    ViewData["Title"] = "Employees";
}

<div>
    <!-- Breadcrumb Navigation -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a asp-controller="Home" asp-action="Index">Home</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">Employees</li>
        </ol>
    </nav>
    
    <!-- Título y Descripción -->
    <div class="mb-5">
        <h2>Employees</h2>
        <p class="text-muted">Gestión de empleados de la empresa</p>
    </div>
    
    <!-- Vista parcial del grid -->
    @await Html.PartialAsync("_EmployeesGrid")
</div>

<!-- Modal para Enviar por Email -->
<div class="modal fade" id="modalEnviarEmail" tabindex="-1" aria-labelledby="modalEnviarEmailLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEnviarEmailLabel">
                    <i class="fas fa-envelope"></i> Enviar Información por Email
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="emailReceptor" class="form-label">Email del Receptor</label>
                    <input type="email" class="form-control" id="emailReceptor" placeholder="ejemplo@empresa.com" required>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>Nombre Completo</th>
                                <th>Email</th>
                                <th>Teléfono</th>
                                <th>Fecha Contratación</th>
                                <th>Salario</th>
                                <th>Departamento</th>
                            </tr>
                        </thead>
                        <tbody id="tablaResumenEmpleados">
                            <!-- Se llena dinámicamente con los empleados seleccionados -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnConfirmarEnvio">
                    <i class="fas fa-paper-plane"></i> Enviar Email
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/employees.js"></script>
    <script>
        $(document).ready(function() {
            var empleadosSeleccionados = [];
            var fechaContratacionBase = null;
            
            var tabla = $('#employeesTable').DataTable({
                processing: true,
                serverSide: false,
                ajax: {
                    url: '/Employees/ObtenerEmployees',
                    type: 'POST',
                    dataType: 'json',
                    dataSrc: function(respuesta) {
                        if (respuesta.exito) {
                            return respuesta.datos;
                        } else {
                            mostrarMensaje('error', respuesta.mensaje || 'Error al cargar datos');
                            return [];
                        }
                    },
                    error: function(xhr, error, thrown) {
                        mostrarMensaje('error', 'Error al cargar los empleados: ' + thrown);
                    }
                },
                columns: [
                    {
                        data: null,
                        name: 'Seleccionar',
                        width: '3%',
                        orderable: false,
                        searchable: false,
                        render: function(data, type, row) {
                            return '<input type="checkbox" class="checkbox-empleado" data-id="' + row.idEmpleado + '" data-fecha="' + row.fechaContratacion + '" data-nombre="' + (row.nombreCompleto || row.primerNombre + ' ' + row.apellido) + '">';
                        }
                    },
                    { 
                        data: 'nombreCompleto', 
                        name: 'NombreCompleto', 
                        width: '20%',
                        render: function(data, type, row) {
                            return data || (row.primerNombre + ' ' + row.apellido);
                        }
                    },
                    { data: 'correoElectronico', name: 'CorreoElectronico', width: '15%' },
                    { data: 'numeroTelefono', name: 'NumeroTelefono', width: '12%' },
                    { data: 'fechaContratacion', name: 'FechaContratacion', width: '12%' },
                    { 
                        data: 'salario', 
                        name: 'Salario', 
                        width: '12%',
                        render: function(data, type, row) {
                            return data || '-';
                        }
                    },
                    { 
                        data: 'idDepartamento', 
                        name: 'IdDepartamento', 
                        width: '10%',
                        render: function(data, type, row) {
                            return data ? 'Dept. ' + data : '-';
                        }
                    },
                    {
                        data: null,
                        name: 'Acciones',
                        width: '12%',
                        orderable: false,
                        searchable: false,
                        render: function(data, type, row) {
                            return '<button type="button" class="btn btn-outline-info btn-sm btn-ver" data-id="' + row.idEmpleado + '" data-bs-toggle="tooltip" data-bs-placement="top" title="Ver Detalles del Empleado" aria-label="Ver Detalles"><i class="fas fa-eye" aria-hidden="true"></i></button>';
                        }
                    }
                ],
                order: [[1, 'asc']], // Ordenar por Nombre Completo (columna 1, ya que 0 es checkbox)
                pageLength: 10,
                lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Todos"]],
                language: {
                    "decimal": "",
                    "emptyTable": "No hay datos disponibles en la tabla",
                    "info": "Mostrando _START_ a _END_ de _TOTAL_ registros",
                    "infoEmpty": "Mostrando 0 a 0 de 0 registros",
                    "infoFiltered": "(filtrado de _MAX_ registros totales)",
                    "infoPostFix": "",
                    "thousands": ",",
                    "lengthMenu": "Mostrar _MENU_ registros",
                    "loadingRecords": "Cargando...",
                    "processing": "Procesando...",
                    "search": "Buscar:",
                    "zeroRecords": "No se encontraron registros coincidentes",
                    "paginate": {
                        "first": "Primero",
                        "last": "Último",
                        "next": "Siguiente",
                        "previous": "Anterior"
                    },
                    "aria": {
                        "sortAscending": ": activar para ordenar columna ascendente",
                        "sortDescending": ": activar para ordenar columna descendente"
                    }
                },
                dom: 'Brtip',
                buttons: [
                    {
                        text: '<i class="fas fa-sync-alt" aria-hidden="true"></i>',
                        action: function(e, dt, node, config) {
                            dt.ajax.reload();
                        },
                        className: 'btn btn-sm',
                        titleAttr: 'Actualizar tabla de empleados'
                    },
                    {
                        extend: 'excel',
                        text: '<i class="fas fa-file-excel" aria-hidden="true"></i>',
                        className: 'btn btn-sm',
                        exportOptions: {
                            columns: [1, 2, 3, 4, 5, 6] // Excluir checkbox (0) y acciones (7)
                        },
                        titleAttr: 'Exportar datos a Excel'
                    },
                    {
                        extend: 'pdf',
                        text: '<i class="fas fa-file-pdf" aria-hidden="true"></i>',
                        className: 'btn btn-sm',
                        exportOptions: {
                            columns: [1, 2, 3, 4, 5, 6] // Excluir checkbox (0) y acciones (7)
                        },
                        titleAttr: 'Exportar datos a PDF'
                    },
                    {
                        extend: 'print',
                        text: '<i class="fas fa-print" aria-hidden="true"></i>',
                        className: 'btn btn-sm',
                        titleAttr: 'Imprimir tabla de empleados'
                    },
                    {
                        text: '<i class="fas fa-envelope" aria-hidden="true"></i> Enviar por Email',
                        action: function(e, dt, node, config) {
                            AbrirModalEnviarEmail();
                        },
                        className: 'btn btn-sm btn-enviar-email',
                        titleAttr: 'Enviar información de empleados seleccionados por email'
                    }
                ],
                responsive: true,
                initComplete: function() {
                    // Inicializar tooltips de Bootstrap para botones de DataTables después de la inicialización
                    setTimeout(function() {
                        $('.dt-buttons .btn').each(function() {
                            var boton = $(this);
                            var tituloAtributo = boton.attr('title') || boton.data('title-attr');
                            if (tituloAtributo && !boton.attr('data-bs-toggle')) {
                                boton.attr('data-bs-toggle', 'tooltip');
                                boton.attr('data-bs-placement', 'top');
                                boton.attr('title', tituloAtributo);
                                new bootstrap.Tooltip(boton[0]);
                            }
                        });
                    }, 100);
                }
            });

            // Guardar referencia global de la tabla
            window.tablaEmpleados = tabla;
            window.empleadosSeleccionados = empleadosSeleccionados;
            window.fechaContratacionBase = fechaContratacionBase;

            // Inicializar tooltips de Bootstrap para botones de DataTables
            setTimeout(function() {
                $('.dt-buttons .btn').each(function() {
                    var boton = $(this);
                    var tituloAtributo = boton.attr('title') || boton.data('title-attr');
                    if (tituloAtributo && !boton.attr('data-bs-toggle')) {
                        boton.attr('data-bs-toggle', 'tooltip');
                        boton.attr('data-bs-placement', 'top');
                        boton.attr('title', tituloAtributo);
                        new bootstrap.Tooltip(boton[0]);
                    }
                });
            }, 200);

            // Inicializar tooltips de Bootstrap para otros elementos
            var listaDesencadenadoresTooltip = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var listaTooltips = listaDesencadenadoresTooltip.map(function (elementoDesencadenador) {
                return new bootstrap.Tooltip(elementoDesencadenador);
            });

            // Configurar jQuery UI Datepicker en español
            if (typeof $.datepicker !== 'undefined') {
                $.datepicker.regional['es'] = {
                    closeText: 'Cerrar',
                    prevText: '&#x3C;Ant',
                    nextText: 'Sig&#x3E;',
                    currentText: 'Hoy',
                    monthNames: ['Enero','Febrero','Marzo','Abril','Mayo','Junio',
                        'Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'],
                    monthNamesShort: ['Ene','Feb','Mar','Abr','May','Jun',
                        'Jul','Ago','Sep','Oct','Nov','Dic'],
                    dayNames: ['Domingo','Lunes','Martes','Miércoles','Jueves','Viernes','Sábado'],
                    dayNamesShort: ['Dom','Lun','Mar','Mié','Jue','Vie','Sáb'],
                    dayNamesMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá'],
                    weekHeader: 'Sm',
                    dateFormat: 'dd/mm/yy',
                    firstDay: 1,
                    isRTL: false,
                    showMonthAfterYear: false,
                    yearSuffix: ''
                };
                $.datepicker.setDefaults($.datepicker.regional['es']);

                // Inicializar Date Pickers para Fecha de Contratación (rango)
                var filtroFechaInicio = $('#filtroFechaInicio');
                var filtroFechaFin = $('#filtroFechaFin');
                
                if (filtroFechaInicio.length > 0) {
                    filtroFechaInicio.datepicker({
                        dateFormat: 'dd/mm/yy',
                        changeMonth: true,
                        changeYear: true,
                        showButtonPanel: true,
                        onSelect: function(selectedDate) {
                            if (filtroFechaFin.length > 0) {
                                filtroFechaFin.datepicker('option', 'minDate', selectedDate);
                            }
                            AplicarFiltros();
                        }
                    });
                }

                if (filtroFechaFin.length > 0) {
                    filtroFechaFin.datepicker({
                        dateFormat: 'dd/mm/yy',
                        changeMonth: true,
                        changeYear: true,
                        showButtonPanel: true,
                        onSelect: function(selectedDate) {
                            if (filtroFechaInicio.length > 0) {
                                filtroFechaInicio.datepicker('option', 'maxDate', selectedDate);
                            }
                            AplicarFiltros();
                        }
                    });
                }
            }

            // Inicializar formato de moneda para inputs de salario
            if (typeof $.fn.inputmask !== 'undefined') {
                var filtroSalarioMin = $('#filtroSalarioMin');
                var filtroSalarioMax = $('#filtroSalarioMax');
                
                if (filtroSalarioMin.length > 0) {
                    filtroSalarioMin.inputmask({
                        alias: 'numeric',
                        groupSeparator: ',',
                        autoGroup: true,
                        digits: 2,
                        digitsOptional: false,
                        prefix: '$ ',
                        placeholder: '0',
                        rightAlign: false,
                        oncomplete: function() {
                            AplicarFiltros();
                        },
                        oncleared: function() {
                            AplicarFiltros();
                        }
                    });
                }
                
                if (filtroSalarioMax.length > 0) {
                    filtroSalarioMax.inputmask({
                        alias: 'numeric',
                        groupSeparator: ',',
                        autoGroup: true,
                        digits: 2,
                        digitsOptional: false,
                        prefix: '$ ',
                        placeholder: '0',
                        rightAlign: false,
                        oncomplete: function() {
                            AplicarFiltros();
                        },
                        oncleared: function() {
                            AplicarFiltros();
                        }
                    });
                }
            }

            // Filtro de búsqueda por nombre (solo columna de nombre - columna 1, ya que 0 es checkbox)
            $('#filtroBusqueda').on('keyup', function() {
                tabla.column(1).search(this.value).draw();
            });

            // Filtros de departamento, email y teléfono
            $('#filtroDepartamento').on('keyup', function() {
                AplicarFiltros();
            });

            $('#filtroEmail').on('keyup', function() {
                AplicarFiltros();
            });

            $('#filtroTelefono').on('keyup', function() {
                AplicarFiltros();
            });

            // Filtros de salario
            $('#filtroSalarioMin, #filtroSalarioMax').on('keyup change', function() {
                AplicarFiltros();
            });

            // Variable para almacenar la función de filtro personalizado
            var filtroPersonalizado = null;

            // Función para aplicar todos los filtros personalizados
            function AplicarFiltros() {
                // Remover filtro anterior si existe
                if (filtroPersonalizado !== null) {
                    $.fn.dataTable.ext.search.pop();
                }
                
                // Crear nuevo filtro
                filtroPersonalizado = function(settings, data, dataIndex) {
                        var fechaInicio = null;
                        var fechaFin = null;
                        var salarioMin = null;
                        var salarioMax = null;
                        var textoFiltroDepartamento = $('#filtroDepartamento').val().toLowerCase();
                        var textoFiltroEmail = $('#filtroEmail').val().toLowerCase();
                        var textoFiltroTelefono = $('#filtroTelefono').val().toLowerCase();

                        // Filtro de fecha de contratación (rango)
                        var textoFechaInicio = $('#filtroFechaInicio').val();
                        var textoFechaFin = $('#filtroFechaFin').val();
                        
                        if (textoFechaInicio) {
                            var partesFechaInicio = textoFechaInicio.split('/');
                            if (partesFechaInicio.length === 3) {
                                fechaInicio = new Date(partesFechaInicio[2], partesFechaInicio[1] - 1, partesFechaInicio[0]);
                            }
                        }
                        
                        if (textoFechaFin) {
                            var partesFechaFin = textoFechaFin.split('/');
                            if (partesFechaFin.length === 3) {
                                fechaFin = new Date(partesFechaFin[2], partesFechaFin[1] - 1, partesFechaFin[0]);
                                fechaFin.setHours(23, 59, 59, 999);
                            }
                        }

                        // Filtro de salario
                        var textoSalarioMin = $('#filtroSalarioMin').val();
                        var textoSalarioMax = $('#filtroSalarioMax').val();
                        
                        if (textoSalarioMin) {
                            salarioMin = parseFloat(textoSalarioMin.replace(/[^0-9.-]+/g, ''));
                        }
                        if (textoSalarioMax) {
                            salarioMax = parseFloat(textoSalarioMax.replace(/[^0-9.-]+/g, ''));
                        }

                        // Obtener datos de la fila
                        var indiceFila = dataIndex;
                        var fila = tabla.row(indiceFila);
                        var datosFila = fila.data();
                        
                        if (!datosFila) return true;

                        // Validar fecha de contratación (rango)
                        if (fechaInicio !== null || fechaFin !== null) {
                            var textoFechaContratacion = datosFila.fechaContratacion;
                            if (textoFechaContratacion) {
                                var partesFechaContratacion = textoFechaContratacion.split('/');
                                if (partesFechaContratacion.length === 3) {
                                    var fechaEmpleado = new Date(partesFechaContratacion[2], partesFechaContratacion[1] - 1, partesFechaContratacion[0]);
                                    
                                    if (fechaInicio !== null && fechaEmpleado < fechaInicio) {
                                        return false;
                                    }
                                    if (fechaFin !== null && fechaEmpleado > fechaFin) {
                                        return false;
                                    }
                                }
                            } else {
                                return false;
                            }
                        }

                        // Validar rango de salario
                        if (salarioMin !== null || salarioMax !== null) {
                            var textoSalario = datosFila.salario;
                            if (textoSalario && textoSalario !== '-') {
                                var salarioNumerico = parseFloat(textoSalario.replace(/[^0-9.-]+/g, ''));
                                if (isNaN(salarioNumerico)) return false;
                                
                                if (salarioMin !== null && salarioNumerico < salarioMin) {
                                    return false;
                                }
                                if (salarioMax !== null && salarioNumerico > salarioMax) {
                                    return false;
                                }
                            } else {
                                return false;
                            }
                        }

                        // Validar filtro de departamento
                        if (textoFiltroDepartamento) {
                            var textoDepartamento = (datosFila.idDepartamento ? 'Dept. ' + datosFila.idDepartamento : '').toLowerCase();
                            if (textoDepartamento.indexOf(textoFiltroDepartamento) === -1) {
                                return false;
                            }
                        }

                        // Validar filtro de email
                        if (textoFiltroEmail) {
                            var textoEmail = (datosFila.correoElectronico || '').toLowerCase();
                            if (textoEmail.indexOf(textoFiltroEmail) === -1) {
                                return false;
                            }
                        }

                        // Validar filtro de teléfono
                        if (textoFiltroTelefono) {
                            var textoTelefono = (datosFila.numeroTelefono || '').toLowerCase();
                            if (textoTelefono.indexOf(textoFiltroTelefono) === -1) {
                                return false;
                            }
                        }

                        return true;
                    };
                
                // Agregar el nuevo filtro
                $.fn.dataTable.ext.search.push(filtroPersonalizado);
                
                tabla.draw();
            }


            // Checkbox individual
            $('#employeesTable tbody').on('change', '.checkbox-empleado', function() {
                var checkboxEmpleado = $(this);
                var fechaContratacionEmpleado = checkboxEmpleado.data('fecha');
                
                if (checkboxEmpleado.prop('checked')) {
                    if (fechaContratacionBase === null) {
                        fechaContratacionBase = fechaContratacionEmpleado;
                        AgregarEmpleadoSeleccionado(checkboxEmpleado);
                    } else if (fechaContratacionEmpleado === fechaContratacionBase) {
                        AgregarEmpleadoSeleccionado(checkboxEmpleado);
                    } else {
                        checkboxEmpleado.prop('checked', false);
                        Swal.fire({
                            icon: 'warning',
                            title: 'Fecha de Contratación Diferente',
                            text: 'Solo se pueden seleccionar empleados con la misma fecha de contratación. La fecha base es: ' + fechaContratacionBase,
                            confirmButtonText: 'Entendido'
                        });
                    }
                } else {
                    RemoverEmpleadoSeleccionado(checkboxEmpleado);
                    if (empleadosSeleccionados.length === 0) {
                        fechaContratacionBase = null;
                    }
                }
            });

            // Event listeners para botones de acción
            $('#employeesTable tbody').on('click', '.btn-ver', function() {
                var idEmpleadoSeleccionado = $(this).data('id');
                VerDetallesEmpleado(idEmpleadoSeleccionado);
            });
            
            // Reinicializar tooltips después de cargar datos en la tabla
            tabla.on('draw', function() {
                // Reinicializar tooltips de botones de DataTables
                $('.dt-buttons .btn').each(function() {
                    var boton = $(this);
                    var tooltipExistente = bootstrap.Tooltip.getInstance(boton[0]);
                    if (tooltipExistente) {
                        tooltipExistente.dispose();
                    }
                    var tituloAtributo = boton.attr('title') || boton.data('title-attr');
                    if (tituloAtributo) {
                        boton.attr('data-bs-toggle', 'tooltip');
                        boton.attr('data-bs-placement', 'top');
                        boton.attr('title', tituloAtributo);
                        new bootstrap.Tooltip(boton[0]);
                    }
                });
                
                // Reinicializar otros tooltips
                var listaDesencadenadoresTooltip = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]:not(.dt-buttons .btn)'));
                var listaTooltips = listaDesencadenadoresTooltip.map(function (elementoDesencadenador) {
                    var tooltipExistente = bootstrap.Tooltip.getInstance(elementoDesencadenador);
                    if (tooltipExistente) {
                        tooltipExistente.dispose();
                    }
                    return new bootstrap.Tooltip(elementoDesencadenador);
                });
                
                // Restaurar checkboxes seleccionados
                empleadosSeleccionados.forEach(function(empleado) {
                    $('.checkbox-empleado[data-id="' + empleado.id + '"]').prop('checked', true);
                });
            });

            function AgregarEmpleadoSeleccionado(checkbox) {
                var idEmpleado = checkbox.data('id');
                var nombreEmpleado = checkbox.data('nombre');
                var fechaContratacion = checkbox.data('fecha');
                
                if (!empleadosSeleccionados.find(e => e.id === idEmpleado)) {
                    empleadosSeleccionados.push({
                        id: idEmpleado,
                        nombre: nombreEmpleado,
                        fecha: fechaContratacion
                    });
                }
            }

            function RemoverEmpleadoSeleccionado(checkbox) {
                var idEmpleado = checkbox.data('id');
                empleadosSeleccionados = empleadosSeleccionados.filter(e => e.id !== idEmpleado);
            }

            function AbrirModalEnviarEmail() {
                if (empleadosSeleccionados.length === 0) {
                    Swal.fire({
                        icon: 'info',
                        title: 'Selección Requerida',
                        html: 'Debe seleccionar al menos un elemento de la tabla para enviar por email.<br><br>' +
                              '<i class="fas fa-info-circle"></i> Use los checkboxes en la primera columna para seleccionar empleados.',
                        confirmButtonText: 'Entendido'
                    });
                    return;
                }

                // Obtener datos completos de empleados seleccionados
                var datosCompletos = [];
                tabla.rows().every(function() {
                    var datosEmpleado = this.data();
                    if (empleadosSeleccionados.find(e => e.id === datosEmpleado.idEmpleado)) {
                        datosCompletos.push(datosEmpleado);
                    }
                });

                // Llenar tabla resumen
                var cuerpoTabla = $('#tablaResumenEmpleados');
                cuerpoTabla.empty();
                datosCompletos.forEach(function(empleado) {
                    var fila = '<tr>' +
                        '<td>' + (empleado.nombreCompleto || empleado.primerNombre + ' ' + empleado.apellido) + '</td>' +
                        '<td>' + empleado.correoElectronico + '</td>' +
                        '<td>' + (empleado.numeroTelefono || '-') + '</td>' +
                        '<td>' + empleado.fechaContratacion + '</td>' +
                        '<td>' + (empleado.salario || '-') + '</td>' +
                        '<td>' + (empleado.idDepartamento ? 'Dept. ' + empleado.idDepartamento : '-') + '</td>' +
                        '</tr>';
                    cuerpoTabla.append(fila);
                });

                // Limpiar email
                $('#emailReceptor').val('');

                // Mostrar modal
                var modal = new bootstrap.Modal(document.getElementById('modalEnviarEmail'));
                modal.show();
            }

            // Función para validar email
            function ValidarEmail(email) {
                if (!email || email.trim().length === 0) {
                    return {
                        valido: false,
                        mensaje: 'El campo de email no puede estar vacío'
                    };
                }
                
                var emailRecortado = email.trim();
                var arroba = String.fromCharCode(64);
                
                // Validaciones básicas
                if (emailRecortado.length < 5) {
                    return {
                        valido: false,
                        mensaje: 'El email es demasiado corto'
                    };
                }
                
                if (emailRecortado.length > 254) {
                    return {
                        valido: false,
                        mensaje: 'El email es demasiado largo (máximo 254 caracteres)'
                    };
                }
                
                // Verificar que no tenga espacios
                if (emailRecortado.indexOf(' ') !== -1) {
                    return {
                        valido: false,
                        mensaje: 'El email no puede contener espacios'
                    };
                }
                
                // Validar formato básico: debe tener arroba y al menos un punto después del arroba
                var indiceArroba = emailRecortado.indexOf(arroba);
                
                if (indiceArroba <= 0) {
                    return {
                        valido: false,
                        mensaje: 'El email debe contener un símbolo ' + arroba + ' después del nombre de usuario'
                    };
                }
                
                if (indiceArroba === emailRecortado.length - 1) {
                    return {
                        valido: false,
                        mensaje: 'El email debe contener un dominio después del símbolo ' + arroba
                    };
                }
                
                // Verificar que tenga al menos un punto después del arroba
                var parteDominio = emailRecortado.substring(indiceArroba + 1);
                if (parteDominio.indexOf('.') === -1) {
                    return {
                        valido: false,
                        mensaje: 'El dominio del email debe contener al menos un punto (ej: dominio.com)'
                    };
                }
                
                // Verificar que el punto no esté al final
                if (parteDominio.indexOf('.') === parteDominio.length - 1) {
                    return {
                        valido: false,
                        mensaje: 'El dominio del email debe tener una extensión después del punto (ej: .com, .org)'
                    };
                }
                
                // Validar que no tenga múltiples arrobas
                if (emailRecortado.split(arroba).length > 2) {
                    return {
                        valido: false,
                        mensaje: 'El email no puede contener múltiples símbolos ' + arroba
                    };
                }
                
                return {
                    valido: true,
                    mensaje: ''
                };
            }

            // Confirmar envío de email
            $('#btnConfirmarEnvio').on('click', function() {
                var emailReceptor = $('#emailReceptor').val();
                var resultadoValidacion = ValidarEmail(emailReceptor);
                
                if (!resultadoValidacion.valido) {
                    var simboloArroba = String.fromCharCode(64);
                    Swal.fire({
                        icon: 'error',
                        title: 'Email Inválido',
                        html: '<strong>' + resultadoValidacion.mensaje + '</strong><br><br>' +
                              'Por favor ingrese un email válido con el formato:<br>' +
                              '<code>ejemplo' + simboloArroba + 'dominio.com</code>',
                        confirmButtonText: 'Entendido'
                    });
                    return;
                }

                // TODO: Implementar envío real de email con template HTML
                // Por ahora solo mostrar mensaje de éxito
                
                var nombresEmpleados = empleadosSeleccionados.map(e => e.nombre).join(', ');
                
                Swal.fire({
                    icon: 'success',
                    title: 'Email Enviado Exitosamente',
                    html: 'El email ha sido enviado a: <strong>' + emailReceptor + '</strong><br><br>' +
                          'Empleados incluidos:<br>' + nombresEmpleados,
                    confirmButtonText: 'Aceptar'
                }).then(function() {
                    // Cerrar modal
                    var instanciaModal = bootstrap.Modal.getInstance(document.getElementById('modalEnviarEmail'));
                    instanciaModal.hide();
                    
                    // Limpiar selección
                    empleadosSeleccionados = [];
                    fechaContratacionBase = null;
                    $('.checkbox-empleado').prop('checked', false);
                });
            });
        });

        function VerDetallesEmpleado(idEmpleado) {
            $.ajax({
                url: '/Employees/ObtenerEmployeePorId',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(idEmpleado),
                dataType: 'json',
                success: function(respuestaServidor) {
                    if (respuestaServidor.exito) {
                        var datosEmpleado = respuestaServidor.datos;
                        var mensajeDetalle = 'ID Empleado: ' + datosEmpleado.idEmpleado + '\n' +
                                             'Nombre: ' + datosEmpleado.nombreCompleto + '\n' +
                                             'Email: ' + datosEmpleado.correoElectronico + '\n' +
                                             'Teléfono: ' + (datosEmpleado.numeroTelefono || 'N/A') + '\n' +
                                             'Fecha Contratación: ' + datosEmpleado.fechaContratacion + '\n' +
                                             'Salario: ' + (datosEmpleado.salario || 'N/A');
                        alert(mensajeDetalle);
                    } else {
                        mostrarMensaje('error', respuestaServidor.mensaje || 'Error al cargar el empleado');
                    }
                },
                error: function(xhr, estado, mensajeError) {
                    mostrarMensaje('error', 'Error al cargar el empleado: ' + mensajeError);
                }
            });
        }
    </script>
}
