@{
    ViewData["Title"] = "Employees";
}

<div>
    <h2>Employees</h2>
    <p class="text-muted">Gestión de empleados de la empresa</p>
    
    <!-- Breadcrumb Navigation -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a asp-controller="Home" asp-action="Index">Home</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">Employees</li>
        </ol>
    </nav>
    
    <!-- Vista parcial del grid -->
    @await Html.PartialAsync("_EmployeesGrid")
</div>

<!-- Modal para Enviar por Email -->
<div class="modal fade" id="modalEnviarEmail" tabindex="-1" aria-labelledby="modalEnviarEmailLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEnviarEmailLabel">
                    <i class="fas fa-envelope"></i> Enviar Información por Email
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="emailReceptor" class="form-label">Email del Receptor</label>
                    <input type="email" class="form-control" id="emailReceptor" placeholder="ejemplo@empresa.com" required>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>Nombre Completo</th>
                                <th>Email</th>
                                <th>Teléfono</th>
                                <th>Fecha Contratación</th>
                                <th>Salario</th>
                                <th>Departamento</th>
                            </tr>
                        </thead>
                        <tbody id="tablaResumenEmpleados">
                            <!-- Se llena dinámicamente con los empleados seleccionados -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnConfirmarEnvio">
                    <i class="fas fa-paper-plane"></i> Enviar Email
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/employees.js"></script>
    <script>
        $(document).ready(function() {
            var empleadosSeleccionados = [];
            var fechaContratacionBase = null;
            
            var tabla = $('#employeesTable').DataTable({
                processing: true,
                serverSide: false,
                ajax: {
                    url: '/Employees/ObtenerEmployees',
                    type: 'POST',
                    dataType: 'json',
                    dataSrc: function(respuesta) {
                        if (respuesta.exito) {
                            return respuesta.datos;
                        } else {
                            mostrarMensaje('error', respuesta.mensaje || 'Error al cargar datos');
                            return [];
                        }
                    },
                    error: function(xhr, error, thrown) {
                        mostrarMensaje('error', 'Error al cargar los empleados: ' + thrown);
                    }
                },
                columns: [
                    {
                        data: null,
                        name: 'Seleccionar',
                        width: '3%',
                        orderable: false,
                        searchable: false,
                        render: function(data, type, row) {
                            return '<input type="checkbox" class="checkbox-empleado" data-id="' + row.idEmpleado + '" data-fecha="' + row.fechaContratacion + '" data-nombre="' + (row.nombreCompleto || row.primerNombre + ' ' + row.apellido) + '">';
                        }
                    },
                    { 
                        data: 'nombreCompleto', 
                        name: 'NombreCompleto', 
                        width: '20%',
                        render: function(data, type, row) {
                            return data || (row.primerNombre + ' ' + row.apellido);
                        }
                    },
                    { data: 'correoElectronico', name: 'CorreoElectronico', width: '15%' },
                    { data: 'numeroTelefono', name: 'NumeroTelefono', width: '12%' },
                    { data: 'fechaContratacion', name: 'FechaContratacion', width: '12%' },
                    { 
                        data: 'salario', 
                        name: 'Salario', 
                        width: '12%',
                        render: function(data, type, row) {
                            return data || '-';
                        }
                    },
                    { 
                        data: 'idDepartamento', 
                        name: 'IdDepartamento', 
                        width: '10%',
                        render: function(data, type, row) {
                            return data ? 'Dept. ' + data : '-';
                        }
                    },
                    {
                        data: null,
                        name: 'Acciones',
                        width: '12%',
                        orderable: false,
                        searchable: false,
                        render: function(data, type, row) {
                            return '<button type="button" class="btn btn-outline-info btn-sm btn-ver" data-id="' + row.idEmpleado + '" data-bs-toggle="tooltip" data-bs-placement="top" title="Ver Detalles del Empleado" aria-label="Ver Detalles"><i class="fas fa-eye" aria-hidden="true"></i></button>';
                        }
                    }
                ],
                order: [[1, 'asc']],
                pageLength: 10,
                lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Todos"]],
                language: {
                    "decimal": "",
                    "emptyTable": "No hay datos disponibles en la tabla",
                    "info": "Mostrando _START_ a _END_ de _TOTAL_ registros",
                    "infoEmpty": "Mostrando 0 a 0 de 0 registros",
                    "infoFiltered": "(filtrado de _MAX_ registros totales)",
                    "infoPostFix": "",
                    "thousands": ",",
                    "lengthMenu": "Mostrar _MENU_ registros",
                    "loadingRecords": "Cargando...",
                    "processing": "Procesando...",
                    "search": "Buscar:",
                    "zeroRecords": "No se encontraron registros coincidentes",
                    "paginate": {
                        "first": "Primero",
                        "last": "Último",
                        "next": "Siguiente",
                        "previous": "Anterior"
                    },
                    "aria": {
                        "sortAscending": ": activar para ordenar columna ascendente",
                        "sortDescending": ": activar para ordenar columna descendente"
                    }
                },
                dom: 'Brtip',
                buttons: [
                    {
                        text: '<i class="fas fa-sync-alt" aria-hidden="true"></i>',
                        action: function(e, dt, node, config) {
                            dt.ajax.reload();
                        },
                        className: 'btn btn-sm',
                        titleAttr: 'Actualizar tabla de empleados'
                    },
                    {
                        extend: 'excel',
                        text: '<i class="fas fa-file-excel" aria-hidden="true"></i>',
                        className: 'btn btn-sm',
                        exportOptions: {
                            columns: [1, 2, 3, 4, 5, 6]
                        },
                        titleAttr: 'Exportar datos a Excel'
                    },
                    {
                        extend: 'pdf',
                        text: '<i class="fas fa-file-pdf" aria-hidden="true"></i>',
                        className: 'btn btn-sm',
                        exportOptions: {
                            columns: [1, 2, 3, 4, 5, 6]
                        },
                        titleAttr: 'Exportar datos a PDF'
                    },
                    {
                        extend: 'print',
                        text: '<i class="fas fa-print" aria-hidden="true"></i>',
                        className: 'btn btn-sm',
                        titleAttr: 'Imprimir tabla de empleados'
                    },
                    {
                        text: '<i class="fas fa-envelope" aria-hidden="true"></i> Enviar por Email',
                        action: function(e, dt, node, config) {
                            abrirModalEnviarEmail();
                        },
                        className: 'btn btn-sm btn-enviar-email',
                        titleAttr: 'Enviar información de empleados seleccionados por email',
                        enabled: false
                    }
                ],
                responsive: true
            });

            // Guardar referencia global de la tabla
            window.tablaEmpleados = tabla;
            window.empleadosSeleccionados = empleadosSeleccionados;
            window.fechaContratacionBase = fechaContratacionBase;

            // Inicializar tooltips de Bootstrap
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Inicializar Date Pickers para Fecha de Contratación (rango)
            $('#filtroFechaInicio').datepicker({
                dateFormat: 'dd/mm/yy',
                changeMonth: true,
                changeYear: true,
                showButtonPanel: true,
                onSelect: function(selectedDate) {
                    $('#filtroFechaFin').datepicker('option', 'minDate', selectedDate);
                    aplicarFiltros();
                }
            });

            $('#filtroFechaFin').datepicker({
                dateFormat: 'dd/mm/yy',
                changeMonth: true,
                changeYear: true,
                showButtonPanel: true,
                onSelect: function(selectedDate) {
                    $('#filtroFechaInicio').datepicker('option', 'maxDate', selectedDate);
                    aplicarFiltros();
                }
            });

            // Inicializar formato de moneda para inputs de salario
            $('#filtroSalarioMin, #filtroSalarioMax').inputmask({
                alias: 'numeric',
                groupSeparator: ',',
                autoGroup: true,
                digits: 2,
                digitsOptional: false,
                prefix: '$ ',
                placeholder: '0',
                rightAlign: false,
                oncomplete: function() {
                    aplicarFiltros();
                },
                oncleared: function() {
                    aplicarFiltros();
                }
            });

            // Filtro de búsqueda general
            $('#filtroBusqueda').on('keyup', function() {
                tabla.search(this.value).draw();
            });

            // Filtros de salario
            $('#filtroSalarioMin, #filtroSalarioMax').on('keyup change', function() {
                aplicarFiltros();
            });

            // Variable para almacenar la función de filtro personalizado
            var filtroPersonalizado = null;

            // Función para aplicar todos los filtros personalizados
            function aplicarFiltros() {
                // Remover filtro anterior si existe
                if (filtroPersonalizado !== null) {
                    $.fn.dataTable.ext.search.pop();
                }
                
                // Crear nuevo filtro
                filtroPersonalizado = function(settings, data, dataIndex) {
                        var fechaInicio = null;
                        var fechaFin = null;
                        var salarioMin = null;
                        var salarioMax = null;

                        // Filtro de fecha de contratación (rango)
                        var fechaInicioText = $('#filtroFechaInicio').val();
                        var fechaFinText = $('#filtroFechaFin').val();
                        
                        if (fechaInicioText) {
                            var fechaParts = fechaInicioText.split('/');
                            if (fechaParts.length === 3) {
                                fechaInicio = new Date(fechaParts[2], fechaParts[1] - 1, fechaParts[0]);
                            }
                        }
                        
                        if (fechaFinText) {
                            var fechaParts = fechaFinText.split('/');
                            if (fechaParts.length === 3) {
                                fechaFin = new Date(fechaParts[2], fechaParts[1] - 1, fechaParts[0]);
                                fechaFin.setHours(23, 59, 59, 999);
                            }
                        }

                        // Filtro de salario
                        var salarioMinText = $('#filtroSalarioMin').val();
                        var salarioMaxText = $('#filtroSalarioMax').val();
                        
                        if (salarioMinText) {
                            salarioMin = parseFloat(salarioMinText.replace(/[^0-9.-]+/g, ''));
                        }
                        if (salarioMaxText) {
                            salarioMax = parseFloat(salarioMaxText.replace(/[^0-9.-]+/g, ''));
                        }

                        // Obtener datos de la fila
                        var row = tabla.row(dataIndex);
                        var rowData = row.data();
                        
                        if (!rowData) return true;

                        // Validar fecha de contratación (rango)
                        if (fechaInicio !== null || fechaFin !== null) {
                            var fechaContratacion = rowData.fechaContratacion;
                            if (fechaContratacion) {
                                var fechaParts = fechaContratacion.split('/');
                                if (fechaParts.length === 3) {
                                    var fechaEmpleado = new Date(fechaParts[2], fechaParts[1] - 1, fechaParts[0]);
                                    
                                    if (fechaInicio !== null && fechaEmpleado < fechaInicio) {
                                        return false;
                                    }
                                    if (fechaFin !== null && fechaEmpleado > fechaFin) {
                                        return false;
                                    }
                                }
                            } else {
                                return false;
                            }
                        }

                        // Validar rango de salario
                        if (salarioMin !== null || salarioMax !== null) {
                            var salarioText = rowData.salario;
                            if (salarioText && salarioText !== '-') {
                                var salario = parseFloat(salarioText.replace(/[^0-9.-]+/g, ''));
                                if (isNaN(salario)) return false;
                                
                                if (salarioMin !== null && salario < salarioMin) {
                                    return false;
                                }
                                if (salarioMax !== null && salario > salarioMax) {
                                    return false;
                                }
                            } else {
                                return false;
                            }
                        }

                        return true;
                    };
                
                // Agregar el nuevo filtro
                $.fn.dataTable.ext.search.push(filtroPersonalizado);
                
                tabla.draw();
            }

            // Limpiar filtros cuando se limpia la búsqueda general
            $('#filtroBusqueda').on('keyup', function() {
                tabla.search(this.value).draw();
            });

            // Seleccionar todos
            $('#selectAll').on('change', function() {
                var isChecked = $(this).prop('checked');
                $('.checkbox-empleado').each(function() {
                    var checkbox = $(this);
                    var fecha = checkbox.data('fecha');
                    
                    if (isChecked) {
                        if (fechaContratacionBase === null) {
                            fechaContratacionBase = fecha;
                        }
                        if (fecha === fechaContratacionBase) {
                            checkbox.prop('checked', true);
                            agregarEmpleadoSeleccionado(checkbox);
                        }
                    } else {
                        checkbox.prop('checked', false);
                        fechaContratacionBase = null;
                        empleadosSeleccionados = [];
                    }
                });
                actualizarBotonEnviarEmail();
            });

            // Checkbox individual
            $('#employeesTable tbody').on('change', '.checkbox-empleado', function() {
                var checkbox = $(this);
                var fecha = checkbox.data('fecha');
                
                if (checkbox.prop('checked')) {
                    if (fechaContratacionBase === null) {
                        fechaContratacionBase = fecha;
                        agregarEmpleadoSeleccionado(checkbox);
                    } else if (fecha === fechaContratacionBase) {
                        agregarEmpleadoSeleccionado(checkbox);
                    } else {
                        checkbox.prop('checked', false);
                        Swal.fire({
                            icon: 'warning',
                            title: 'Fecha de Contratación Diferente',
                            text: 'Solo se pueden seleccionar empleados con la misma fecha de contratación. La fecha base es: ' + fechaContratacionBase,
                            confirmButtonText: 'Entendido'
                        });
                    }
                } else {
                    removerEmpleadoSeleccionado(checkbox);
                    if (empleadosSeleccionados.length === 0) {
                        fechaContratacionBase = null;
                    }
                }
                actualizarBotonEnviarEmail();
                $('#selectAll').prop('checked', false);
            });

            // Event listeners para botones de acción
            $('#employeesTable tbody').on('click', '.btn-ver', function() {
                var idEmpleado = $(this).data('id');
                verDetallesEmpleado(idEmpleado);
            });
            
            // Reinicializar tooltips después de cargar datos en la tabla
            tabla.on('draw', function() {
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
                
                // Restaurar checkboxes seleccionados
                empleadosSeleccionados.forEach(function(empleado) {
                    $('.checkbox-empleado[data-id="' + empleado.id + '"]').prop('checked', true);
                });
            });

            function agregarEmpleadoSeleccionado(checkbox) {
                var id = checkbox.data('id');
                var nombre = checkbox.data('nombre');
                var fecha = checkbox.data('fecha');
                
                if (!empleadosSeleccionados.find(e => e.id === id)) {
                    empleadosSeleccionados.push({
                        id: id,
                        nombre: nombre,
                        fecha: fecha
                    });
                }
            }

            function removerEmpleadoSeleccionado(checkbox) {
                var id = checkbox.data('id');
                empleadosSeleccionados = empleadosSeleccionados.filter(e => e.id !== id);
            }

            function actualizarBotonEnviarEmail() {
                var boton = tabla.button(4); // Índice del botón "Enviar por Email"
                if (empleadosSeleccionados.length > 0) {
                    boton.enable();
                } else {
                    boton.disable();
                }
            }

            function abrirModalEnviarEmail() {
                if (empleadosSeleccionados.length === 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Sin Selección',
                        text: 'Debe seleccionar al menos un empleado',
                        confirmButtonText: 'Entendido'
                    });
                    return;
                }

                // Obtener datos completos de empleados seleccionados
                var datosCompletos = [];
                tabla.rows().every(function() {
                    var data = this.data();
                    if (empleadosSeleccionados.find(e => e.id === data.idEmpleado)) {
                        datosCompletos.push(data);
                    }
                });

                // Llenar tabla resumen
                var tbody = $('#tablaResumenEmpleados');
                tbody.empty();
                datosCompletos.forEach(function(empleado) {
                    var row = '<tr>' +
                        '<td>' + (empleado.nombreCompleto || empleado.primerNombre + ' ' + empleado.apellido) + '</td>' +
                        '<td>' + empleado.correoElectronico + '</td>' +
                        '<td>' + (empleado.numeroTelefono || '-') + '</td>' +
                        '<td>' + empleado.fechaContratacion + '</td>' +
                        '<td>' + (empleado.salario || '-') + '</td>' +
                        '<td>' + (empleado.idDepartamento ? 'Dept. ' + empleado.idDepartamento : '-') + '</td>' +
                        '</tr>';
                    tbody.append(row);
                });

                // Limpiar email
                $('#emailReceptor').val('');

                // Mostrar modal
                var modal = new bootstrap.Modal(document.getElementById('modalEnviarEmail'));
                modal.show();
            }

            // Confirmar envío de email
            $('#btnConfirmarEnvio').on('click', function() {
                var email = $('#emailReceptor').val();
                var arroba = String.fromCharCode(64);
                var emailValido = email && email.length > 0 && email.indexOf(arroba) > 0;
                
                if (!emailValido) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Email Inválido',
                        text: 'Por favor ingrese un email válido',
                        confirmButtonText: 'Entendido'
                    });
                    return;
                }

                // TODO: Implementar envío real de email con template HTML
                // Por ahora solo mostrar mensaje de éxito
                
                var nombres = empleadosSeleccionados.map(e => e.nombre).join(', ');
                
                Swal.fire({
                    icon: 'success',
                    title: 'Email Enviado Exitosamente',
                    html: 'El email ha sido enviado a: <strong>' + email + '</strong><br><br>' +
                          'Empleados incluidos:<br>' + nombres,
                    confirmButtonText: 'Aceptar'
                }).then(function() {
                    // Cerrar modal
                    var modal = bootstrap.Modal.getInstance(document.getElementById('modalEnviarEmail'));
                    modal.hide();
                    
                    // Limpiar selección
                    empleadosSeleccionados = [];
                    fechaContratacionBase = null;
                    $('.checkbox-empleado').prop('checked', false);
                    $('#selectAll').prop('checked', false);
                    actualizarBotonEnviarEmail();
                });
            });
        });

        function verDetallesEmpleado(id) {
            $.ajax({
                url: '/Employees/ObtenerEmployeePorId',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(id),
                dataType: 'json',
                success: function(respuesta) {
                    if (respuesta.exito) {
                        var empleado = respuesta.datos;
                        var mensaje = 'ID Empleado: ' + empleado.idEmpleado + '\n' +
                                     'Nombre: ' + empleado.nombreCompleto + '\n' +
                                     'Email: ' + empleado.correoElectronico + '\n' +
                                     'Teléfono: ' + (empleado.numeroTelefono || 'N/A') + '\n' +
                                     'Fecha Contratación: ' + empleado.fechaContratacion + '\n' +
                                     'Salario: ' + (empleado.salario || 'N/A');
                        alert(mensaje);
                    } else {
                        mostrarMensaje('error', respuesta.mensaje || 'Error al cargar el empleado');
                    }
                },
                error: function(xhr, status, error) {
                    mostrarMensaje('error', 'Error al cargar el empleado: ' + error);
                }
            });
        }
    </script>
}
