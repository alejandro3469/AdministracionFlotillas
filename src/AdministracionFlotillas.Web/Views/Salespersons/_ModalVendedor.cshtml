@* Modal unificado Ver/Editar Vendedor usando Syncfusion Dialog *@
<ejs-tooltip id="tooltipModalVendedor" 
             target=".info-tooltip-vendedor" 
             opensOn="Hover" 
             width="300px"
             position="TopCenter"
             beforeRender="tooltipModalVendedorBeforeRender">
    <e-content-template>
        <div id="tooltipContentVendedor"></div>
    </e-content-template>
</ejs-tooltip>

@* IMPORTANTE: El tag helper <ejs-dialog> renderiza un div con el id especificado cuando el Script Manager se ejecuta *@
@* Pero necesitamos asegurarnos de que el elemento exista en el DOM antes de que Syncfusion lo inicialice *@
<div id="modalVendedor" style="display: none;"></div>

<ejs-dialog id="modalVendedor" 
            isModal="true" 
            showCloseIcon="true" 
            width="80%" 
            height="85%" 
            visible="false"
            header="Vendedor #<span id='modalVendedorTitulo'>0</span>"
            created="modalVendedorCreated"
            open="modalVendedorOpen"
            close="modalVendedorClose"
            beforeClose="modalVendedorBeforeClose">
    <e-content-template>
        <div id="modalVendedorContenido">
            <!-- Tabs para organizar el contenido -->
            <ejs-tab id="tabsModalVendedor" heightAdjustMode="Auto">
                <e-tab-tabitems>
                    <e-tab-item header="@(new Syncfusion.EJ2.Navigations.TabHeader { Text = "Información General" })">
                        <e-content-template>
                            <div id="tabInfoModalVendedor" class="mt-3">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">Información del Vendedor</h5>
                                            </div>
                                            <div class="card-body">
                                                <dl class="row">
                                                    <dt class="col-sm-5">ID Vendedor:</dt>
                                                    <dd class="col-sm-7">
                                                        <strong id="modalIdVendedor" class="info-tooltip-vendedor" data-field="IdVendedor" data-tooltip="Identificador único del vendedor en el sistema">-</strong>
                                                    </dd>

                                                    <dt class="col-sm-5">Nombre Completo:</dt>
                                                    <dd class="col-sm-7">
                                                        <span id="modalNombreCompleto" class="info-tooltip-vendedor" data-field="NombreCompleto" data-tooltip="Nombre completo del vendedor">-</span>
                                                    </dd>

                                                    <dt class="col-sm-5">Email:</dt>
                                                    <dd class="col-sm-7">
                                                        <span id="modalEmail" class="info-tooltip-vendedor" data-field="Email" data-tooltip="Correo electrónico de contacto del vendedor">-</span>
                                                    </dd>

                                                    <dt class="col-sm-5">Teléfono:</dt>
                                                    <dd class="col-sm-7">
                                                        <span id="modalTelefono" class="info-tooltip-vendedor" data-field="Telefono" data-tooltip="Número de teléfono de contacto">-</span>
                                                    </dd>

                                                    <dt class="col-sm-5">Zona de Cobertura:</dt>
                                                    <dd class="col-sm-7">
                                                        <span id="modalZonaCobertura" class="info-tooltip-vendedor" data-field="ZonaCobertura" data-tooltip="Zona geográfica asignada al vendedor">-</span>
                                                    </dd>

                                                    <dt class="col-sm-5">Estado:</dt>
                                                    <dd class="col-sm-7" id="modalEstadoVendedor">
                                                        <span class="info-tooltip-vendedor" data-field="Estado" data-tooltip="Estado del vendedor: ACTIVE (activo), INACTIVE (inactivo), ON_LEAVE (en licencia)">-</span>
                                                    </dd>

                                                    <dt class="col-sm-5">Fecha de Contratación:</dt>
                                                    <dd class="col-sm-7">
                                                        <span id="modalFechaContratacion" class="info-tooltip-vendedor" data-field="FechaContratacion" data-tooltip="Fecha en que el vendedor fue contratado">-</span>
                                                    </dd>
                                                </dl>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">Comisiones y Métricas</h5>
                                            </div>
                                            <div class="card-body">
                                                <dl class="row">
                                                    <dt class="col-sm-5">Comisión Base:</dt>
                                                    <dd class="col-sm-7">
                                                        <span id="modalComisionBase" class="info-tooltip-vendedor" data-field="ComisionBase" data-tooltip="Comisión base fija (%)">0%</span>
                                                    </dd>

                                                    <dt class="col-sm-5">Comisión Variable:</dt>
                                                    <dd class="col-sm-7">
                                                        <span id="modalComisionVariable" class="info-tooltip-vendedor" data-field="ComisionVariable" data-tooltip="Comisión variable adicional (%)">0%</span>
                                                    </dd>

                                                    <dt class="col-sm-5">Total Órdenes:</dt>
                                                    <dd class="col-sm-7">
                                                        <span id="modalTotalOrdenes" class="info-tooltip-vendedor" data-field="TotalOrdenes" data-tooltip="Número total de órdenes gestionadas por el vendedor">0</span>
                                                    </dd>

                                                    <dt class="col-sm-5">Total Ventas:</dt>
                                                    <dd class="col-sm-7">
                                                        <span id="modalTotalVentas" class="info-tooltip-vendedor" data-field="TotalVentas" data-tooltip="Monto total de ventas generadas por el vendedor">$0.00</span>
                                                    </dd>

                                                    <dt class="col-sm-5">Total Comisiones:</dt>
                                                    <dd class="col-sm-7">
                                                        <span id="modalTotalComisiones" class="info-tooltip-vendedor" data-field="TotalComisiones" data-tooltip="Monto total de comisiones ganadas por el vendedor">$0.00</span>
                                                    </dd>

                                                    <dt class="col-sm-5">Cadenas Asignadas:</dt>
                                                    <dd class="col-sm-7">
                                                        <span id="modalCadenasAsignadas" class="info-tooltip-vendedor" data-field="CadenasAsignadas" data-tooltip="Número de cadenas comerciales asignadas al vendedor">0</span>
                                                    </dd>
                                                </dl>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </e-content-template>
                    </e-tab-item>
                </e-tab-tabitems>
            </ejs-tab>
        </div>
    </e-content-template>
    <e-dialog-buttons>
        <e-dialog-dialogbutton content="Editar" isPrimary="false" cssClass="e-flat" click="modalVendedorEditar"></e-dialog-dialogbutton>
        <e-dialog-dialogbutton content="Cerrar" isPrimary="true" click="modalVendedorCerrar"></e-dialog-dialogbutton>
    </e-dialog-buttons>
</ejs-dialog>

<script>
    var modalVendedorModo = 'ver';
    var modalVendedorId = null;
    var tooltipModalVendedorObj = null;
    window.modalVendedorInstance = null; // Instancia del Dialog de Syncfusion

    // FUNCIONES HELPER SIMPLES para mostrar/ocultar el modal desde JavaScript
    // Uso: window.mostrarModalVendedor() o window.ocultarModalVendedor()
    window.mostrarModalVendedor = function() {
        // Intentar obtener la instancia de varias formas
        if (window.modalVendedorInstance) {
            try {
                window.modalVendedorInstance.show();
                return true;
            } catch (e) {
                console.warn('⚠️ Error al mostrar modal usando instancia guardada:', e);
            }
        }
        
        // Buscar en el DOM
        var elemento = document.getElementById('modalVendedor');
        if (elemento) {
            // Buscar en ej2_instances
            if (elemento.ej2_instances && elemento.ej2_instances[0]) {
                try {
                    elemento.ej2_instances[0].show();
                    window.modalVendedorInstance = elemento.ej2_instances[0];
                    return true;
                } catch (e) {
                    console.warn('⚠️ Error al mostrar modal desde ej2_instances:', e);
                }
            }
            
            // Buscar en el contenedor de diálogo de Syncfusion
            var dialogContainer = elemento.closest('.e-dlg-container');
            if (dialogContainer) {
                var dialogElement = dialogContainer.querySelector('#modalVendedor');
                if (dialogElement && dialogElement.ej2_instances && dialogElement.ej2_instances[0]) {
                    try {
                        dialogElement.ej2_instances[0].show();
                        window.modalVendedorInstance = dialogElement.ej2_instances[0];
                        return true;
                    } catch (e) {
                        console.warn('⚠️ Error al mostrar modal desde contenedor:', e);
                    }
                }
            }
        }
        
        console.warn('⚠️ No se pudo encontrar la instancia del modal de vendedor');
        return false;
    };
    
    window.ocultarModalVendedor = function() {
        // Intentar obtener la instancia de varias formas
        if (window.modalVendedorInstance) {
            try {
                window.modalVendedorInstance.hide();
                return true;
            } catch (e) {
                console.warn('⚠️ Error al ocultar modal usando instancia guardada:', e);
            }
        }
        
        // Buscar en el DOM
        var elemento = document.getElementById('modalVendedor');
        if (elemento) {
            // Buscar en ej2_instances
            if (elemento.ej2_instances && elemento.ej2_instances[0]) {
                try {
                    elemento.ej2_instances[0].hide();
                    return true;
                } catch (e) {
                    console.warn('⚠️ Error al ocultar modal desde ej2_instances:', e);
                }
            }
            
            // Buscar en el contenedor de diálogo de Syncfusion
            var dialogContainer = elemento.closest('.e-dlg-container');
            if (dialogContainer) {
                var dialogElement = dialogContainer.querySelector('#modalVendedor');
                if (dialogElement && dialogElement.ej2_instances && dialogElement.ej2_instances[0]) {
                    try {
                        dialogElement.ej2_instances[0].hide();
                        return true;
                    } catch (e) {
                        console.warn('⚠️ Error al ocultar modal desde contenedor:', e);
                    }
                }
            }
        }
        
        return false;
    };

    // Evento created del Dialog - SOLUCIÓN DE RAÍZ según documentación oficial
    window.modalVendedorCreated = function(args) {
        console.log('✅ Modal de vendedor creado e inicializado por Syncfusion');
        if (args && args.component) {
            window.modalVendedorInstance = args.component;
            console.log('✅ Instancia del Dialog guardada correctamente:', window.modalVendedorInstance);
        } else if (args && args.element) {
            // Fallback: obtener del elemento
            var dialogElement = args.element;
            if (dialogElement && dialogElement.ej2_instances && dialogElement.ej2_instances[0]) {
                window.modalVendedorInstance = dialogElement.ej2_instances[0];
                console.log('⚠️ Instancia obtenida del elemento (fallback en created)');
            }
        } else {
            // Fallback: intentar obtener del DOM directamente
            setTimeout(function() {
                var dialogElement = document.getElementById('modalVendedor');
                if (dialogElement && dialogElement.ej2_instances && dialogElement.ej2_instances[0]) {
                    window.modalVendedorInstance = dialogElement.ej2_instances[0];
                    console.log('⚠️ Instancia obtenida del DOM después de created (fallback)');
                } else {
                    // Buscar en el contenedor de diálogo
                    var dialogContainer = document.querySelector('.e-dlg-container');
                    if (dialogContainer) {
                        var dialogElement = dialogContainer.querySelector('#modalVendedor');
                        if (dialogElement && dialogElement.ej2_instances && dialogElement.ej2_instances[0]) {
                            window.modalVendedorInstance = dialogElement.ej2_instances[0];
                            console.log('⚠️ Instancia obtenida del contenedor de diálogo (fallback)');
                        }
                    }
                }
            }, 100);
        }
        
        // Inicializar tooltip después de que el modal esté creado
        setTimeout(function() {
            var tooltipElement = document.getElementById('tooltipModalVendedor');
            if (tooltipElement && tooltipElement.ej2_instances && tooltipElement.ej2_instances[0]) {
                tooltipModalVendedorObj = tooltipElement.ej2_instances[0];
            }
        }, 100);
    };

    // Inicializar tooltip cuando el DOM esté listo (fallback)
    document.addEventListener("DOMContentLoaded", function() {
        var tooltipElement = document.getElementById('tooltipModalVendedor');
        if (tooltipElement && tooltipElement.ej2_instances && tooltipElement.ej2_instances[0]) {
            tooltipModalVendedorObj = tooltipElement.ej2_instances[0];
        }
        
        // Verificar si el modal ya está inicializado después de que <ejs-scripts> procese los componentes
        setTimeout(function() {
            if (!window.modalVendedorInstance) {
                var dialogElement = document.getElementById('modalVendedor');
                if (dialogElement && dialogElement.ej2_instances && dialogElement.ej2_instances[0]) {
                    window.modalVendedorInstance = dialogElement.ej2_instances[0];
                    console.log('✅ Instancia del modal de vendedor obtenida del DOM después de DOMContentLoaded (fallback)');
                } else {
                    console.warn('⚠️ Modal aún no inicializado después de DOMContentLoaded + 1 segundo');
                }
            }
        }, 1000);
    });

    // Evento beforeRender del tooltip
    window.tooltipModalVendedorBeforeRender = function(args) {
        var target = args.target;
        var tooltipText = target.getAttribute('data-tooltip');
        var field = target.getAttribute('data-field');
        
        if (tooltipText) {
            var contentDiv = document.createElement('div');
            contentDiv.style.padding = '8px';
            contentDiv.style.fontSize = '13px';
            contentDiv.style.lineHeight = '1.5';
            
            var fieldName = document.createElement('strong');
            fieldName.textContent = field + ': ';
            fieldName.style.display = 'block';
            fieldName.style.marginBottom = '4px';
            fieldName.style.color = '#007bff';
            
            var description = document.createElement('span');
            description.textContent = tooltipText;
            
            contentDiv.appendChild(fieldName);
            contentDiv.appendChild(description);
            
            if (tooltipModalVendedorObj) {
                tooltipModalVendedorObj.content = contentDiv;
            }
        }
    };

    // Eventos del modal
    window.modalVendedorOpen = function(args) {
        console.log('Modal de vendedor abierto');
    };

    window.modalVendedorClose = function(args) {
        console.log('Modal de vendedor cerrado');
        modalVendedorId = null;
        modalVendedorModo = 'ver';
    };

    window.modalVendedorBeforeClose = function(args) {
        return true;
    };

    // Botones del modal
    window.modalVendedorEditar = function() {
        if (modalVendedorId) {
            modalVendedorModo = 'editar';
            if (window.Salespersons && window.Salespersons.Modal) {
                window.Salespersons.Modal.CambiarAModoEdicion(modalVendedorId);
            }
        }
    };

    window.modalVendedorCerrar = function() {
        if (typeof window.ocultarModalVendedor === 'function') {
            window.ocultarModalVendedor();
        } else {
            var dialogElement = document.getElementById('modalVendedor');
            if (dialogElement && dialogElement.ej2_instances && dialogElement.ej2_instances[0]) {
                dialogElement.ej2_instances[0].hide();
            } else if (window.modalVendedorInstance) {
                window.modalVendedorInstance.hide();
            }
        }
    };
</script>
