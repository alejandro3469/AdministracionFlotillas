<div class="row mb-3 g-3">
    <div class="col-12 col-sm-6 col-md-4">
        <label class="form-label">Nombre</label>
        <ejs-textbox id="filtroNombre" 
                     placeholder="Buscar por nombre..."
                     change="filtroNombreChange">
        </ejs-textbox>
    </div>
    <div class="col-12 col-sm-6 col-md-3">
        <label class="form-label">Zona</label>
        <ejs-dropdownlist id="filtroZona" 
                          placeholder="Todas las zonas"
                          dataSource="@(new string[] { "Norte", "Sur", "Centro", "Este", "Oeste", "Nacional" })"
                          change="filtroZonaChange">
        </ejs-dropdownlist>
    </div>
    <div class="col-12 col-sm-6 col-md-3">
        <label class="form-label">Estado</label>
        <ejs-dropdownlist id="filtroEstado" 
                          placeholder="Todos los estados"
                          dataSource="@(new string[] { "ACTIVE", "INACTIVE", "ON_LEAVE" })"
                          change="filtroEstadoChange">
        </ejs-dropdownlist>
    </div>
    <div class="col-12 col-sm-6 col-md-2 d-flex align-items-end">
        <button type="button" class="btn btn-secondary w-100" onclick="Salespersons.Filtros.Limpiar()">
            <i class="fas fa-times"></i> Limpiar
        </button>
    </div>
</div>

<ejs-grid id="salespersonsGrid" 
          allowPaging="true"
          allowFiltering="true"
          allowSorting="true"
          allowSelection="true"
          allowExcelExport="true"
          allowPdfExport="true"
          allowResizing="true"
          is-responsive="true"
          enable-responsive-row="true"
          toolbarClick="salespersonsGridToolbarClick"
          toolbar="@(new List<string>() { "Search", "ExcelExport", "PdfExport" })"
          dataBound="salespersonsGridDataBound"
          created="salespersonsGridCreated"
          queryCellInfo="salespersonsGridQueryCellInfo">
    <e-grid-loadingIndicator indicatorType="Shimmer"></e-grid-loadingIndicator>
    <e-grid-pagesettings pageSize="10" pageSizes="@(new int[] { 10, 25, 50, 100 })"></e-grid-pagesettings>
    <e-grid-columns>
        <e-grid-column field="IdVendedor" headerText="ID" width="80" isPrimaryKey="true" type="number" textAlign="Right"></e-grid-column>
        <e-grid-column field="NombreCompleto" headerText="Nombre" width="200"></e-grid-column>
        <e-grid-column field="Email" headerText="Email" width="180"></e-grid-column>
        <e-grid-column field="Telefono" headerText="Tel√©fono" width="130"></e-grid-column>
        <e-grid-column field="ZonaCobertura" headerText="Zona" width="120"></e-grid-column>
        <e-grid-column field="ComisionBase" headerText="Comisi√≥n Base" width="120" type="number" format="N2" textAlign="Right"></e-grid-column>
        <e-grid-column field="ComisionVariable" headerText="Comisi√≥n Var." width="120" type="number" format="N2" textAlign="Right"></e-grid-column>
        <e-grid-column field="Estado" headerText="Estado" width="120" template="#estadoTemplate"></e-grid-column>
        <e-grid-column field="TotalVentas" headerText="Total Ventas" width="140" type="number" format="C2" textAlign="Right"></e-grid-column>
        <e-grid-column headerText="Acciones" width="150" template="#accionesTemplate"></e-grid-column>
    </e-grid-columns>
</ejs-grid>

<script id="estadoTemplate" type="text/x-template">
    ${if(Estado === 'ACTIVE')}
        <span class="badge bg-success">${Estado}</span>
    ${else if(Estado === 'INACTIVE')}
        <span class="badge bg-secondary">${Estado}</span>
    ${else if(Estado === 'ON_LEAVE')}
        <span class="badge bg-warning text-dark">${Estado}</span>
    ${else}
        <span class="badge bg-secondary">${Estado || 'ACTIVE'}</span>
    ${/if}
</script>

<script id="accionesTemplate" type="text/x-template">
    ${if(IdVendedor && IdVendedor > 0)}
        <div class="d-flex gap-1">
            <button class="btn btn-sm btn-info btn-cabecera-vendedor" data-id-vendedor="${IdVendedor}" 
                    title="Informaci√≥n de Cabecera: ID, Nombre, Estado, Fecha de Contrataci√≥n. Informaci√≥n b√°sica e identificadores del vendedor.">
                <i class="fas fa-id-card"></i> <span class="d-none d-sm-inline">Cabecera</span>
            </button>
            <button class="btn btn-sm btn-success btn-comercial-vendedor" data-id-vendedor="${IdVendedor}" 
                    title="Informaci√≥n Comercial: Comisiones, Ventas, √ìrdenes, M√©tricas de rendimiento. Datos financieros y de desempe√±o del vendedor.">
                <i class="fas fa-chart-line"></i> <span class="d-none d-sm-inline">Comercial</span>
            </button>
            <button class="btn btn-sm btn-warning btn-contacto-vendedor" data-id-vendedor="${IdVendedor}" 
                    title="Informaci√≥n de Contacto: Email, Tel√©fono, Zona de Cobertura. Datos de contacto y ubicaci√≥n del vendedor.">
                <i class="fas fa-address-book"></i> <span class="d-none d-sm-inline">Contacto</span>
            </button>
        </div>
    ${else}
        <div class="d-flex gap-1">
            <span class="text-muted small">-</span>
        </div>
    ${/if}
</script>

<script>
    if (!window.salespersonsGridActionButtonHandler) {
        window.salespersonsGridActionButtonHandler = function(event) {
            var target = event.target;
            var button = target.closest('.btn-cabecera-vendedor, .btn-comercial-vendedor, .btn-contacto-vendedor');
            
            if (button) {
                var idVendedor = button.getAttribute('data-id-vendedor');
                
                if (!idVendedor || idVendedor === 'undefined' || idVendedor === 'null' || idVendedor === '') {
                    var gridElement = document.getElementById('salespersonsGrid');
                    if (gridElement && gridElement.ej2_instances && gridElement.ej2_instances[0]) {
                        var grid = gridElement.ej2_instances[0];
                        var row = button.closest('.e-row');
                        if (row) {
                            try {
                                var rowInfo = grid.getRowInfo(row);
                                var rowData = rowInfo ? rowInfo.rowData : null;
                                if (rowData) {
                                    idVendedor = rowData.IdVendedor || rowData.idVendedor;
                                }
                            } catch (e) {
                                console.warn('Error al obtener datos de la fila:', e);
                            }
                        }
                    }
                }
                
                if (idVendedor && idVendedor !== 'undefined' && idVendedor !== 'null' && idVendedor !== '') {
                    idVendedor = parseInt(idVendedor, 10);
                    if (idVendedor && !isNaN(idVendedor) && idVendedor > 0) {
                        if (button.classList.contains('btn-cabecera-vendedor')) {
                            if (window.Salespersons && window.Salespersons.Modal) {
                                window.Salespersons.Modal.AbrirCabecera(idVendedor);
                            }
                        } else if (button.classList.contains('btn-comercial-vendedor')) {
                            if (window.Salespersons && window.Salespersons.Modal) {
                                window.Salespersons.Modal.AbrirComercial(idVendedor);
                            }
                        } else if (button.classList.contains('btn-contacto-vendedor')) {
                            if (window.Salespersons && window.Salespersons.Modal) {
                                window.Salespersons.Modal.AbrirContacto(idVendedor);
                            }
                        }
                    }
                }
            }
        };
        document.addEventListener('click', window.salespersonsGridActionButtonHandler);
    }
    
    window.filtroNombreChange = function(args) {
        if (window.Salespersons && window.Salespersons.Filtros) {
            window.Salespersons.Filtros.Aplicar();
        }
    };
    
    window.filtroZonaChange = function(args) {
        if (window.Salespersons && window.Salespersons.Filtros) {
            window.Salespersons.Filtros.Aplicar();
        }
    };
    
    window.filtroEstadoChange = function(args) {
        if (window.Salespersons && window.Salespersons.Filtros) {
            window.Salespersons.Filtros.Aplicar();
        }
    };
    
    window.salespersonsGridToolbarClick = function(args) {
        var gridElement = document.getElementById('salespersonsGrid');
        if (!gridElement || !gridElement.ej2_instances || !gridElement.ej2_instances[0]) {
            return;
        }
        
        var grid = gridElement.ej2_instances[0];
        var fileNamePrefix = 'Vendedores_' + new Date().toISOString().split('T')[0];
        
        if (args.item.text === 'Excel Export' || (args.item.id && args.item.id.includes('excelexport'))) {
            grid.excelExport({ fileName: fileNamePrefix + '.xlsx' });
        } else if (args.item.text === 'Pdf Export' || (args.item.id && args.item.id.includes('pdfexport'))) {
            grid.pdfExport({ fileName: fileNamePrefix + '.pdf' });
        }
    };
    
    window.salespersonsGridDataBound = function(args) {
        // Event delegation ya est√° registrado
    };
    
    window.salespersonsGridCreated = function(args) {
        console.log('Grid de vendedores creado');
        if (window.Salespersons && window.Salespersons.Grid) {
            window.Salespersons.Grid.CargarDatos();
        }
    };
    
    // Tooltips contextuales en celdas del grid con mensajes catalogados
    window.salespersonsGridQueryCellInfo = function(args) {
        if (!args.data || !args.column || !args.cell) return;
        
        var field = args.column.field;
        var data = args.data;
        var tooltipText = '';
        var icon = '';
        
        switch (field) {
            case 'IdVendedor':
                tooltipText = 'Identificador √∫nico del vendedor en el sistema';
                break;
                
            case 'NombreCompleto':
                tooltipText = 'Nombre completo del vendedor. Haga clic en "Ver" para m√°s detalles.';
                break;
                
            case 'Email':
                tooltipText = 'Correo electr√≥nico de contacto del vendedor';
                break;
                
            case 'Telefono':
                tooltipText = 'N√∫mero de tel√©fono de contacto del vendedor';
                break;
                
            case 'ZonaCobertura':
                tooltipText = 'Zona geogr√°fica asignada al vendedor: ' + (data.ZonaCobertura || 'No asignada');
                break;
                
            case 'ComisionBase':
                var comisionBase = parseFloat(data.ComisionBase || 0);
                tooltipText = 'Comisi√≥n base fija: ' + comisionBase.toFixed(2) + '%';
                if (comisionBase < 4.0) {
                    tooltipText += ' ‚ö†Ô∏è Comisi√≥n baja - Considerar revisar estructura de comisiones';
                } else if (comisionBase > 6.0) {
                    tooltipText += ' ‚úÖ Comisi√≥n alta - Vendedor con estructura de comisiones preferencial';
                } else {
                    tooltipText += ' - Comisi√≥n est√°ndar del mercado';
                }
                break;
                
            case 'ComisionVariable':
                var comisionVar = parseFloat(data.ComisionVariable || 0);
                tooltipText = 'Comisi√≥n variable adicional: ' + comisionVar.toFixed(2) + '%';
                if (comisionVar < 2.0) {
                    tooltipText += ' ‚ö†Ô∏è Variable baja - Incentivo limitado por volumen';
                } else if (comisionVar > 3.5) {
                    tooltipText += ' ‚úÖ Variable alta - Fuerte incentivo por volumen de ventas';
                } else {
                    tooltipText += ' - Variable est√°ndar';
                }
                break;
                
            case 'Estado':
                var estado = data.Estado || 'ACTIVE';
                switch (estado) {
                    case 'ACTIVE':
                        tooltipText = '‚úÖ Vendedor activo y operativo - Puede recibir √≥rdenes y generar comisiones';
                        break;
                    case 'INACTIVE':
                        tooltipText = '‚ùå Vendedor inactivo - No puede recibir √≥rdenes nuevas';
                        break;
                    case 'ON_LEAVE':
                        tooltipText = '‚è∏Ô∏è Vendedor en licencia - Temporalmente no disponible';
                        break;
                    default:
                        tooltipText = 'Estado: ' + estado;
                }
                break;
                
            case 'TotalVentas':
                var totalVentas = parseFloat(data.TotalVentas || 0);
                tooltipText = 'Total de ventas generadas: $' + totalVentas.toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                if (totalVentas === 0) {
                    tooltipText += ' ‚ö†Ô∏è Sin ventas - Vendedor nuevo o sin actividad';
                } else if (totalVentas < 100000) {
                    tooltipText += ' ‚ö†Ô∏è Ventas bajas - Considerar capacitaci√≥n o reasignaci√≥n de zona';
                } else if (totalVentas < 500000) {
                    tooltipText += ' üìä Ventas moderadas - Rendimiento est√°ndar';
                } else if (totalVentas < 2000000) {
                    tooltipText += ' ‚úÖ Ventas altas - Buen rendimiento';
                } else {
                    tooltipText += ' üèÜ Ventas excepcionales - Top performer';
                }
                break;
                
            default:
                return;
        }
        
        if (tooltipText) {
            args.cell.setAttribute('title', tooltipText);
            args.cell.style.cursor = 'help';
        }
    };
</script>
