@* Modal unificado Ver/Editar Producto usando Syncfusion Dialog *@
<ejs-tooltip id="tooltipModalProducto" 
             target=".info-tooltip-producto" 
             opensOn="Hover" 
             width="300px"
             position="TopCenter"
             beforeRender="tooltipModalProductoBeforeRender">
    <e-content-template>
        <div id="tooltipContentProducto"></div>
    </e-content-template>
</ejs-tooltip>

@* IMPORTANTE: El tag helper <ejs-dialog> renderiza un div con el id especificado cuando el Script Manager se ejecuta *@
<ejs-dialog id="modalProducto" 
            isModal="true" 
            showCloseIcon="true" 
            width="70%" 
            height="80%" 
            visible="false"
            header="Producto #<span id='modalProductoTitulo'>0</span>"
            created="modalProductoCreated"
            open="modalProductoOpen"
            close="modalProductoClose"
            beforeClose="modalProductoBeforeClose">
    <e-content-template>
        <div id="modalProductoContenido">
            <!-- Tabs para organizar el contenido -->
            <ejs-tab id="tabsModalProducto" heightAdjustMode="Auto">
                <e-tab-tabitems>
                    <e-tab-item header="@(new Syncfusion.EJ2.Navigations.TabHeader { Text = "Información General" })">
                        <e-content-template>
                            <div id="tabInfoModalProducto" class="mt-3">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">Información del Producto</h5>
                                            </div>
                                            <div class="card-body">
                                                <dl class="row">
                                                    <dt class="col-sm-5">ID Producto:</dt>
                                                    <dd class="col-sm-7">
                                                        <strong id="modalIdProducto" class="info-tooltip-producto" data-field="IdProducto" data-tooltip="Identificador único del producto en el sistema">-</strong>
                                                    </dd>

                                                    <dt class="col-sm-5">Nombre:</dt>
                                                    <dd class="col-sm-7">
                                                        <span id="modalNombreProducto" class="info-tooltip-producto" data-field="NombreProducto" data-tooltip="Nombre comercial del producto">-</span>
                                                    </dd>

                                                    <dt class="col-sm-5">Categoría:</dt>
                                                    <dd class="col-sm-7">
                                                        <ejs-chiplist id="chipCategoria" selection="Single" cssClass="e-outline"></ejs-chiplist>
                                                    </dd>
                                                    
                                                    <dt class="col-sm-5">Calidad del Producto:</dt>
                                                    <dd class="col-sm-7">
                                                        <ejs-rating id="ratingCalidad" value="0" precision="Half" showLabel="true" labelTemplate="<span>Calidad: ${value}/5</span>"></ejs-rating>
                                                    </dd>

                                                    <dt class="col-sm-5">Estado:</dt>
                                                    <dd class="col-sm-7" id="modalEstadoProducto">
                                                        <span class="info-tooltip-producto" data-field="Estado" data-tooltip="Estado del producto: ACTIVE (activo, disponible para venta), INACTIVE (inactivo, no disponible)">-</span>
                                                        <div id="gaugeEstado" style="height: 80px; margin-top: 5px;"></div>
                                                    </dd>

                                                    <dt class="col-sm-5">Código de Barras:</dt>
                                                    <dd class="col-sm-7">
                                                        <span id="modalCodigoBarras" class="info-tooltip-producto" data-field="CodigoBarras" data-tooltip="Código de barras único del producto para identificación">-</span>
                                                    </dd>
                                                </dl>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">Precios y Stock</h5>
                                            </div>
                                            <div class="card-body">
                                                <dl class="row">
                                                    <dt class="col-sm-5">Precio Unitario:</dt>
                                                    <dd class="col-sm-7">
                                                        <span id="modalPrecioUnitario" class="info-tooltip-producto fw-bold text-success fs-5" data-field="PrecioUnitario" data-tooltip="Precio de venta al público por unidad del producto">
                                                            <i class="fas fa-dollar-sign me-1"></i>$0.00
                                                        </span>
                                                    </dd>

                                                    <dt class="col-sm-5">Precio de Costo:</dt>
                                                    <dd class="col-sm-7">
                                                        <span id="modalPrecioCosto" class="info-tooltip-producto text-muted" data-field="PrecioCosto" data-tooltip="Costo de adquisición del producto para la empresa">
                                                            <i class="fas fa-coins me-1"></i>$0.00
                                                        </span>
                                                    </dd>

                                                    <dt class="col-sm-5">Margen de Ganancia:</dt>
                                                    <dd class="col-sm-7">
                                                        <span id="modalMargenGanancia" class="info-tooltip-producto fw-bold text-primary" data-field="MargenGanancia" data-tooltip="Diferencia entre precio de venta y costo (Precio Unitario - Precio de Costo)">
                                                            <i class="fas fa-chart-line me-1"></i>$0.00
                                                        </span>
                                                        <div id="sparklineMargen" style="height: 60px; margin-top: 5px;"></div>
                                                    </dd>

                                                    <dt class="col-sm-5">Cantidad en Stock:</dt>
                                                    <dd class="col-sm-7">
                                                        <div class="d-flex align-items-center gap-2">
                                                            <span id="modalCantidadStock" class="info-tooltip-producto fw-bold" data-field="CantidadStock" data-tooltip="Cantidad disponible en inventario. Stock bajo: menos de 20 unidades, Stock medio: 20-50 unidades, Stock alto: más de 50 unidades">
                                                                <i class="fas fa-boxes me-1"></i>0
                                                            </span>
                                                            <div id="gaugeStock" style="flex: 1; max-width: 200px; height: 60px;"></div>
                                                        </div>
                                                    </dd>
                                                </dl>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">Análisis de Precios</h5>
                                            </div>
                                            <div class="card-body">
                                                <div id="chartPrecios" style="height: 200px;"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">Descripción</h5>
                                            </div>
                                            <div class="card-body">
                                                <p id="modalDescripcion" class="mb-0">-</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </e-content-template>
                    </e-tab-item>
                </e-tab-tabitems>
            </ejs-tab>
        </div>
    </e-content-template>
    <e-dialog-buttons>
        <e-dialog-dialogbutton id="btnModalEditar" content="Editar" isPrimary="false" cssClass="e-flat" click="modalProductoEditar"></e-dialog-dialogbutton>
        <e-dialog-dialogbutton id="btnModalGuardar" content="Guardar" isPrimary="true" cssClass="e-flat d-none" click="modalProductoGuardar"></e-dialog-dialogbutton>
        <e-dialog-dialogbutton id="btnModalCancelar" content="Cancelar" isPrimary="false" cssClass="e-flat d-none" click="modalProductoCancelar"></e-dialog-dialogbutton>
        <e-dialog-dialogbutton id="btnModalCerrar" content="Cerrar" isPrimary="true" click="modalProductoCerrar"></e-dialog-dialogbutton>
    </e-dialog-buttons>
</ejs-dialog>

<script>
    // Variables globales para el modal de producto
    var modalProductoModo = 'ver'; // 'ver' o 'editar'
    var modalProductoId = null;
    var tooltipModalProductoObj = null;
    // IMPORTANTE: Variable global para la instancia del Dialog - debe ser accesible desde Products.js
    window.modalProductoInstance = null; // Instancia del Dialog de Syncfusion - se guarda en el evento 'created'
    
    // FUNCIONES HELPER SIMPLES para mostrar/ocultar el modal desde JavaScript
    // Uso: window.mostrarModalProducto() o window.ocultarModalProducto()
    window.mostrarModalProducto = function() {
        // Prioridad 1: Instancia guardada
        if (window.modalProductoInstance) {
            try {
                window.modalProductoInstance.show();
                return true;
            } catch (e) {
                console.warn('⚠️ Error al mostrar modal usando instancia guardada:', e);
            }
        }
        
        // Prioridad 2: Buscar en el DOM
        var elemento = document.getElementById('modalProducto');
        if (elemento) {
            // Intentar obtener de ej2_instances
            if (elemento.ej2_instances && elemento.ej2_instances[0]) {
                try {
                    elemento.ej2_instances[0].show();
                    window.modalProductoInstance = elemento.ej2_instances[0]; // Guardar para futuro uso
                    return true;
                } catch (e) {
                    console.warn('⚠️ Error al mostrar modal usando ej2_instances:', e);
                }
            }
            
            // Intentar obtener usando el método de Syncfusion
            try {
                if (typeof ej !== 'undefined' && ej.base && typeof ej.base.getComponent === 'function') {
                    var dialogInstance = ej.base.getComponent(elemento, 'dialog');
                    if (dialogInstance) {
                        dialogInstance.show();
                        window.modalProductoInstance = dialogInstance; // Guardar para futuro uso
                        return true;
                    }
                }
            } catch (e) {
                // Ignorar error
            }
        }
        
        console.warn('⚠️ Modal no disponible aún, intentando obtener instancia...');
        return false;
    };
    
    window.ocultarModalProducto = function() {
        var elemento = document.getElementById('modalProducto');
        if (elemento && elemento.ej2_instances && elemento.ej2_instances[0]) {
            elemento.ej2_instances[0].hide();
            return true;
        }
        if (window.modalProductoInstance) {
            window.modalProductoInstance.hide();
            return true;
        }
        return false;
    };

    // Evento created del Dialog - SOLUCIÓN DE RAÍZ según documentación oficial
    // Este evento se ejecuta cuando Syncfusion inicializa el componente después de <ejs-scripts>
    // Es el momento correcto para guardar la referencia a la instancia
    window.modalProductoCreated = function(args) {
        console.log('✅ Modal de producto creado e inicializado por Syncfusion');
        console.log('Args recibidos:', args);
        
        // Según documentación oficial de Syncfusion:
        // - args.component: instancia del componente Dialog
        // - args.element: elemento DOM del Dialog
        // El evento 'created' se dispara cuando el componente se crea e inserta en el DOM
        
        if (args && args.component) {
            // Método 1 (oficial): args.component contiene la instancia del Dialog
            window.modalProductoInstance = args.component;
            console.log('✅ Instancia del Dialog guardada correctamente (args.component)');
        } else if (args && args.element) {
            // Método 2 (oficial): args.element contiene el elemento DOM, obtener instancia de ej2_instances
            var dialogElement = args.element;
            if (dialogElement && dialogElement.ej2_instances && dialogElement.ej2_instances[0]) {
                window.modalProductoInstance = dialogElement.ej2_instances[0];
                console.log('⚠️ Instancia obtenida del elemento (args.element -> ej2_instances)');
            } else {
                // Intentar obtener usando el método oficial de Syncfusion
                try {
                    if (typeof ej !== 'undefined' && ej.base && typeof ej.base.getComponent === 'function') {
                        var dialogInstance = ej.base.getComponent(dialogElement, 'dialog');
                        if (dialogInstance) {
                            window.modalProductoInstance = dialogInstance;
                            console.log('⚠️ Instancia obtenida usando ej.base.getComponent (args.element)');
                        }
                    }
                } catch (e) {
                    console.warn('⚠️ Error al obtener instancia de args.element:', e);
                }
            }
        } else {
            // Fallback: intentar obtener del DOM directamente
            setTimeout(function() {
                var dialogElement = document.getElementById('modalProducto');
                if (dialogElement) {
                    // Intentar obtener de ej2_instances
                    if (dialogElement.ej2_instances && dialogElement.ej2_instances[0]) {
                        window.modalProductoInstance = dialogElement.ej2_instances[0];
                        console.log('⚠️ Instancia obtenida del DOM (fallback en created)');
                    } else {
                        // Intentar obtener usando el método oficial de Syncfusion
                        try {
                            if (typeof ej !== 'undefined' && ej.base && typeof ej.base.getComponent === 'function') {
                                var dialogInstance = ej.base.getComponent(dialogElement, 'dialog');
                                if (dialogInstance) {
                                    window.modalProductoInstance = dialogInstance;
                                    console.log('⚠️ Instancia obtenida usando ej.base.getComponent (fallback)');
                                }
                            }
                        } catch (e) {
                            // Ignorar error
                        }
                    }
                }
                
                if (!window.modalProductoInstance) {
                    console.warn('⚠️ Instancia aún no disponible, se intentará obtener cuando se abra el modal');
                }
            }, 100);
        }
        
        // Inicializar tooltip después de que el modal esté creado
        setTimeout(function() {
            var tooltipElement = document.getElementById('tooltipModalProducto');
            if (tooltipElement && tooltipElement.ej2_instances && tooltipElement.ej2_instances[0]) {
                tooltipModalProductoObj = tooltipElement.ej2_instances[0];
            }
        }, 100);
    };

    // Función para inicializar el modal de forma agresiva
    function inicializarModalProducto() {
        var dialogElement = document.getElementById('modalProducto');
        if (!dialogElement) {
            return false;
        }
        
        // Intentar obtener la instancia de múltiples formas
        var instancia = null;
        
        // Método 1: ej2_instances
        if (dialogElement.ej2_instances && dialogElement.ej2_instances[0]) {
            instancia = dialogElement.ej2_instances[0];
        }
        
        // Método 2: ej.base.getComponent
        if (!instancia && typeof ej !== 'undefined' && ej.base && typeof ej.base.getComponent === 'function') {
            try {
                instancia = ej.base.getComponent(dialogElement, 'dialog');
            } catch (e) {
                // Ignorar error
            }
        }
        
        // Método 3: Buscar en el objeto del elemento
        if (!instancia && dialogElement.ej2_instances && dialogElement.ej2_instances.length > 0) {
            for (var i = 0; i < dialogElement.ej2_instances.length; i++) {
                if (dialogElement.ej2_instances[i] && typeof dialogElement.ej2_instances[i].show === 'function') {
                    instancia = dialogElement.ej2_instances[i];
                    break;
                }
            }
        }
        
        if (instancia) {
            window.modalProductoInstance = instancia;
            console.log('✅ Instancia del modal obtenida e inicializada');
            return true;
        }
        
        return false;
    }
    
    // Inicializar tooltip cuando el DOM esté listo (fallback)
    // También verificar si el modal ya está inicializado después de que Syncfusion procese los componentes
    document.addEventListener("DOMContentLoaded", function() {
        var tooltipElement = document.getElementById('tooltipModalProducto');
        if (tooltipElement && tooltipElement.ej2_instances && tooltipElement.ej2_instances[0]) {
            tooltipModalProductoObj = tooltipElement.ej2_instances[0];
        }
        
        // Intentar inicializar el modal múltiples veces con diferentes delays
        var intentos = [500, 1000, 2000, 3000];
        intentos.forEach(function(delay) {
            setTimeout(function() {
                if (!window.modalProductoInstance) {
                    if (inicializarModalProducto()) {
                        console.log('✅ Modal inicializado después de ' + delay + 'ms');
                    }
                }
            }, delay);
        });
    });
    
    // También intentar después de que la ventana se cargue completamente
    window.addEventListener('load', function() {
        setTimeout(function() {
            if (!window.modalProductoInstance) {
                if (inicializarModalProducto()) {
                    console.log('✅ Modal inicializado después de window.load');
                }
            }
        }, 500);
    });

    // Evento beforeRender del tooltip
    window.tooltipModalProductoBeforeRender = function(args) {
        var target = args.target;
        var tooltipText = target.getAttribute('data-tooltip');
        var field = target.getAttribute('data-field');
        
        if (tooltipText) {
            var contentDiv = document.createElement('div');
            contentDiv.style.padding = '8px';
            contentDiv.style.fontSize = '13px';
            contentDiv.style.lineHeight = '1.5';
            
            var fieldName = document.createElement('strong');
            fieldName.textContent = field + ': ';
            fieldName.style.display = 'block';
            fieldName.style.marginBottom = '4px';
            fieldName.style.color = '#007bff';
            
            var description = document.createElement('span');
            description.textContent = tooltipText;
            
            contentDiv.appendChild(fieldName);
            contentDiv.appendChild(description);
            
            if (tooltipModalProductoObj) {
                tooltipModalProductoObj.content = contentDiv;
            }
        }
    };

    // Eventos del modal
    window.modalProductoOpen = function(args) {
        console.log('Modal de producto abierto');
    };

    window.modalProductoClose = function(args) {
        console.log('Modal de producto cerrado');
        modalProductoId = null;
        modalProductoModo = 'ver';
    };

    window.modalProductoBeforeClose = function(args) {
        return true;
    };

    // Botones del modal
    window.modalProductoEditar = function() {
        if (modalProductoId) {
            modalProductoModo = 'editar';
            if (window.Products && window.Products.Modal) {
                window.Products.Modal.CambiarAModoEdicion(modalProductoId);
            }
        }
    };

    window.modalProductoGuardar = function() {
        if (window.Products && window.Products.Modal) {
            window.Products.Modal.GuardarCambios();
        }
    };

    window.modalProductoCancelar = function() {
        if (window.Products && window.Products.Modal) {
            window.Products.Modal.CancelarEdicion();
        }
    };

    window.modalProductoCerrar = function() {
        // Si está en modo edición, cancelar primero
        if (modalProductoModo === 'editar') {
            if (window.Products && window.Products.Modal) {
                window.Products.Modal.CancelarEdicion();
            }
        }
        
        if (typeof window.ocultarModalProducto === 'function') {
            window.ocultarModalProducto();
        } else {
            var dialogElement = document.getElementById('modalProducto');
            if (dialogElement && dialogElement.ej2_instances && dialogElement.ej2_instances[0]) {
                dialogElement.ej2_instances[0].hide();
            } else if (window.modalProductoInstance) {
                window.modalProductoInstance.hide();
            }
        }
    };
</script>
