-- ============================================================================
-- Script: Crear Nuevas Tablas para Módulos Adicionales
-- Descripción: Crea las tablas necesarias para Chains, Salespersons, Routes,
--              Addendums, OrderChannels e Invoices
-- Schema: CO (Customer Orders)
-- Usuario: FLOTILLAS_APP
-- ============================================================================

-- Conectar como usuario FLOTILLAS_APP o con permisos suficientes
-- ALTER SESSION SET CURRENT_SCHEMA = CO;

-- ============================================================================
-- 1. TABLA: CHAINS (Cadenas Comerciales)
-- ============================================================================
CREATE TABLE CO.CHAINS (
    CHAIN_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CHAIN_NAME VARCHAR2(200) NOT NULL,
    BUSINESS_NAME VARCHAR2(200),
    RFC VARCHAR2(20),
    NUMBER_OF_STORES NUMBER DEFAULT 0,
    CREDIT_LIMIT NUMBER(15,2) DEFAULT 0,
    CREDIT_DAYS NUMBER DEFAULT 30,
    STATUS VARCHAR2(20) DEFAULT 'ACTIVE' CHECK (STATUS IN ('ACTIVE', 'INACTIVE', 'SUSPENDED')),
    REGISTRATION_DATE DATE DEFAULT SYSDATE,
    CONTACT_EMAIL VARCHAR2(100),
    CONTACT_PHONE VARCHAR2(20),
    ADDRESS VARCHAR2(200),
    CITY VARCHAR2(100),
    STATE VARCHAR2(100),
    POSTAL_CODE VARCHAR2(20),
    COUNTRY VARCHAR2(100) DEFAULT 'México',
    TOTAL_ORDERS NUMBER DEFAULT 0,
    TOTAL_SALES NUMBER(15,2) DEFAULT 0,
    CREATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IDX_CHAINS_STATUS ON CO.CHAINS(STATUS);
CREATE INDEX IDX_CHAINS_RFC ON CO.CHAINS(RFC);
CREATE INDEX IDX_CHAINS_CITY ON CO.CHAINS(CITY);

COMMENT ON TABLE CO.CHAINS IS 'Cadenas comerciales (clientes grandes)';
COMMENT ON COLUMN CO.CHAINS.CHAIN_ID IS 'Identificador único de la cadena';
COMMENT ON COLUMN CO.CHAINS.CHAIN_NAME IS 'Nombre comercial de la cadena';
COMMENT ON COLUMN CO.CHAINS.BUSINESS_NAME IS 'Razón social legal';
COMMENT ON COLUMN CO.CHAINS.RFC IS 'Registro Federal de Contribuyentes';
COMMENT ON COLUMN CO.CHAINS.STATUS IS 'Estado: ACTIVE, INACTIVE, SUSPENDED';

-- ============================================================================
-- 2. TABLA: SALESPERSONS (Vendedores/Intermediarios)
-- ============================================================================
CREATE TABLE CO.SALESPERSONS (
    SALESPERSON_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    FULL_NAME VARCHAR2(200) NOT NULL,
    EMAIL VARCHAR2(100),
    PHONE VARCHAR2(20),
    COVERAGE_ZONE VARCHAR2(100),
    BASE_COMMISSION NUMBER(5,2) DEFAULT 0,
    VARIABLE_COMMISSION NUMBER(5,2) DEFAULT 0,
    STATUS VARCHAR2(20) DEFAULT 'ACTIVE' CHECK (STATUS IN ('ACTIVE', 'INACTIVE', 'ON_LEAVE')),
    HIRE_DATE DATE DEFAULT SYSDATE,
    TOTAL_ORDERS NUMBER DEFAULT 0,
    TOTAL_SALES NUMBER(15,2) DEFAULT 0,
    TOTAL_COMMISSIONS NUMBER(15,2) DEFAULT 0,
    ASSIGNED_CHAINS NUMBER DEFAULT 0,
    CREATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IDX_SALESPERSONS_STATUS ON CO.SALESPERSONS(STATUS);
CREATE INDEX IDX_SALESPERSONS_ZONE ON CO.SALESPERSONS(COVERAGE_ZONE);
CREATE INDEX IDX_SALESPERSONS_EMAIL ON CO.SALESPERSONS(EMAIL);

COMMENT ON TABLE CO.SALESPERSONS IS 'Vendedores e intermediarios';
COMMENT ON COLUMN CO.SALESPERSONS.SALESPERSON_ID IS 'Identificador único del vendedor';
COMMENT ON COLUMN CO.SALESPERSONS.COVERAGE_ZONE IS 'Zona de cobertura geográfica';
COMMENT ON COLUMN CO.SALESPERSONS.BASE_COMMISSION IS 'Comisión base (%)';
COMMENT ON COLUMN CO.SALESPERSONS.VARIABLE_COMMISSION IS 'Comisión variable (%)';

-- ============================================================================
-- 3. TABLA: ROUTES (Rutas de Reparto)
-- ============================================================================
CREATE TABLE CO.ROUTES (
    ROUTE_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ROUTE_NAME VARCHAR2(200) NOT NULL,
    DESCRIPTION VARCHAR2(500),
    GEOGRAPHIC_ZONE VARCHAR2(100),
    ESTIMATED_TIME NUMBER DEFAULT 0, -- minutos
    MAX_CAPACITY NUMBER DEFAULT 0,
    STATUS VARCHAR2(20) DEFAULT 'ACTIVE' CHECK (STATUS IN ('ACTIVE', 'INACTIVE', 'MAINTENANCE')),
    ASSIGNED_DRIVER VARCHAR2(200),
    ASSIGNED_DRIVER_ID NUMBER,
    CREATION_DATE DATE DEFAULT SYSDATE,
    TOTAL_DELIVERIES NUMBER DEFAULT 0,
    AVERAGE_DELIVERY_TIME NUMBER(10,2) DEFAULT 0, -- minutos
    EFFICIENCY NUMBER(5,2) DEFAULT 0, -- porcentaje
    CREATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IDX_ROUTES_STATUS ON CO.ROUTES(STATUS);
CREATE INDEX IDX_ROUTES_ZONE ON CO.ROUTES(GEOGRAPHIC_ZONE);
CREATE INDEX IDX_ROUTES_DRIVER ON CO.ROUTES(ASSIGNED_DRIVER_ID);

COMMENT ON TABLE CO.ROUTES IS 'Rutas de reparto y entrega';
COMMENT ON COLUMN CO.ROUTES.ROUTE_ID IS 'Identificador único de la ruta';
COMMENT ON COLUMN CO.ROUTES.ESTIMATED_TIME IS 'Tiempo estimado en minutos';
COMMENT ON COLUMN CO.ROUTES.MAX_CAPACITY IS 'Capacidad máxima de entregas';
COMMENT ON COLUMN CO.ROUTES.EFFICIENCY IS 'Eficiencia de la ruta (%)';

-- ============================================================================
-- 4. TABLA: ADDENDUMS (Adendas/Contratos Especiales)
-- ============================================================================
CREATE TABLE CO.ADDENDUMS (
    ADDENDUM_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CHAIN_ID NUMBER NOT NULL,
    ADDENDUM_NAME VARCHAR2(200) NOT NULL,
    SPECIAL_DISCOUNT NUMBER(5,2) DEFAULT 0, -- porcentaje
    CREDIT_DAYS NUMBER DEFAULT 30,
    START_DATE DATE NOT NULL,
    END_DATE DATE NOT NULL,
    STATUS VARCHAR2(20) DEFAULT 'ACTIVE' CHECK (STATUS IN ('ACTIVE', 'EXPIRED', 'CANCELLED')),
    SPECIAL_CONDITIONS VARCHAR2(1000),
    CREATION_DATE DATE DEFAULT SYSDATE,
    LAST_RENEWAL_DATE DATE,
    AUTO_RENEWAL CHAR(1) DEFAULT 'N' CHECK (AUTO_RENEWAL IN ('Y', 'N')),
    MINIMUM_ORDER_AMOUNT NUMBER(15,2) DEFAULT 0,
    CREATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT FK_ADDENDUM_CHAIN FOREIGN KEY (CHAIN_ID) REFERENCES CO.CHAINS(CHAIN_ID)
);

CREATE INDEX IDX_ADDENDUMS_CHAIN ON CO.ADDENDUMS(CHAIN_ID);
CREATE INDEX IDX_ADDENDUMS_STATUS ON CO.ADDENDUMS(STATUS);
CREATE INDEX IDX_ADDENDUMS_DATES ON CO.ADDENDUMS(START_DATE, END_DATE);

COMMENT ON TABLE CO.ADDENDUMS IS 'Adendas y contratos especiales para clientes grandes';
COMMENT ON COLUMN CO.ADDENDUMS.SPECIAL_DISCOUNT IS 'Descuento especial (%)';
COMMENT ON COLUMN CO.ADDENDUMS.AUTO_RENEWAL IS 'Renovación automática: Y/N';

-- ============================================================================
-- 5. TABLA: ORDER_CHANNELS (Canales de Pedidos)
-- ============================================================================
CREATE TABLE CO.ORDER_CHANNELS (
    CHANNEL_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CHANNEL_NAME VARCHAR2(200) NOT NULL,
    CHANNEL_TYPE VARCHAR2(50) CHECK (CHANNEL_TYPE IN ('MOBILE', 'CALL_CENTER', 'EMAIL', 'WEB')),
    DESCRIPTION VARCHAR2(500),
    STATUS VARCHAR2(20) DEFAULT 'ACTIVE' CHECK (STATUS IN ('ACTIVE', 'INACTIVE', 'MAINTENANCE')),
    TOTAL_ORDERS NUMBER DEFAULT 0,
    CONVERSION_RATE NUMBER(5,2) DEFAULT 0, -- porcentaje
    AVERAGE_ORDER_VALUE NUMBER(15,2) DEFAULT 0,
    CREATION_DATE DATE DEFAULT SYSDATE,
    LAST_ORDER_DATE DATE,
    ORDERS_TODAY NUMBER DEFAULT 0,
    ORDERS_THIS_MONTH NUMBER DEFAULT 0,
    EFFICIENCY NUMBER(5,2) DEFAULT 0, -- porcentaje
    CREATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IDX_ORDER_CHANNELS_TYPE ON CO.ORDER_CHANNELS(CHANNEL_TYPE);
CREATE INDEX IDX_ORDER_CHANNELS_STATUS ON CO.ORDER_CHANNELS(STATUS);

COMMENT ON TABLE CO.ORDER_CHANNELS IS 'Canales de recepción de pedidos';
COMMENT ON COLUMN CO.ORDER_CHANNELS.CHANNEL_TYPE IS 'Tipo: MOBILE, CALL_CENTER, EMAIL, WEB';
COMMENT ON COLUMN CO.ORDER_CHANNELS.CONVERSION_RATE IS 'Tasa de conversión (%)';

-- ============================================================================
-- 6. TABLA: INVOICES (Facturas CFDI)
-- ============================================================================
CREATE TABLE CO.INVOICES (
    INVOICE_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ORDER_ID NUMBER NOT NULL,
    FOLIO VARCHAR2(50),
    UUID VARCHAR2(100), -- UUID del CFDI
    ISSUER_RFC VARCHAR2(20),
    RECEIVER_RFC VARCHAR2(20),
    ISSUE_DATE DATE DEFAULT SYSDATE,
    SUBTOTAL NUMBER(15,2) DEFAULT 0,
    TAX NUMBER(15,2) DEFAULT 0, -- IVA
    TOTAL NUMBER(15,2) DEFAULT 0,
    STATUS VARCHAR2(20) DEFAULT 'DRAFT' CHECK (STATUS IN ('DRAFT', 'STAMPED', 'CANCELLED', 'PAID')),
    PAYMENT_METHOD VARCHAR2(10) DEFAULT 'PUE' CHECK (PAYMENT_METHOD IN ('PUE', 'PPD')),
    PAYMENT_FORM VARCHAR2(10) DEFAULT '03', -- 03 = Transferencia electrónica
    CURRENCY VARCHAR2(10) DEFAULT 'MXN',
    CANCELLATION_DATE DATE,
    CANCELLATION_REASON VARCHAR2(500),
    XML_PATH VARCHAR2(500),
    PDF_PATH VARCHAR2(500),
    CREATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT FK_INVOICE_ORDER FOREIGN KEY (ORDER_ID) REFERENCES CO.ORDERS(ORDER_ID)
);

CREATE INDEX IDX_INVOICES_ORDER ON CO.INVOICES(ORDER_ID);
CREATE INDEX IDX_INVOICES_STATUS ON CO.INVOICES(STATUS);
CREATE INDEX IDX_INVOICES_UUID ON CO.INVOICES(UUID);
CREATE INDEX IDX_INVOICES_FOLIO ON CO.INVOICES(FOLIO);
CREATE INDEX IDX_INVOICES_DATE ON CO.INVOICES(ISSUE_DATE);

COMMENT ON TABLE CO.INVOICES IS 'Facturas CFDI (Facturación Electrónica)';
COMMENT ON COLUMN CO.INVOICES.UUID IS 'UUID del CFDI';
COMMENT ON COLUMN CO.INVOICES.PAYMENT_METHOD IS 'PUE = Pago en una exhibición, PPD = Pago en parcialidades';
COMMENT ON COLUMN CO.INVOICES.STATUS IS 'Estado: DRAFT, STAMPED, CANCELLED, PAID';

-- ============================================================================
-- 7. TABLA DE RELACIÓN: CHAIN_SALESPERSON (Asignación de Vendedores a Cadenas)
-- ============================================================================
CREATE TABLE CO.CHAIN_SALESPERSON (
    CHAIN_ID NUMBER NOT NULL,
    SALESPERSON_ID NUMBER NOT NULL,
    ASSIGNED_DATE DATE DEFAULT SYSDATE,
    IS_PRIMARY CHAR(1) DEFAULT 'N' CHECK (IS_PRIMARY IN ('Y', 'N')),
    CREATED_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT PK_CHAIN_SALESPERSON PRIMARY KEY (CHAIN_ID, SALESPERSON_ID),
    CONSTRAINT FK_CS_CHAIN FOREIGN KEY (CHAIN_ID) REFERENCES CO.CHAINS(CHAIN_ID),
    CONSTRAINT FK_CS_SALESPERSON FOREIGN KEY (SALESPERSON_ID) REFERENCES CO.SALESPERSONS(SALESPERSON_ID)
);

CREATE INDEX IDX_CS_CHAIN ON CO.CHAIN_SALESPERSON(CHAIN_ID);
CREATE INDEX IDX_CS_SALESPERSON ON CO.CHAIN_SALESPERSON(SALESPERSON_ID);

COMMENT ON TABLE CO.CHAIN_SALESPERSON IS 'Relación muchos a muchos entre Cadenas y Vendedores';

-- ============================================================================
-- 8. TRIGGERS PARA ACTUALIZAR UPDATED_DATE
-- ============================================================================
CREATE OR REPLACE TRIGGER TRG_CHAINS_UPDATE
    BEFORE UPDATE ON CO.CHAINS
    FOR EACH ROW
BEGIN
    :NEW.UPDATED_DATE := CURRENT_TIMESTAMP;
END;
/

CREATE OR REPLACE TRIGGER TRG_SALESPERSONS_UPDATE
    BEFORE UPDATE ON CO.SALESPERSONS
    FOR EACH ROW
BEGIN
    :NEW.UPDATED_DATE := CURRENT_TIMESTAMP;
END;
/

CREATE OR REPLACE TRIGGER TRG_ROUTES_UPDATE
    BEFORE UPDATE ON CO.ROUTES
    FOR EACH ROW
BEGIN
    :NEW.UPDATED_DATE := CURRENT_TIMESTAMP;
END;
/

CREATE OR REPLACE TRIGGER TRG_ADDENDUMS_UPDATE
    BEFORE UPDATE ON CO.ADDENDUMS
    FOR EACH ROW
BEGIN
    :NEW.UPDATED_DATE := CURRENT_TIMESTAMP;
END;
/

CREATE OR REPLACE TRIGGER TRG_ORDER_CHANNELS_UPDATE
    BEFORE UPDATE ON CO.ORDER_CHANNELS
    FOR EACH ROW
BEGIN
    :NEW.UPDATED_DATE := CURRENT_TIMESTAMP;
END;
/

CREATE OR REPLACE TRIGGER TRG_INVOICES_UPDATE
    BEFORE UPDATE ON CO.INVOICES
    FOR EACH ROW
BEGIN
    :NEW.UPDATED_DATE := CURRENT_TIMESTAMP;
END;
/

-- ============================================================================
-- FIN DEL SCRIPT
-- ============================================================================
-- Verificar que las tablas se crearon correctamente:
-- SELECT table_name FROM user_tables WHERE table_name IN ('CHAINS', 'SALESPERSONS', 'ROUTES', 'ADDENDUMS', 'ORDER_CHANNELS', 'INVOICES', 'CHAIN_SALESPERSON');
-- ============================================================================
